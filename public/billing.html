<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Billing & Subscription - MathsMayhem</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            margin: 0;
            padding: 20px 0;
        }
        
        .billing-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .back-btn {
            display: inline-block;
            background: rgba(255,255,255,0.9);
            color: #4a90e2;
            padding: 12px 25px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .billing-sections {
            display: grid;
            gap: 30px;
        }
        
        .section-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #4a90e2;
            margin-bottom: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .current-plan {
            background: linear-gradient(145deg, #e6f3ff, #cce7ff);
            border: 2px solid #4a90e2;
        }
        
        .plan-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(74,144,226,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .plan-details h3 {
            color: #4a90e2;
            margin: 0 0 5px 0;
            font-size: 1.5rem;
        }
        
        .plan-details p {
            color: #666;
            margin: 0;
            font-size: 1rem;
        }
        
        .plan-price {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .plan-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4a90e2, #667eea);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #667eea, #4a90e2);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(90deg, #ee5a5a, #ff6b6b);
        }
        
        .payment-form {
            display: grid;
            gap: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: bold;
            color: #4a90e2;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74,144,226,0.1);
        }
        
        .card-icons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .card-icon {
            width: 40px;
            height: 25px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .visa { background: #1a1f71; color: white; }
        .mastercard { background: #eb001b; color: white; }
        .amex { background: #006fcf; color: white; }
        
        .billing-history {
            overflow-x: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status.paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .security-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .security-info h4 {
            color: #28a745;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .demo-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .demo-notice h3 {
            color: #856404;
            margin: 0 0 10px 0;
        }
        
        .demo-notice p {
            color: #856404;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .plan-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .plan-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .plan-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="billing-container">
        <a href="subscription.html" class="back-btn">‚¨ÖÔ∏è Back to Subscriptions</a>
        
        <div class="header">
            <h1>üí≥ Billing & Subscription Management</h1>
            <p>Manage your subscription and payment details</p>
        </div>
        
        <div class="demo-notice">
            <h3>üöß Demo Mode</h3>
            <p>This is a demonstration. No real payments will be processed. In a live system, this would integrate with payment providers like Stripe or PayPal.</p>
        </div>
        
        <!-- Selected Plan Checkout (shows when coming from subscription page) -->
        <div class="section-card" id="checkout-section" style="display: none;">
            <div class="section-title">
                <span>üõí</span>
                Complete Your Subscription
            </div>
            
            <div class="plan-info">
                <div class="plan-details">
                    <h3 id="checkout-plan-name">Premium Plan</h3>
                    <p id="checkout-plan-description">Unlock all premium features</p>
                </div>
                <div class="plan-price" id="checkout-plan-price">¬£1.50/month</div>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="completeSubscription()" id="complete-subscription-btn">
                    üí≥ Complete Subscription
                </button>
                <button class="btn btn-secondary" onclick="cancelCheckout()">
                    ‚ùå Cancel
                </button>
            </div>
        </div>
        
        <div class="billing-sections">
            <!-- Current Subscription -->
            <div class="section-card current-plan">
                <div class="section-title">
                    <span>üìã</span>
                    Current Subscription
                </div>
                
                <div class="plan-info">
                    <div class="plan-details">
                        <h3 id="current-plan-name">Free Explorer</h3>
                        <p id="current-plan-description">Basic features with 5 quizzes per day</p>
                        <p><strong>Next billing:</strong> <span id="next-billing">N/A</span></p>
                    </div>
                    <div class="plan-price" id="current-plan-price">¬£0</div>
                </div>
                
                <div class="plan-actions">
                    <a href="subscription.html" class="btn btn-primary">üîÑ Change Plan</a>
                    <button class="btn btn-secondary" onclick="managePlan()">‚öôÔ∏è Manage</button>
                    <button class="btn btn-danger" onclick="cancelPlan()" id="cancel-btn" style="display: none;">‚ùå Cancel</button>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="section-card">
                <div class="section-title">
                    <span>üí≥</span>
                    Payment Method
                </div>
                
                <div id="no-payment" style="display: none;">
                    <p style="color: #666; margin-bottom: 20px;">No payment method on file. Add one to upgrade to premium plans.</p>
                </div>
                
                <div id="current-payment" style="display: none;">
                    <div class="plan-info">
                        <div class="plan-details">
                            <h3 id="card-info">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</h3>
                            <p id="card-details">Visa ‚Ä¢ Expires 12/26</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="editPayment()">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="removePayment()">üóëÔ∏è Remove</button>
                        </div>
                    </div>
                </div>
                
                <div id="payment-form" class="payment-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-name">Cardholder Name</label>
                            <input type="text" id="card-name" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="card-number">Card Number</label>
                            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
                            <div class="card-icons">
                                <div class="card-icon visa">VISA</div>
                                <div class="card-icon mastercard">MC</div>
                                <div class="card-icon amex">AMEX</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry">Expiry Date</label>
                            <input type="text" id="expiry" placeholder="MM/YY" maxlength="5" required>
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" placeholder="123" maxlength="4" required>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="billing-address">Billing Address</label>
                        <input type="text" id="billing-address" placeholder="123 Main Street, London, UK" required>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="cancelPaymentForm()">Cancel</button>
                        <button class="btn btn-primary" onclick="savePaymentMethod()">üíæ Save Payment Method</button>
                    </div>
                </div>
                
                <div class="security-info">
                    <h4>üîí Your payment is secure</h4>
                    <p>We use industry-standard encryption to protect your payment information. Your card details are never stored on our servers.</p>
                </div>
            </div>
            
            <!-- Billing History -->
            <div class="section-card">
                <div class="section-title">
                    <span>üìä</span>
                    Billing History
                </div>
                
                <div class="billing-history">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Invoice</th>
                            </tr>
                        </thead>
                        <tbody id="billing-history-body">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #666; padding: 30px;">
                                    No billing history available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="user-manager.js"></script>
    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            
            if (!currentUser) {
                alert('Please log in to access billing information.');
                window.location.href = 'login.html';
                return;
            }
            
            // Check if coming from subscription selection
            const selectedPlan = localStorage.getItem('selectedPlan');
            if (selectedPlan) {
                showCheckoutSection(selectedPlan);
            }
            
            loadBillingInfo();
        });
        
        function loadBillingInfo() {
            const currentPlan = localStorage.getItem('subscriptionPlan') || 'free';
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            
            // Update current plan display
            updateCurrentPlan(currentPlan);
            
            // Update payment method display
            updatePaymentDisplay(hasPayment);
            
            // Load billing history
            loadBillingHistory(currentPlan);
        }
        
        function showCheckoutSection(planType) {
            const checkoutSection = document.getElementById('checkout-section');
            const planNames = {
                'premium': 'Math Champion',
                'family': 'Family Pack', 
                'tutor': 'Pro Tutor',
                'genius': 'Math Genius'
            };
            
            const planPrices = {
                'premium': '¬£1.50/month',
                'family': '¬£3.50/month',
                'tutor': '¬£5.99/month', 
                'genius': '¬£9.99/month'
            };
            
            const planDescriptions = {
                'premium': 'Unlimited quizzes and detailed analytics',
                'family': 'Family management with up to 6 accounts',
                'tutor': 'AI-powered tutoring and personalized study plans',
                'genius': 'Advanced competitions and university-level content'
            };
            
            document.getElementById('checkout-plan-name').textContent = planNames[planType];
            document.getElementById('checkout-plan-price').textContent = planPrices[planType];
            document.getElementById('checkout-plan-description').textContent = planDescriptions[planType];
            
            checkoutSection.style.display = 'block';
            
            // Check if payment method exists
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            const completeBtn = document.getElementById('complete-subscription-btn');
            
            if (!hasPayment) {
                completeBtn.textContent = 'üí≥ Add Payment & Subscribe';
                completeBtn.onclick = function() {
                    alert('Please add a payment method first to complete your subscription.');
                    document.getElementById('payment-form').scrollIntoView({ behavior: 'smooth' });
                };
            } else {
                completeBtn.textContent = '‚úÖ Complete Subscription';
                completeBtn.onclick = completeSubscription;
            }
        }
        
        function completeSubscription() {
            const selectedPlan = localStorage.getItem('selectedPlan');
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            
            if (!hasPayment) {
                alert('Please add a payment method first.');
                return;
            }
            
            // Simulate payment processing
            const processingMsg = document.createElement('div');
            processingMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
                font-family: inherit;
            `;
            processingMsg.innerHTML = `
                <h3 style="color: #4a90e2; margin: 0 0 15px 0;">Processing Payment...</h3>
                <div style="font-size: 2rem;">‚è≥</div>
                <p style="margin: 15px 0 0 0; color: #666;">Please wait while we process your subscription.</p>
            `;
            document.body.appendChild(processingMsg);
            
            // Simulate processing delay
            setTimeout(() => {
                document.body.removeChild(processingMsg);
                
                // Complete the subscription
                localStorage.setItem('subscriptionPlan', selectedPlan);
                localStorage.removeItem('selectedPlan');
                
                // Success message
                const planNames = {
                    'premium': 'Math Champion',
                    'family': 'Family Pack', 
                    'tutor': 'Pro Tutor',
                    'genius': 'Math Genius'
                };
                
                alert(`üéâ Subscription Successful!\n\nWelcome to ${planNames[selectedPlan]}!\n\nYour premium features are now active. Enjoy unlimited access to MathsMayhem!`);
                
                // Redirect to main app
                window.location.href = 'index.html';
            }, 2000);
        }
        
        function cancelCheckout() {
            localStorage.removeItem('selectedPlan');
            document.getElementById('checkout-section').style.display = 'none';
        }
        
        function updateCurrentPlan(planType) {
            const planNames = {
                'free': 'Free Explorer',
                'premium': 'Math Champion',
                'family': 'Family Pack', 
                'tutor': 'Pro Tutor',
                'genius': 'Math Genius',
                'school': 'Schools & Education'
            };
            
            const planPrices = {
                'free': '¬£0',
                'premium': '¬£1.50/month',
                'family': '¬£3.50/month',
                'tutor': '¬£5.99/month', 
                'genius': '¬£9.99/month',
                'school': '¬£12.50/month'
            };
            
            const planDescriptions = {
                'free': 'Basic features with 5 quizzes per day',
                'premium': 'Unlimited quizzes and detailed analytics',
                'family': 'Family management with up to 6 accounts',
                'tutor': 'AI-powered tutoring and personalized study plans',
                'genius': 'Advanced competitions and university-level content',
                'school': 'Complete classroom management solution'
            };
            
            document.getElementById('current-plan-name').textContent = planNames[planType];
            document.getElementById('current-plan-price').textContent = planPrices[planType];
            document.getElementById('current-plan-description').textContent = planDescriptions[planType];
            
            if (planType !== 'free') {
                const nextBilling = new Date();
                nextBilling.setMonth(nextBilling.getMonth() + 1);
                document.getElementById('next-billing').textContent = nextBilling.toLocaleDateString();
                document.getElementById('cancel-btn').style.display = 'inline-block';
            } else {
                document.getElementById('next-billing').textContent = 'N/A';
                document.getElementById('cancel-btn').style.display = 'none';
            }
        }
        
        function updatePaymentDisplay(hasPayment) {
            const noPayment = document.getElementById('no-payment');
            const currentPayment = document.getElementById('current-payment');
            const paymentForm = document.getElementById('payment-form');
            
            if (hasPayment) {
                noPayment.style.display = 'none';
                currentPayment.style.display = 'block';
                paymentForm.style.display = 'none';
            } else {
                noPayment.style.display = 'block';
                currentPayment.style.display = 'none';
                paymentForm.style.display = 'grid';
            }
        }
        
        function loadBillingHistory(planType) {
            if (planType === 'free') return;
            
            // Demo billing history
            const billingHistory = [
                {
                    date: '2025-01-10',
                    description: 'MathsMayhem Premium Subscription',
                    amount: '¬£1.50',
                    status: 'paid'
                },
                {
                    date: '2024-12-10', 
                    description: 'MathsMayhem Premium Subscription',
                    amount: '¬£1.50',
                    status: 'paid'
                }
            ];
            
            const tbody = document.getElementById('billing-history-body');
            tbody.innerHTML = '';
            
            billingHistory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(item.date).toLocaleDateString()}</td>
                    <td>${item.description}</td>
                    <td>${item.amount}</td>
                    <td><span class="status ${item.status}">${item.status}</span></td>
                    <td><a href="#" onclick="downloadInvoice('${item.date}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;">üìÑ Download</a></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function managePlan() {
            alert('Plan management options:\n\n‚Ä¢ Change plan tier\n‚Ä¢ Update billing frequency\n‚Ä¢ Pause subscription\n‚Ä¢ Download usage reports\n\nThis would open detailed plan management in a real application.');
        }
        
        function cancelPlan() {
            if (confirm('Are you sure you want to cancel your subscription?\n\nYou will lose access to premium features at the end of your billing cycle.')) {
                alert('Subscription cancelled. You will retain premium access until your next billing date.\n\nWe\'re sorry to see you go! üò¢');
                localStorage.setItem('subscriptionPlan', 'free');
                loadBillingInfo();
            }
        }
        
        function editPayment() {
            document.getElementById('current-payment').style.display = 'none';
            document.getElementById('payment-form').style.display = 'grid';
            
            // Pre-fill with current data (demo)
            document.getElementById('card-name').value = 'John Doe';
            document.getElementById('card-number').value = '4242 4242 4242 4242';
            document.getElementById('expiry').value = '12/26';
            document.getElementById('cvv').value = '123';
            document.getElementById('billing-address').value = '123 Main Street, London, UK';
        }
        
        function removePayment() {
            if (confirm('Remove payment method?\n\nThis will cancel any active subscriptions and downgrade you to the free plan.')) {
                localStorage.removeItem('hasPaymentMethod');
                localStorage.setItem('subscriptionPlan', 'free');
                alert('Payment method removed successfully.');
                loadBillingInfo();
            }
        }
        
        function cancelPaymentForm() {
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            updatePaymentDisplay(hasPayment);
            clearPaymentForm();
        }
        
        function savePaymentMethod() {
            const cardName = document.getElementById('card-name').value;
            const cardNumber = document.getElementById('card-number').value;
            const expiry = document.getElementById('expiry').value;
            const cvv = document.getElementById('cvv').value;
            const address = document.getElementById('billing-address').value;
            
            if (!cardName || !cardNumber || !expiry || !cvv || !address) {
                alert('Please fill in all payment details.');
                return;
            }
            
            // Basic validation
            if (cardNumber.replace(/\s/g, '').length < 13) {
                alert('Please enter a valid card number.');
                return;
            }
            
            if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                alert('Please enter expiry date in MM/YY format.');
                return;
            }
            
            if (cvv.length < 3) {
                alert('Please enter a valid CVV.');
                return;
            }
            
            // Demo success
            alert('‚úÖ Payment method saved successfully!\n\nYour card ending in ' + cardNumber.slice(-4) + ' has been added to your account.');
            
            localStorage.setItem('hasPaymentMethod', 'true');
            updatePaymentDisplay(true);
            clearPaymentForm();
        }
        
        function clearPaymentForm() {
            document.getElementById('card-name').value = '';
            document.getElementById('card-number').value = '';
            document.getElementById('expiry').value = '';
            document.getElementById('cvv').value = '';
            document.getElementById('billing-address').value = '';
        }
        
        function downloadInvoice(date) {
            alert('üìÑ Invoice download started!\n\nInvoice for ' + new Date(date).toLocaleDateString() + ' would be downloaded in a real application.');
        }
        
        // Format card number input
        document.getElementById('card-number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedInputValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedInputValue.length > 19) formattedInputValue = formattedInputValue.substr(0, 19);
            e.target.value = formattedInputValue;
        });
        
        // Format expiry date input
        document.getElementById('expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
        
        // CVV numbers only
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
