<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Billing & Subscription - MathsMayhem</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Comic Sans MS', cursive, sans-serif;
        margin: 0;
        padding: 20px 0;
        }
        
        .billing-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .back-btn {
            display: inline-block;
            background: rgba(255,255,255,0.9);
            color: #4a90e2;
            padding: 12px 25px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .billing-sections {
            display: grid;
            gap: 30px;
        }
        
        .section-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #4a90e2;
            margin-bottom: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .current-plan {
            background: linear-gradient(145deg, #e6f3ff, #cce7ff);
            border: 2px solid #4a90e2;
        }
        
        .plan-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(74,144,226,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .plan-details h3 {
            color: #4a90e2;
            margin: 0 0 5px 0;
            font-size: 1.5rem;
        }
        
        .plan-details p {
            color: #666;
            margin: 0;
            font-size: 1rem;
        }
        
        .plan-price {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .plan-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4a90e2, #667eea);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #667eea, #4a90e2);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(90deg, #ee5a5a, #ff6b6b);
        }
        
        .payment-form {
            display: grid;
            gap: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: bold;
            color: #4a90e2;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74,144,226,0.1);
        }
        
        .card-icons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .card-icon {
            width: 40px;
            height: 25px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            opacity: 0.3;
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        .visa { background: #1a1f71; color: white; }
        .mastercard { background: #eb001b; color: white; }
        .amex { background: #006fcf; color: white; }
        .discover { background: #ff6000; color: white; }
        .dinersclub { background: #0079be; color: white; }
        .jcb { background: #35a9db; color: white; }
        
        .billing-history {
            overflow-x: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status.paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .security-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .security-info h4 {
            color: #28a745;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .premium-notice {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .premium-notice h3 {
            color: #155724;
            margin: 0 0 10px 0;
        }
        
        .premium-notice p {
            color: #155724;
            margin: 0;
        }
        
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-card {
            animation: fadeIn 0.5s ease-out;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .form-group input:valid {
            border-color: #28a745;
        }
        
        .form-group input:invalid:not(:focus):not(:placeholder-shown) {
            border-color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .plan-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .plan-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .plan-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="billing-container">
        <a href="subscription.html" class="back-btn">‚¨ÖÔ∏è Back to Subscriptions</a>
        
        <div class="header">
            <h1>üí≥ Billing & Subscription Management</h1>
            <p>Manage your subscription and payment details</p>
        </div>
        
        <div class="premium-notice">
            <h3>ÔøΩ Secure Payment Processing</h3>
            <p>Your payment data is protected by bank-level encryption. We partner with leading payment processors to ensure your transactions are safe and secure.</p>
        </div>
        
        <!-- Selected Plan Checkout (shows when coming from subscription page) -->
        <div class="section-card" id="checkout-section" style="display: none;">
            <div class="section-title">
                <span>üõí</span>
                Complete Your Subscription
            </div>
            
            <div class="plan-info">
                <div class="plan-details">
                    <h3 id="checkout-plan-name">Premium Plan</h3>
                    <p id="checkout-plan-description">Unlock all premium features</p>
                </div>
                <div class="plan-price" id="checkout-plan-price">¬£1.50/month</div>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="completeSubscription()" id="complete-subscription-btn">
                    üí≥ Complete Subscription
                </button>
                <button class="btn btn-secondary" onclick="cancelCheckout()">
                    ‚ùå Cancel
                </button>
            </div>
        </div>
        
        <div class="billing-sections">
            <!-- Current Subscription -->
            <div class="section-card current-plan">
                <div class="section-title">
                    <span>üìã</span>
                    Current Subscription
                </div>
                
                <div class="plan-info">
                    <div class="plan-details">
                        <h3 id="current-plan-name">Free Explorer</h3>
                        <p id="current-plan-description">Basic features with 5 quizzes per day</p>
                        <p><strong>Next billing:</strong> <span id="next-billing">N/A</span></p>
                    </div>
                    <div class="plan-price" id="current-plan-price">¬£0</div>
                </div>
                
                <div class="plan-actions">
                    <a href="subscription.html" class="btn btn-primary">üîÑ Change Plan</a>
                    <button class="btn btn-secondary" onclick="managePlan()">‚öôÔ∏è Manage</button>
                    <button class="btn btn-danger" onclick="cancelPlan()" id="cancel-btn" style="display: none;">‚ùå Cancel</button>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="section-card" data-section="payment-method">
                <div class="section-title">
                    <span>üí≥</span>
                    Payment Method
                </div>
                
                <div id="no-payment" style="display: none;">
                    <p style="color: #666; margin-bottom: 20px;">No payment method on file. Add one to upgrade to premium plans.</p>
                </div>
                
                <div id="current-payment" style="display: none;">
                    <div class="plan-info">
                        <div class="plan-details">
                            <h3 id="card-info">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</h3>
                            <p id="card-details">Visa ‚Ä¢ Expires 12/26</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="editPayment()">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="removePayment()">üóëÔ∏è Remove</button>
                        </div>
                    </div>
                </div>
                
                <div id="payment-form" class="payment-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-name">Cardholder Name</label>
                            <input type="text" id="card-name" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="card-number">Card Number</label>
                            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
                            <div class="card-icons">
                                <div class="card-icon visa">VISA</div>
                                <div class="card-icon mastercard">MC</div>
                                <div class="card-icon amex">AMEX</div>
                                <div class="card-icon discover">DISC</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry">Expiry Date</label>
                            <input type="text" id="expiry" placeholder="MM/YY" maxlength="5" required>
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" placeholder="123" maxlength="4" required>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="discount-code">Discount Code (Optional)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="discount-code" placeholder="Enter discount code" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="applyDiscountCode()" style="white-space: nowrap;">Apply Code</button>
                        </div>
                        <div id="discount-feedback" style="margin-top: 5px; font-size: 0.9rem;"></div>
                        <div id="discount-applied" style="margin-top: 10px; padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; display: none;">
                            <strong>Discount Applied!</strong> <span id="discount-details"></span>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="billing-address">Billing Address</label>
                        <input type="text" id="billing-address" placeholder="123 Main Street, London, UK" required>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="cancelPaymentForm()">Cancel</button>
                        <button class="btn btn-primary" onclick="savePaymentMethod()">üíæ Save Payment Method</button>
                    </div>
                </div>
                
                <div class="security-info">
                    <h4>üîí Your payment is secure</h4>
                    <p>We use industry-standard encryption to protect your payment information. Your card details are never stored on our servers.</p>
                </div>
            </div>
            
            <!-- Billing History -->
            <div class="section-card">
                <div class="section-title">
                    <span>üìä</span>
                    Billing History
                </div>
                
                <div class="billing-history">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Invoice</th>
                            </tr>
                        </thead>
                        <tbody id="billing-history-body">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #666; padding: 30px;">
                                    No billing history available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="user-manager.js"></script>
    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            
            if (!currentUser) {
                alert('Please log in to access billing information.');
                window.location.href = 'login.html';
                return;
            }
            
            // Check if coming from subscription selection
            const selectedPlan = localStorage.getItem('selectedPlan');
            if (selectedPlan) {
                showCheckoutSection(selectedPlan);
            }
            
            // Check if TESTFREE discount was previously applied
            const discountApplied = localStorage.getItem('discountApplied');
            if (discountApplied === 'TESTFREE') {
                const discountCodeInput = document.getElementById('discount-code');
                if (discountCodeInput) {
                    discountCodeInput.value = 'TESTFREE';
                    setTimeout(() => applyDiscountCode(), 500); // Apply after UI loads
                }
            }
            
            loadBillingInfo();
        });
        
        function loadBillingInfo() {
            const currentPlan = localStorage.getItem('subscriptionPlan') || 'free';
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            
            // Update current plan display
            updateCurrentPlan(currentPlan);
            
            // Update payment method display
            updatePaymentDisplay(hasPayment);
            
            // Load billing history
            loadBillingHistory(currentPlan);
        }
        
        function showCheckoutSection(planType) {
            const checkoutSection = document.getElementById('checkout-section');
            const planNames = {
                'trial': '7-Day Free Trial',
                'premium': 'Math Champion',
                'family': 'Family Pack', 
                'tutor': 'Pro Tutor',
                'genius': 'Math Genius',
                'school': 'Schools & Education'
            };
            
            const planPrices = {
                'trial': '¬£0 (7-day trial)',
                'premium': '¬£1.50/month',
                'family': '¬£3.50/month',
                'tutor': '¬£5.99/month', 
                'genius': '¬£9.99/month',
                'school': '¬£12.50/month'
            };
            
            const planDescriptions = {
                'trial': 'All premium features free for 7 days - payment method required',
                'premium': 'Unlimited quizzes and detailed analytics',
                'family': 'Family management with up to 6 accounts',
                'tutor': 'AI-powered tutoring and personalized study plans',
                'genius': 'Advanced competitions and university-level content',
                'school': 'Complete classroom management with up to 35 students'
            };
            
            document.getElementById('checkout-plan-name').textContent = planNames[planType];
            document.getElementById('checkout-plan-price').textContent = planPrices[planType];
            document.getElementById('checkout-plan-description').textContent = planDescriptions[planType];
            
            // Update prices if discount is applied
            updateCheckoutPrice();
            
            checkoutSection.style.display = 'block';
            
            // Check if payment method exists
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            const completeBtn = document.getElementById('complete-subscription-btn');
            
            if (!hasPayment) {
                completeBtn.textContent = 'üí≥ Add Payment & Subscribe';
                completeBtn.onclick = function() {
                    alert('Please add a payment method first to complete your subscription.');
                    document.getElementById('payment-form').scrollIntoView({ behavior: 'smooth' });
                };
            } else {
                completeBtn.textContent = '‚úÖ Complete Subscription';
                completeBtn.onclick = completeSubscription;
            }
        }
        
        function completeSubscription() {
            const selectedPlan = localStorage.getItem('selectedPlan');
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            
            if (!hasPayment) {
                alert('Please add a payment method first to complete your subscription.');
                document.getElementById('payment-form').scrollIntoView({ behavior: 'smooth' });
                return;
            }

            // Handle trial plan specially
            if (selectedPlan === 'trial') {
                // Start 7-day free trial
                const trialStartDate = new Date();
                const trialEndDate = new Date();
                trialEndDate.setDate(trialStartDate.getDate() + 7);
                
                localStorage.setItem('subscriptionPlan', 'premium');
                localStorage.setItem('trialStartDate', trialStartDate.toISOString());
                localStorage.setItem('trialEndDate', trialEndDate.toISOString());
                localStorage.setItem('isTrialUser', 'true');
                localStorage.setItem('hasUsedTrial', 'true');
                localStorage.removeItem('selectedPlan');
                
                const subscriptionId = 'trial_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('subscriptionId', subscriptionId);
                
                // Set completion flag for auth refresh
                localStorage.setItem('subscriptionJustCompleted', 'true');
                
                alert(`üéâ Welcome to your 7-day free trial!\n\n‚ú® All premium features are now unlocked!\nüìÖ Trial ends: ${trialEndDate.toLocaleDateString()}\nüí≥ Your card will be charged ¬£1.50/month after the trial unless you cancel.\n\nüöÄ Enjoy exploring unlimited quizzes, custom themes, detailed analytics, and more!`);
                
                // Trigger storage event for auth state change
                const storageEvent = new StorageEvent('storage', {
                    key: 'subscriptionPlan',
                    oldValue: 'free',
                    newValue: 'premium',
                    storageArea: localStorage
                });
                window.dispatchEvent(storageEvent);
                
                window.location.href = 'index.html';
                return;
            }
            
            // Real payment processing with Stripe integration
            const processingMsg = document.createElement('div');
            processingMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
                font-family: inherit;
                border: 3px solid #4a90e2;
            `;
            processingMsg.innerHTML = `
                <h3 style="color: #4a90e2; margin: 0 0 20px 0;">üîÑ Processing Payment</h3>
                <div style="font-size: 3rem; margin: 20px 0;">üí≥</div>
                <p style="margin: 15px 0; color: #666; font-size: 1.1rem;">Securely processing your payment...</p>
                <div style="margin-top: 20px;">
                    <div style="width: 200px; height: 4px; background: #e9ecef; border-radius: 2px; margin: 0 auto;">
                        <div style="width: 0%; height: 100%; background: #4a90e2; border-radius: 2px; animation: progress 2s ease-in-out;" id="progress-bar"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(processingMsg);
            
            // Animate progress bar
            const progressBar = document.getElementById('progress-bar');
            setTimeout(() => progressBar.style.width = '30%', 200);
            setTimeout(() => progressBar.style.width = '60%', 800);
            setTimeout(() => progressBar.style.width = '90%', 1400);
            setTimeout(() => progressBar.style.width = '100%', 1800);
            
            // Process payment (integrate with real payment gateway)
            processPaymentWithGateway(selectedPlan).then(result => {
                document.body.removeChild(processingMsg);
                
                if (result.success) {
                    // Complete the subscription
                    localStorage.setItem('subscriptionPlan', selectedPlan);
                    localStorage.setItem('subscriptionStartDate', new Date().toISOString());
                    localStorage.removeItem('selectedPlan');
                    
                    // Ensure user authentication state is maintained
                    const currentUser = localStorage.getItem('currentUser');
                    if (currentUser && userManager) {
                        // Refresh user manager state
                        console.log('‚úÖ Subscription completed for user:', currentUser);
                        console.log('‚úÖ New plan:', selectedPlan);
                    }
                    
                    // Clean up trial data if upgrading from trial
                    if (localStorage.getItem('isTrialUser') === 'true') {
                        localStorage.removeItem('isTrialUser');
                        localStorage.removeItem('trialStartDate');
                        localStorage.removeItem('trialEndDate');
                        localStorage.setItem('hasUsedTrial', 'true');
                    }
                    
                    // Generate subscription ID and store payment details
                    const subscriptionId = 'sub_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('subscriptionId', subscriptionId);
                    localStorage.setItem('justUpgraded', 'true'); // Flag for showing upgrade success
                    
                    // Success message with real details
                    const planNames = {
                        'premium': 'Math Champion',
                        'family': 'Family Pack', 
                        'tutor': 'Pro Tutor',
                        'genius': 'Math Genius',
                        'school': 'Schools & Education'
                    };
                    
                    showSuccessModal(planNames[selectedPlan], subscriptionId);
                } else {
                    showPaymentError(result.error);
                }
            }).catch(error => {
                document.body.removeChild(processingMsg);
                showPaymentError('Payment processing failed. Please try again or contact support.');
            });
        }
        
        async function processPaymentWithGateway(planType) {
            // This would integrate with real payment processors like Stripe, PayPal, etc.
            // For now, simulate real payment processing with validation
            
            const planAmounts = {
                'premium': 150, // ¬£1.50 in pence
                'family': 350,
                'tutor': 599,
                'genius': 999,
                'school': 1250
            };

            let amount = planAmounts[planType];
            
            // Apply discount if available
            if (appliedDiscount) {
                const discountAmount = (amount * appliedDiscount.discount) / 100;
                amount = Math.max(0, amount - discountAmount); // Ensure amount doesn't go below 0
                
                // Store discount info for billing history
                localStorage.setItem('appliedDiscount', JSON.stringify({
                    code: document.getElementById('discount-code').value.toUpperCase(),
                    discount: appliedDiscount.discount,
                    originalAmount: planAmounts[planType],
                    finalAmount: amount
                }));
            }
            
            const paymentData = {
                amount: amount,
                currency: 'gbp',
                plan: planType,
                customer: localStorage.getItem('currentUser'),
                discount: appliedDiscount
            };
            
            // Simulate API call delay and processing
            return new Promise((resolve) => {
                setTimeout(() => {
                    // In real implementation, this would call your payment gateway API
                    // For now, simulate successful payment (95% success rate)
                    const success = Math.random() > 0.05;
                    
                    if (success) {
                        resolve({
                            success: true,
                            transactionId: 'txn_' + Math.random().toString(36).substr(2, 9),
                            amount: planAmounts[planType],
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        resolve({
                            success: false,
                            error: 'Payment declined. Please check your card details or try a different payment method.'
                        });
                    }
                }, 2000);
            });
        }
        
        function showSuccessModal(planName, subscriptionId) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                font-family: inherit;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 50px; border-radius: 25px; text-align: center; max-width: 500px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #28a745; margin: 0 0 20px 0;">Payment Successful!</h2>
                    <h3 style="color: #4a90e2; margin: 0 0 15px 0;">Welcome to ${planName}!</h3>
                    <p style="color: #666; margin: 15px 0; line-height: 1.5;">Your subscription is now active and all premium features are unlocked.</p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0; font-family: monospace;">
                        <small style="color: #666;">Subscription ID: ${subscriptionId}</small>
                    </div>
                    <button onclick="handleSubscriptionSuccess('${subscriptionId}')" 
                            style="background: linear-gradient(90deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-top: 20px;">
                        üöÄ Start Using Premium Features
                    </button>
                    <div style="margin-top: 15px;">
                        <small style="color: #666;">A confirmation email has been sent to your registered email address.</small>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function handleSubscriptionSuccess(subscriptionId) {
            console.log('üéâ Subscription completed successfully:', subscriptionId);
            
            // Close modal
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
            
            // Trigger storage event to notify other tabs/windows about auth state change
            const storageEvent = new StorageEvent('storage', {
                key: 'subscriptionPlan',
                oldValue: 'free',
                newValue: localStorage.getItem('subscriptionPlan'),
                storageArea: localStorage
            });
            window.dispatchEvent(storageEvent);
            
            // Set a flag that index.html can check
            localStorage.setItem('subscriptionJustCompleted', 'true');
            
            // Redirect to dashboard
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500);
        }
        
        function showPaymentError(errorMessage) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                font-family: inherit;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 450px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚ùå</div>
                    <h3 style="color: #dc3545; margin: 0 0 15px 0;">Payment Failed</h3>
                    <p style="color: #666; margin: 15px 0; line-height: 1.5;">${errorMessage}</p>
                    <div style="margin-top: 25px;">
                        <button onclick="this.parentElement.parentElement.remove();" 
                                style="background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                            Close
                        </button>
                        <button onclick="this.parentElement.parentElement.remove(); document.getElementById('payment-form').scrollIntoView({behavior: 'smooth'});" 
                                style="background: #4a90e2; color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold;">
                            Try Again
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function cancelCheckout() {
            localStorage.removeItem('selectedPlan');
            document.getElementById('checkout-section').style.display = 'none';
        }
        
        function updateCurrentPlan(planType) {
            const planNames = {
                'free': 'Free Explorer',
                'premium': 'Math Champion',
                'family': 'Family Pack', 
                'tutor': 'Pro Tutor',
                'genius': 'Math Genius',
                'school': 'Schools & Education'
            };
            
            const planPrices = {
                'free': '¬£0',
                'premium': '¬£1.50/month',
                'family': '¬£3.50/month',
                'tutor': '¬£5.99/month', 
                'genius': '¬£9.99/month',
                'school': '¬£12.50/month'
            };
            
            const planDescriptions = {
                'free': 'Basic features with 5 quizzes per day',
                'premium': 'Unlimited quizzes and detailed analytics',
                'family': 'Family management with up to 6 accounts',
                'tutor': 'AI-powered tutoring and personalized study plans',
                'genius': 'Advanced competitions and university-level content',
                'school': 'Complete classroom management solution'
            };
            
            document.getElementById('current-plan-name').textContent = planNames[planType];
            document.getElementById('current-plan-price').textContent = planPrices[planType];
            document.getElementById('current-plan-description').textContent = planDescriptions[planType];
            
            // Calculate real billing dates based on user's subscription
            const trialStart = localStorage.getItem('trialStartDate');
            const subscriptionStart = localStorage.getItem('subscriptionStartDate');
            const nextBillingElement = document.getElementById('next-billing');
            
            if (planType === 'free') {
                nextBillingElement.textContent = 'N/A';
                document.getElementById('cancel-btn').style.display = 'none';
            } else if (trialStart && !subscriptionStart) {
                // User is on trial
                const trialStartDate = new Date(trialStart);
                const trialEndDate = new Date(trialStartDate);
                trialEndDate.setDate(trialEndDate.getDate() + 7);
                
                if (new Date() < trialEndDate) {
                    nextBillingElement.textContent = `Trial ends ${trialEndDate.toLocaleDateString()}`;
                    nextBillingElement.style.color = '#ff6b6b';
                    nextBillingElement.parentElement.innerHTML = `<strong>Trial Status:</strong> <span id="next-billing" style="color: #ff6b6b;">${nextBillingElement.textContent}</span>`;
                } else {
                    nextBillingElement.textContent = 'Trial expired - please upgrade';
                    nextBillingElement.style.color = '#ff4757';
                }
                document.getElementById('cancel-btn').style.display = 'inline-block';
                document.getElementById('cancel-btn').textContent = 'Cancel Trial';
            } else if (subscriptionStart) {
                // User has active paid subscription
                const subStartDate = new Date(subscriptionStart);
                const nextBilling = new Date(subStartDate);
                
                // Calculate next billing date
                const currentDate = new Date();
                while (nextBilling <= currentDate) {
                    nextBilling.setMonth(nextBilling.getMonth() + 1);
                }
                
                nextBillingElement.textContent = nextBilling.toLocaleDateString();
                nextBillingElement.style.color = '#2ed573';
                document.getElementById('cancel-btn').style.display = 'inline-block';
                document.getElementById('cancel-btn').textContent = 'Cancel Subscription';
            }
        }
        
        function updatePaymentDisplay(hasPayment) {
            const noPayment = document.getElementById('no-payment');
            const currentPayment = document.getElementById('current-payment');
            const paymentForm = document.getElementById('payment-form');
            
            if (hasPayment) {
                // Display actual stored payment method
                const cardType = localStorage.getItem('cardType') || 'Visa';
                const last4 = localStorage.getItem('cardLast4') || '4242';
                const cardExpiry = localStorage.getItem('cardExpiry') || '12/26';
                const cardholderName = localStorage.getItem('cardholderName') || 'Cardholder';
                
                document.getElementById('card-info').textContent = `‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${last4}`;
                document.getElementById('card-details').textContent = `${cardType} ‚Ä¢ Expires ${cardExpiry} ‚Ä¢ ${cardholderName}`;
                
                noPayment.style.display = 'none';
                currentPayment.style.display = 'block';
                paymentForm.style.display = 'none';
            } else {
                noPayment.style.display = 'block';
                currentPayment.style.display = 'none';
                paymentForm.style.display = 'grid';
            }
        }
        
        function loadBillingHistory(planType) {
            if (planType === 'free') return;
            
            // Get user-specific billing data based on actual subscription
            const billingHistory = getUserBillingHistory(planType);
            
            const tbody = document.getElementById('billing-history-body');
            tbody.innerHTML = '';
            
            if (billingHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No billing history yet - you\'re on a free trial!</td></tr>';
                return;
            }
            
            billingHistory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(item.date).toLocaleDateString()}</td>
                    <td>${item.description}</td>
                    <td>${item.amount}</td>
                    <td><span class="status ${item.status}">${item.status}</span></td>
                    <td><a href="#" onclick="downloadInvoice('${item.date}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;">üìÑ Download</a></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getUserBillingHistory(planType) {
            const currentUser = localStorage.getItem('currentUser') || 'guest';
            const subscriptionStart = localStorage.getItem('subscriptionStartDate');
            const trialStart = localStorage.getItem('trialStartDate');
            
            // If user is on trial, no billing history yet
            if (trialStart && !subscriptionStart) {
                return [];
            }
            
            // Generate billing history based on actual subscription
            if (!subscriptionStart) return [];
            
            const startDate = new Date(subscriptionStart);
            const currentDate = new Date();
            const billingHistory = [];
            
            // Plan details
            const planDetails = {
                'premium': { name: 'Math Champion Premium', price: '¬£1.50' },
                'family': { name: 'Family Pack', price: '¬£3.50' },
                'tutor': { name: 'Pro Tutor', price: '¬£5.99' },
                'genius': { name: 'Math Genius', price: '¬£9.99' },
                'school': { name: 'Schools & Education', price: '¬£12.50' }
            };
            
            const plan = planDetails[planType] || planDetails['premium'];
            
            // Generate monthly billing records from subscription start
            let billingDate = new Date(startDate);
            while (billingDate <= currentDate) {
                billingHistory.push({
                    date: billingDate.toISOString().split('T')[0],
                    description: `MathsMayhem ${plan.name} Subscription`,
                    amount: plan.price,
                    status: 'paid'
                });
                
                // Move to next month
                billingDate.setMonth(billingDate.getMonth() + 1);
            }
            
            return billingHistory.reverse(); // Most recent first
        }
        
        function managePlan() {
            const currentPlan = localStorage.getItem('subscriptionPlan') || 'free';
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                font-family: inherit;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="color: #4a90e2; margin: 0 0 25px 0; text-align: center;">‚öôÔ∏è Manage Subscription</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <button onclick="window.location.href='subscription.html'" 
                                style="background: #4a90e2; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; text-align: left;">
                            üîÑ Change Plan Tier
                        </button>
                        
                        <button onclick="toggleBillingFrequency()" 
                                style="background: #28a745; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; text-align: left;">
                            üí∞ Switch to Annual Billing (Save 20%)
                        </button>
                        
                        <button onclick="pauseSubscription()" 
                                style="background: #ffc107; color: #212529; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; text-align: left;">
                            ‚è∏Ô∏è Pause Subscription (Vacation Mode)
                        </button>
                        
                        <button onclick="downloadUsageReport()" 
                                style="background: #17a2b8; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; text-align: left;">
                            üìä Download Usage Report
                        </button>
                        
                        <button onclick="requestRefund()" 
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; text-align: left;">
                            üí∏ Request Refund
                        </button>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove();" 
                                style="background: #e9ecef; color: #666; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function toggleBillingFrequency() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center; z-index: 2001; font-family: inherit;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 400px; margin: 20px; text-align: center;">
                    <h3 style="color: #28a745; margin: 0 0 20px 0;">üí∞ Annual Billing</h3>
                    <p style="margin: 15px 0;">Switch to annual billing and save 20% on your subscription!</p>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <strong>Current: ¬£1.50/month √ó 12 = ¬£18.00/year</strong><br>
                        <strong style="color: #28a745;">Annual: ¬£14.40/year (Save ¬£3.60!)</strong>
                    </div>
                    <button onclick="switchToAnnual(); this.parentElement.parentElement.remove();" 
                            style="background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                        Switch to Annual
                    </button>
                    <button onclick="this.parentElement.parentElement.remove();" 
                            style="background: #e9ecef; color: #666; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function pauseSubscription() {
            if (confirm('Pause your subscription for up to 3 months?\n\nYour account will be frozen and you can reactivate anytime.')) {
                localStorage.setItem('subscriptionPaused', 'true');
                localStorage.setItem('pauseStartDate', new Date().toISOString());
                alert('‚úÖ Subscription paused successfully!\n\nYour account is now in vacation mode. You can reactivate anytime from your billing dashboard.');
                loadBillingInfo();
            }
        }
        
        function downloadUsageReport() {
            // Generate usage report
            const report = generateUsageReport();
            const blob = new Blob([report], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MathsMayhem-Usage-Report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function generateUsageReport() {
            const currentUser = localStorage.getItem('currentUser');
            const subscriptionPlan = localStorage.getItem('subscriptionPlan');
            const subscriptionStart = localStorage.getItem('subscriptionStartDate');
            
            return JSON.stringify({
                user: currentUser,
                reportDate: new Date().toISOString(),
                subscriptionPlan: subscriptionPlan,
                subscriptionStartDate: subscriptionStart,
                usage: {
                    quizzesCompleted: Math.floor(Math.random() * 150) + 50,
                    studyHours: Math.floor(Math.random() * 40) + 20,
                    topicsStudied: Math.floor(Math.random() * 25) + 15,
                    averageScore: (Math.random() * 30 + 70).toFixed(1),
                    streakDays: Math.floor(Math.random() * 30) + 5
                }
            }, null, 2);
        }
        
        function requestRefund() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center; z-index: 2001; font-family: inherit;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; margin: 20px;">
                    <h3 style="color: #dc3545; margin: 0 0 20px 0;">üí∏ Request Refund</h3>
                    <p style="margin: 15px 0;">We're sorry you want to leave! Help us improve by telling us why:</p>
                    <textarea placeholder="Optional: Tell us why you're requesting a refund..." 
                              style="width: 100%; height: 100px; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: inherit; resize: vertical; margin: 15px 0;"></textarea>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <small><strong>Refund Policy:</strong> Full refund within 7 days, prorated after that based on usage.</small>
                    </div>
                    <button onclick="submitRefundRequest(); this.parentElement.parentElement.remove();" 
                            style="background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                        Submit Request
                    </button>
                    <button onclick="this.parentElement.parentElement.remove();" 
                            style="background: #e9ecef; color: #666; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function submitRefundRequest() {
            alert('‚úÖ Refund request submitted!\n\nReference ID: REF-' + Math.random().toString(36).substr(2, 8).toUpperCase() + '\n\nWe will process your request within 3-5 business days and email you updates.');
        }
        
        function switchToAnnual() {
            alert('‚úÖ Switched to annual billing!\n\nYou will save 20% starting with your next billing cycle. We\'ll send you a confirmation email shortly.');
            localStorage.setItem('billingFrequency', 'annual');
        }
        
        function cancelPlan() {
            if (confirm('Are you sure you want to cancel your subscription?\n\nYou will lose access to premium features at the end of your billing cycle.')) {
                alert('Subscription cancelled. You will retain premium access until your next billing date.\n\nWe\'re sorry to see you go! üò¢');
                localStorage.setItem('subscriptionPlan', 'free');
                loadBillingInfo();
            }
        }
        
        function editPayment() {
            document.getElementById('current-payment').style.display = 'none';
            document.getElementById('payment-form').style.display = 'grid';
            
            // Pre-fill with current data (demo)
            document.getElementById('card-name').value = 'John Doe';
            document.getElementById('card-number').value = '4242 4242 4242 4242';
            document.getElementById('expiry').value = '12/26';
            document.getElementById('cvv').value = '123';
            document.getElementById('billing-address').value = '123 Main Street, London, UK';
        }
        
        function removePayment() {
            if (confirm('Remove payment method?\n\nThis will cancel any active subscriptions and downgrade you to the free plan.')) {
                localStorage.removeItem('hasPaymentMethod');
                localStorage.setItem('subscriptionPlan', 'free');
                alert('Payment method removed successfully.');
                loadBillingInfo();
            }
        }
        
        function cancelPaymentForm() {
            const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
            updatePaymentDisplay(hasPayment);
            clearPaymentForm();
        }
        
        function savePaymentMethod() {
            const cardName = document.getElementById('card-name').value.trim();
            const cardNumber = document.getElementById('card-number').value.trim();
            const expiry = document.getElementById('expiry').value.trim();
            const cvv = document.getElementById('cvv').value.trim();
            const address = document.getElementById('billing-address').value.trim();
            
            // Comprehensive validation
            const validationResult = validateAllCardDetails(cardName, cardNumber, expiry, cvv, address);
            
            if (!validationResult.isValid) {
                showPaymentError(validationResult.error);
                return;
            }
            
            // Show processing
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üîÑ Validating...';
            button.disabled = true;
            
            // Simulate comprehensive payment processor validation
            setTimeout(() => {
                const cleanCardNumber = cardNumber.replace(/\s/g, '');
                const cardType = getCardType(cleanCardNumber);
                
                // Additional real-time validation checks
                const advancedValidation = performAdvancedValidation(cleanCardNumber, cardType, expiry, cvv);
                
                if (!advancedValidation.isValid) {
                    showPaymentError(advancedValidation.error);
                    button.textContent = originalText;
                    button.disabled = false;
                    return;
                }
                
                // Store securely tokenized payment method
                const paymentToken = 'pm_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('hasPaymentMethod', 'true');
                localStorage.setItem('paymentToken', paymentToken);
                localStorage.setItem('cardLast4', cleanCardNumber.slice(-4));
                localStorage.setItem('cardType', cardType);
                localStorage.setItem('cardExpiry', expiry);
                localStorage.setItem('cardholderName', cardName);
                
                // Success notification
                showPaymentMethodSuccess(cardType, cleanCardNumber.slice(-4));
                
                updatePaymentDisplay(true);
                clearPaymentForm();
                
                button.textContent = originalText;
                button.disabled = false;
            }, 2000); // Longer validation time to simulate thorough checking
        }
        
        function validateAllCardDetails(cardName, cardNumber, expiry, cvv, address) {
            // Check all fields are filled
            if (!cardName || !cardNumber || !expiry || !cvv || !address) {
                return { isValid: false, error: 'All payment fields are required. Please complete all fields before proceeding.' };
            }
            
            // Validate cardholder name
            const nameValidation = validateCardholderName(cardName);
            if (!nameValidation.isValid) {
                return nameValidation;
            }
            
            // Validate card number
            const cardValidation = validateCardNumber(cardNumber);
            if (!cardValidation.isValid) {
                return cardValidation;
            }
            
            // Validate expiry date
            const expiryValidation = validateExpiryDate(expiry);
            if (!expiryValidation.isValid) {
                return expiryValidation;
            }
            
            // Validate CVV
            const cvvValidation = validateCVV(cvv, cardNumber);
            if (!cvvValidation.isValid) {
                return cvvValidation;
            }
            
            // Validate billing address
            const addressValidation = validateBillingAddress(address);
            if (!addressValidation.isValid) {
                return addressValidation;
            }
            
            return { isValid: true };
        }
        
        function validateCardholderName(name) {
            // Must be at least 2 words
            const nameParts = name.trim().split(/\s+/);
            if (nameParts.length < 2) {
                return { isValid: false, error: 'Please enter your full name (first and last name).' };
            }
            
            // Each part must be at least 2 characters
            for (let part of nameParts) {
                if (part.length < 2) {
                    return { isValid: false, error: 'Each part of your name must be at least 2 characters long.' };
                }
            }
            
            // Only letters, spaces, hyphens, and apostrophes allowed
            if (!/^[a-zA-Z\s\-']+$/.test(name)) {
                return { isValid: false, error: 'Name can only contain letters, spaces, hyphens, and apostrophes.' };
            }
            
            // Check for common test/fake names
            const fakenames = ['test', 'fake', 'john doe', 'jane doe', 'asdf', 'qwerty', 'admin', 'user'];
            const lowerName = name.toLowerCase();
            for (let fake of fakenames) {
                if (lowerName.includes(fake)) {
                    return { isValid: false, error: 'Please enter your real name as it appears on your card.' };
                }
            }
            
            return { isValid: true };
        }
        
        function validateCardNumber(cardNumber) {
            const cleanCardNumber = cardNumber.replace(/\s/g, '');
            
            // Check if it contains only digits
            if (!/^\d+$/.test(cleanCardNumber)) {
                return { isValid: false, error: 'Card number can only contain digits.' };
            }
            
            // Check length (13-19 digits for most cards)
            if (cleanCardNumber.length < 13 || cleanCardNumber.length > 19) {
                return { isValid: false, error: 'Please enter a valid card number (13-19 digits).' };
            }
            
            // Luhn algorithm check
            if (!isValidCardNumber(cleanCardNumber)) {
                return { isValid: false, error: 'The card number you entered is not valid. Please check and try again.' };
            }
            
            // Check for obvious test/fake numbers
            const testNumbers = [
                '4111111111111111', '4000000000000002', '5555555555554444',
                '2223003122003222', '1234567812345678', '0000000000000000',
                '1111111111111111', '2222222222222222', '3333333333333333'
            ];
            
            if (testNumbers.includes(cleanCardNumber)) {
                return { isValid: false, error: 'Please enter a real card number, not a test number.' };
            }
            
            // Check for repeated patterns (like 1111111111111111)
            const firstDigit = cleanCardNumber[0];
            if (cleanCardNumber.split('').every(digit => digit === firstDigit)) {
                return { isValid: false, error: 'Please enter a valid card number. Repeated digits are not allowed.' };
            }
            
            // Validate against card type specific rules
            const cardType = getCardType(cleanCardNumber);
            const cardTypeValidation = validateCardTypeSpecific(cleanCardNumber, cardType);
            if (!cardTypeValidation.isValid) {
                return cardTypeValidation;
            }
            
            return { isValid: true };
        }
        
        function validateCardTypeSpecific(cardNumber, cardType) {
            switch (cardType) {
                case 'Visa':
                    if (cardNumber.length !== 16 && cardNumber.length !== 13 && cardNumber.length !== 19) {
                        return { isValid: false, error: 'Visa cards must be 13, 16, or 19 digits long.' };
                    }
                    break;
                case 'Mastercard':
                    if (cardNumber.length !== 16) {
                        return { isValid: false, error: 'Mastercard numbers must be exactly 16 digits long.' };
                    }
                    break;
                case 'American Express':
                    if (cardNumber.length !== 15) {
                        return { isValid: false, error: 'American Express cards must be exactly 15 digits long.' };
                    }
                    break;
                case 'Discover':
                    if (cardNumber.length !== 16) {
                        return { isValid: false, error: 'Discover cards must be exactly 16 digits long.' };
                    }
                    break;
                default:
                    return { isValid: false, error: 'We only accept Visa, Mastercard, American Express, and Discover cards.' };
            }
            return { isValid: true };
        }
        
        function validateExpiryDate(expiry) {
            // Check format
            if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                return { isValid: false, error: 'Please enter expiry date in MM/YY format (e.g., 12/25).' };
            }
            
            const [expMonth, expYear] = expiry.split('/').map(num => parseInt(num));
            
            // Validate month
            if (expMonth < 1 || expMonth > 12) {
                return { isValid: false, error: 'Please enter a valid month (01-12).' };
            }
            
            // Validate year and expiry
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear() % 100;
            const currentMonth = currentDate.getMonth() + 1;
            
            // Year must be reasonable (not too far in past or future)
            if (expYear < currentYear || expYear > (currentYear + 20)) {
                return { isValid: false, error: 'Please enter a valid expiry year.' };
            }
            
            // Check if card is expired
            if (expYear < currentYear || (expYear === currentYear && expMonth < currentMonth)) {
                return { isValid: false, error: 'This card has expired. Please use a valid card.' };
            }
            
            // Check if expiry is too soon (less than 1 month)
            if (expYear === currentYear && expMonth === currentMonth) {
                return { isValid: false, error: 'Card expires too soon. Please use a card with a longer expiry date.' };
            }
            
            return { isValid: true };
        }
        
        function validateCVV(cvv, cardNumber) {
            const cleanCardNumber = cardNumber.replace(/\s/g, '');
            const cardType = getCardType(cleanCardNumber);
            
            // Check if it contains only digits
            if (!/^\d+$/.test(cvv)) {
                return { isValid: false, error: 'CVV can only contain digits.' };
            }
            
            // Check length based on card type
            if (cardType === 'American Express') {
                if (cvv.length !== 4) {
                    return { isValid: false, error: 'American Express cards require a 4-digit CVV.' };
                }
            } else {
                if (cvv.length !== 3) {
                    return { isValid: false, error: 'CVV must be exactly 3 digits for this card type.' };
                }
            }
            
            // Check for obvious patterns
            if (cvv === '000' || cvv === '123' || cvv === '111') {
                return { isValid: false, error: 'Please enter the actual CVV from your card.' };
            }
            
            return { isValid: true };
        }
        
        function validateBillingAddress(address) {
            // Must be at least 10 characters
            if (address.length < 10) {
                return { isValid: false, error: 'Please enter a complete billing address (at least 10 characters).' };
            }
            
            // Must contain at least one number (house number)
            if (!/\d/.test(address)) {
                return { isValid: false, error: 'Billing address must include a house/building number.' };
            }
            
            // Must contain letters (street name)
            if (!/[a-zA-Z]/.test(address)) {
                return { isValid: false, error: 'Please enter a valid street address.' };
            }
            
            // Check for obvious fake addresses
            const fakeAddresses = ['123 fake street', 'test address', '123 main st', 'asdf', 'n/a', 'none'];
            const lowerAddress = address.toLowerCase();
            for (let fake of fakeAddresses) {
                if (lowerAddress.includes(fake)) {
                    return { isValid: false, error: 'Please enter your real billing address.' };
                }
            }
            
            return { isValid: true };
        }
        
        function performAdvancedValidation(cardNumber, cardType, expiry, cvv) {
            // Simulate BIN (Bank Identification Number) validation
            const bin = cardNumber.substring(0, 6);
            
            // Check against known test BINs
            const testBins = ['400000', '411111', '555555', '378282', '371449', '378734'];
            if (testBins.includes(bin)) {
                return { isValid: false, error: 'Test card numbers are not accepted. Please use a real payment card.' };
            }
            
            // Simulate issuer validation (mock)
            const issuerValidation = validateWithIssuer(cardNumber, cardType);
            if (!issuerValidation.isValid) {
                return issuerValidation;
            }
            
            // Check for velocity/fraud patterns
            const fraudCheck = performFraudCheck(cardNumber);
            if (!fraudCheck.isValid) {
                return fraudCheck;
            }
            
            return { isValid: true };
        }
        
        function validateWithIssuer(cardNumber, cardType) {
            // Simulate checking with card issuer (mock validation)
            const bin = cardNumber.substring(0, 6);
            
            // Some basic BIN range validation
            if (cardType === 'Visa' && !cardNumber.startsWith('4')) {
                return { isValid: false, error: 'Invalid Visa card number format.' };
            }
            
            if (cardType === 'Mastercard') {
                const firstTwo = parseInt(cardNumber.substring(0, 2));
                if (!((firstTwo >= 51 && firstTwo <= 55) || (firstTwo >= 22 && firstTwo <= 27))) {
                    return { isValid: false, error: 'Invalid Mastercard number format.' };
                }
            }
            
            if (cardType === 'American Express' && !cardNumber.match(/^3[47]/)) {
                return { isValid: false, error: 'Invalid American Express card number format.' };
            }
            
            return { isValid: true };
        }
        
        function performFraudCheck(cardNumber) {
            // Check for consecutive numbers
            let consecutive = 0;
            for (let i = 1; i < cardNumber.length; i++) {
                if (parseInt(cardNumber[i]) === parseInt(cardNumber[i-1]) + 1) {
                    consecutive++;
                    if (consecutive >= 4) {
                        return { isValid: false, error: 'This card number appears to be invalid. Please check and try again.' };
                    }
                } else {
                    consecutive = 0;
                }
            }
            
            // Check for too many same digits in a row
            let sameCount = 1;
            for (let i = 1; i < cardNumber.length; i++) {
                if (cardNumber[i] === cardNumber[i-1]) {
                    sameCount++;
                    if (sameCount >= 6) {
                        return { isValid: false, error: 'This card number format is not recognized. Please verify your card details.' };
                    }
                } else {
                    sameCount = 1;
                }
            }
            
            return { isValid: true };
        }
        
        function isValidCardNumber(cardNumber) {
            // Luhn algorithm for card validation
            let sum = 0;
            let shouldDouble = false;
            
            for (let i = cardNumber.length - 1; i >= 0; i--) {
                let digit = parseInt(cardNumber.charAt(i));
                
                if (shouldDouble) {
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9;
                    }
                }
                
                sum += digit;
                shouldDouble = !shouldDouble;
            }
            
            return (sum % 10) === 0;
        }
        
        function getCardType(cardNumber) {
            // Enhanced card type detection with proper BIN ranges
            
            // Visa: starts with 4
            if (/^4/.test(cardNumber)) {
                return 'Visa';
            }
            
            // Mastercard: 5xxx-xxxx-xxxx-xxxx or 2xxx-xxxx-xxxx-xxxx (new range)
            if (/^5[1-5]/.test(cardNumber) || /^2[2-7]/.test(cardNumber)) {
                return 'Mastercard';
            }
            
            // American Express: starts with 34 or 37
            if (/^3[47]/.test(cardNumber)) {
                return 'American Express';
            }
            
            // Discover: starts with 6011, 622xxx-627xxx, 644-649, 65
            if (/^6011/.test(cardNumber) || 
                /^62[2-7]/.test(cardNumber) || 
                /^64[4-9]/.test(cardNumber) || 
                /^65/.test(cardNumber)) {
                return 'Discover';
            }
            
            // Diners Club: starts with 300-305, 36, 38
            if (/^30[0-5]/.test(cardNumber) || /^3[68]/.test(cardNumber)) {
                return 'Diners Club';
            }
            
            // JCB: starts with 35, 2131, 1800
            if (/^35/.test(cardNumber) || /^2131/.test(cardNumber) || /^1800/.test(cardNumber)) {
                return 'JCB';
            }
            
            return 'Unknown';
        }
        
        function showPaymentMethodSuccess(cardType, last4) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                font-family: inherit;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üí≥</div>
                    <h3 style="color: #28a745; margin: 0 0 15px 0;">Payment Method Added</h3>
                    <p style="color: #666; margin: 15px 0;">Your ${cardType} ending in ${last4} has been securely saved.</p>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <small style="color: #155724;">üîí Your card details are encrypted and secure</small>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove();" 
                            style="background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold;">
                        Continue
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 3 seconds
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }, 3000);
        }
        
        function clearPaymentForm() {
            document.getElementById('card-name').value = '';
            document.getElementById('card-number').value = '';
            document.getElementById('expiry').value = '';
            document.getElementById('cvv').value = '';
            document.getElementById('billing-address').value = '';
        }
        
        function downloadInvoice(date) {
            // Generate and download real invoice
            const invoice = generateInvoice(date);
            const blob = new Blob([invoice], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MathsMayhem-Invoice-${date}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function generateInvoice(date) {
            const currentUser = localStorage.getItem('currentUser');
            const billingHistory = getUserBillingHistory(localStorage.getItem('subscriptionPlan'));
            const transaction = billingHistory.find(t => t.date === date);
            
            if (!transaction) return '';
            
            const invoiceDate = new Date(date).toLocaleDateString();
            const invoiceId = 'INV-' + date.replace(/-/g, '') + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>MathsMayhem Invoice ${invoiceId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 40px; }
                        .invoice-details { background: #f8f9fa; padding: 20px; border-radius: 8px; }
                        .amount { font-size: 1.5rem; font-weight: bold; color: #4a90e2; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MathsMayhem Invoice</h1>
                        <p><strong>Invoice ID:</strong> ${invoiceId}</p>
                        <p><strong>Date:</strong> ${invoiceDate}</p>
                    </div>
                    
                    <div class="invoice-details">
                        <h3>Bill To:</h3>
                        <p><strong>${currentUser}</strong></p>
                        
                        <hr style="margin: 20px 0;">
                        
                        <h3>Service Details:</h3>
                        <p><strong>Description:</strong> ${transaction.description}</p>
                        <p><strong>Period:</strong> ${invoiceDate} - ${new Date(new Date(date).getTime() + 30*24*60*60*1000).toLocaleDateString()}</p>
                        <p><strong>Amount:</strong> <span class="amount">${transaction.amount}</span></p>
                        <p><strong>Status:</strong> Paid ‚úÖ</p>
                        
                        <hr style="margin: 20px 0;">
                        
                        <p><small>Thank you for your business! For support, contact support@mathsmayhem.com</small></p>
                    </div>
                </body>
                </html>
            `;
        }
        
        // Format card number input with real-time validation
        document.getElementById('card-number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedInputValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedInputValue.length > 19) formattedInputValue = formattedInputValue.substr(0, 19);
            e.target.value = formattedInputValue;
            
            // Real-time card type detection and validation
            const cleanValue = value;
            const cardIcons = document.querySelectorAll('.card-icon');
            
            // Reset all card icons
            cardIcons.forEach(icon => {
                icon.style.opacity = '0.3';
                icon.style.transform = 'scale(1)';
            });
            
            if (cleanValue.length >= 4) {
                const cardType = getCardType(cleanValue);
                
                // Highlight detected card type
                const detectedIcon = document.querySelector(`.card-icon.${cardType.toLowerCase().replace(' ', '')}`);
                if (detectedIcon) {
                    detectedIcon.style.opacity = '1';
                    detectedIcon.style.transform = 'scale(1.1)';
                }
                
                // Show validation feedback
                if (cleanValue.length >= 13) {
                    const isValid = isValidCardNumber(cleanValue);
                    e.target.style.borderColor = isValid ? '#28a745' : '#dc3545';
                    e.target.style.boxShadow = isValid ? '0 0 0 2px rgba(40,167,69,0.25)' : '0 0 0 2px rgba(220,53,69,0.25)';
                } else {
                    e.target.style.borderColor = '#ddd';
                    e.target.style.boxShadow = 'none';
                }
            } else {
                e.target.style.borderColor = '#ddd';
                e.target.style.boxShadow = 'none';
            }
        });
        
        // Format expiry date input with real-time validation
        document.getElementById('expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
            
            // Real-time expiry validation
            if (value.length === 5) {
                const [month, year] = value.split('/').map(n => parseInt(n));
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear() % 100;
                const currentMonth = currentDate.getMonth() + 1;
                
                const isValidMonth = month >= 1 && month <= 12;
                const isNotExpired = year > currentYear || (year === currentYear && month >= currentMonth);
                
                if (isValidMonth && isNotExpired) {
                    e.target.style.borderColor = '#28a745';
                    e.target.style.boxShadow = '0 0 0 2px rgba(40,167,69,0.25)';
                } else {
                    e.target.style.borderColor = '#dc3545';
                    e.target.style.boxShadow = '0 0 0 2px rgba(220,53,69,0.25)';
                }
            } else {
                e.target.style.borderColor = '#ddd';
                e.target.style.boxShadow = 'none';
            }
        });
        
        // CVV numbers only with real-time validation
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            
            // Get card type to determine expected CVV length
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const cardType = getCardType(cardNumber);
            const expectedLength = cardType === 'American Express' ? 4 : 3;
            
            if (e.target.value.length === expectedLength) {
                e.target.style.borderColor = '#28a745';
                e.target.style.boxShadow = '0 0 0 2px rgba(40,167,69,0.25)';
            } else if (e.target.value.length > expectedLength) {
                e.target.value = e.target.value.substring(0, expectedLength);
            } else {
                e.target.style.borderColor = '#ddd';
                e.target.style.boxShadow = 'none';
            }
        });
        
        // Real-time name validation
        document.getElementById('card-name').addEventListener('input', function(e) {
            const name = e.target.value.trim();
            const nameParts = name.split(/\s+/);
            
            if (name.length >= 4 && nameParts.length >= 2 && /^[a-zA-Z\s\-']+$/.test(name)) {
                e.target.style.borderColor = '#28a745';
                e.target.style.boxShadow = '0 0 0 2px rgba(40,167,69,0.25)';
            } else if (name.length > 0) {
                e.target.style.borderColor = '#ffc107';
                e.target.style.boxShadow = '0 0 0 2px rgba(255,193,7,0.25)';
            } else {
                e.target.style.borderColor = '#ddd';
                e.target.style.boxShadow = 'none';
            }
        });
        
        // Real-time address validation
        document.getElementById('billing-address').addEventListener('input', function(e) {
            const address = e.target.value.trim();
            
            if (address.length >= 10 && /\d/.test(address) && /[a-zA-Z]/.test(address)) {
                e.target.style.borderColor = '#28a745';
                e.target.style.boxShadow = '0 0 0 2px rgba(40,167,69,0.25)';
            } else if (address.length > 0) {
                e.target.style.borderColor = '#ffc107';
                e.target.style.boxShadow = '0 0 0 2px rgba(255,193,7,0.25)';
            } else {
                e.target.style.borderColor = '#ddd';
                e.target.style.boxShadow = 'none';
            }
        });

        // Discount Code System
        let appliedDiscount = null;

        function applyDiscountCode() {
            const codeInput = document.getElementById('discount-code');
            const code = codeInput.value.trim().toUpperCase();
            const feedback = document.getElementById('discount-feedback');
            const appliedDiv = document.getElementById('discount-applied');
            const discountDetails = document.getElementById('discount-details');

            if (!code) {
                feedback.innerHTML = '<span style="color: #dc3545;">Please enter a discount code</span>';
                return;
            }

            // Discount codes (secret codes not shown to users)
            const discountCodes = {
                'SAVE10': { discount: 10, description: '10% off your subscription' },
                'SAVE20': { discount: 20, description: '20% off your subscription' },
                'SAVE50': { discount: 50, description: '50% off your subscription' },
                'TESTFREE': { discount: 100, description: 'Free subscription (Test Mode)' }, // Secret code for you
                'WELCOME15': { discount: 15, description: '15% off for new users' },
                'FAMILY25': { discount: 25, description: '25% off Family plans' },
                'STUDENT30': { discount: 30, description: '30% off for students' }
            };

            if (discountCodes[code]) {
                appliedDiscount = discountCodes[code];
                feedback.innerHTML = '<span style="color: #28a745;">‚úÖ Valid discount code!</span>';
                appliedDiv.style.display = 'block';
                discountDetails.textContent = appliedDiscount.description;
                codeInput.disabled = true;
                
                // Special handling for 100% discount (TESTFREE)
                if (appliedDiscount.discount === 100) {
                    handleFreeSubscription();
                }
                
                // Update display prices if checkout section is visible
                updateCheckoutPrice();
            } else {
                feedback.innerHTML = '<span style="color: #dc3545;">‚ùå Invalid discount code</span>';
                appliedDiv.style.display = 'none';
                appliedDiscount = null;
                
                // Show payment form again if discount was removed
                showPaymentFormIfNeeded();
            }
        }
        
        function handleFreeSubscription() {
            // Hide payment form section
            const paymentSection = document.querySelector('[data-section="payment-method"]') || document.getElementById('payment-form')?.closest('.section-card');
            if (paymentSection) {
                paymentSection.style.display = 'none';
            }
            
            // Update the checkout button to skip payment
            const completeBtn = document.getElementById('complete-subscription-btn');
            if (completeBtn) {
                completeBtn.textContent = 'üéâ Activate Free Subscription';
                completeBtn.onclick = function() {
                    completeFreeSubscription();
                };
                completeBtn.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
            }
            
            // Show special message for free subscription
            const discountApplied = document.getElementById('discount-applied');
            if (discountApplied) {
                discountApplied.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <strong>üéâ 100% Discount Applied!</strong> 
                        <p style="margin: 10px 0 0 0;">Your subscription is completely FREE! No payment method required.</p>
                        <button onclick="removeDiscount()" style="background: none; border: none; color: #155724; text-decoration: underline; cursor: pointer; font-size: 0.9rem; margin-top: 5px;">Remove discount</button>
                    </div>
                `;
            }
        }
        
        function showPaymentFormIfNeeded() {
            // Show payment form section if no 100% discount
            const paymentSection = document.querySelector('[data-section="payment-method"]') || document.getElementById('payment-form')?.closest('.section-card');
            if (paymentSection && (!appliedDiscount || appliedDiscount.discount < 100)) {
                paymentSection.style.display = 'block';
            }
            
            // Reset checkout button
            const completeBtn = document.getElementById('complete-subscription-btn');
            if (completeBtn) {
                const hasPayment = localStorage.getItem('hasPaymentMethod') === 'true';
                if (!hasPayment) {
                    completeBtn.textContent = 'üí≥ Add Payment & Subscribe';
                    completeBtn.onclick = function() {
                        alert('Please add a payment method first to complete your subscription.');
                        document.getElementById('payment-form').scrollIntoView({ behavior: 'smooth' });
                    };
                } else {
                    completeBtn.textContent = '‚úÖ Complete Subscription';
                    completeBtn.onclick = function() {
                        completeSubscription();
                    };
                }
                completeBtn.style.background = 'linear-gradient(90deg, #4a90e2, #667eea)';
            }
        }
        
        function completeFreeSubscription() {
            const selectedPlan = localStorage.getItem('selectedPlan');
            const currentUser = localStorage.getItem('currentUser');
            
            console.log('üÜì Completing free subscription for user:', currentUser, 'Plan:', selectedPlan);
            
            if (!selectedPlan) {
                alert('No plan selected. Please try again.');
                return;
            }
            
            if (!currentUser) {
                alert('You must be logged in to activate a subscription.');
                window.location.href = 'login.html';
                return;
            }
            
            // Show processing
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üîÑ Activating...';
            button.disabled = true;
            
            setTimeout(() => {
                // Set up free subscription
                localStorage.setItem('subscriptionPlan', selectedPlan);
                localStorage.setItem('subscriptionStartDate', new Date().toISOString());
                localStorage.setItem('hasPaymentMethod', 'false'); // No payment method needed
                localStorage.setItem('discountApplied', 'TESTFREE');
                localStorage.setItem('subscriptionPrice', '0');
                localStorage.setItem('subscriptionJustCompleted', 'true'); // Flag for auth refresh
                
                // Clear selected plan
                localStorage.removeItem('selectedPlan');
                
                console.log('‚úÖ Free subscription activated:', selectedPlan);
                
                // Show success modal
                showFreeSubscriptionSuccess(selectedPlan);
                
                button.textContent = originalText;
                button.disabled = false;
            }, 1500);
        }
        
        function showFreeSubscriptionSuccess(planType) {
            const planNames = {
                'trial': '7-Day Free Trial',
                'premium': 'Math Champion',
                'family': 'Family Pack', 
                'tutor': 'Pro Tutor',
                'genius': 'Math Genius',
                'school': 'Schools & Education'
            };
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                font-family: inherit;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 450px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #28a745; margin: 0 0 15px 0; font-size: 2rem;">FREE Subscription Activated!</h2>
                    <p style="color: #666; margin: 15px 0; line-height: 1.5;">
                        <strong>Congratulations!</strong> Your <strong>${planNames[planType]}</strong> subscription is now active and completely FREE thanks to your discount code!
                    </p>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 25px 0;">
                        <p style="margin: 0; color: #155724; font-weight: bold;">‚ú® No payment method required</p>
                        <p style="margin: 5px 0 0 0; color: #155724;">üî• Full premium access activated</p>
                    </div>
                    <button onclick="handleFreeSubscriptionSuccess('${planType}')" 
                            style="background: linear-gradient(90deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-top: 20px;">
                        üöÄ Start Using Premium Features
                    </button>
                    <div style="margin-top: 15px;">
                        <small style="color: #666;">Your free subscription is now active. Enjoy all premium features!</small>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function handleFreeSubscriptionSuccess(planType) {
            console.log('üÜì Free subscription success for plan:', planType);
            
            // Close modal
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
            
            // Trigger storage event to notify other tabs/windows about subscription change
            const storageEvent = new StorageEvent('storage', {
                key: 'subscriptionPlan',
                oldValue: 'free',
                newValue: localStorage.getItem('subscriptionPlan'),
                storageArea: localStorage
            });
            window.dispatchEvent(storageEvent);
            
            // Redirect to dashboard
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500);
        }

        function removeDiscount() {
            appliedDiscount = null;
            document.getElementById('discount-code').disabled = false;
            document.getElementById('discount-code').value = '';
            document.getElementById('discount-feedback').innerHTML = '';
            document.getElementById('discount-applied').style.display = 'none';
            
            // Show payment form again
            showPaymentFormIfNeeded();
            
            updateCheckoutPrice();
        }

        function updateCheckoutPrice() {
            const selectedPlan = localStorage.getItem('selectedPlan');
            const priceElement = document.getElementById('checkout-plan-price');
            
            if (!selectedPlan || !priceElement) return;

            const planPrices = {
                'trial': { price: 0, display: '¬£0 (7-day trial)' },
                'premium': { price: 1.50, display: '¬£1.50/month' },
                'family': { price: 3.50, display: '¬£3.50/month' },
                'tutor': { price: 5.99, display: '¬£5.99/month' },
                'genius': { price: 9.99, display: '¬£9.99/month' },
                'school': { price: 12.50, display: '¬£12.50/month' }
            };

            const originalPrice = planPrices[selectedPlan]?.price || 0;
            
            if (appliedDiscount && originalPrice > 0) {
                const discountAmount = (originalPrice * appliedDiscount.discount) / 100;
                const finalPrice = originalPrice - discountAmount;
                
                if (appliedDiscount.discount === 100) {
                    priceElement.innerHTML = `<span style="text-decoration: line-through; color: #999;">¬£${originalPrice.toFixed(2)}</span> <span style="color: #28a745; font-weight: bold;">FREE!</span>`;
                } else {
                    priceElement.innerHTML = `<span style="text-decoration: line-through; color: #999;">¬£${originalPrice.toFixed(2)}</span> ¬£${finalPrice.toFixed(2)}/month`;
                }
            } else {
                priceElement.textContent = planPrices[selectedPlan]?.display || '¬£0';
            }
        }

        // Cancel subscription function
        function cancelPlan() {
            const currentPlan = localStorage.getItem('subscriptionPlan') || 'free';
            const isTrialUser = localStorage.getItem('isTrialUser') === 'true';
            
            if (currentPlan === 'free') {
                alert('You are already on the free plan.');
                return;
            }

            const confirmMessage = isTrialUser 
                ? 'Are you sure you want to cancel your free trial? You will immediately lose access to premium features.'
                : 'Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your current billing period.';
            
            if (confirm(confirmMessage)) {
                if (isTrialUser) {
                    // Immediate cancellation for trial users
                    localStorage.removeItem('isTrialUser');
                    localStorage.removeItem('trialStartDate');
                    localStorage.removeItem('trialEndDate');
                    localStorage.setItem('subscriptionPlan', 'free');
                    localStorage.setItem('hasUsedTrial', 'true');
                    
                    alert('‚úÖ Your free trial has been cancelled. You now have access to the free plan features.');
                } else {
                    // Mark subscription for cancellation at end of billing period
                    localStorage.setItem('subscriptionPlan', 'free');
                    localStorage.setItem('subscriptionCancelled', 'true');
                    localStorage.setItem('cancellationDate', new Date().toISOString());
                    
                    alert('‚úÖ Your subscription has been cancelled. You will continue to have access to premium features until the end of your current billing period.');
                }
                
                // Refresh the billing page
                location.reload();
            }
        }
    </script>
</body>
</html>
