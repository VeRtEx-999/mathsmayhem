<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathsMayhem - Maths Website for Kids</title>
    <link rel="stylesheet" href="quiz-bigger.css">
    <style>
        .mathsmayhem-gradient-title {
            background: linear-gradient(90deg, #E81123 0%, #FFF100 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            text-shadow: none !important;
        }
        body {
            font-family: 'Comic Sans MS', 'Comic Sans', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-size: 1.35em;
            background: linear-gradient(120deg, #8929ad 10%, #436aac 50%, #43b788 100%);
            width: 100vw;
            min-height: 100vh;
            background-attachment: fixed;
            background-size: cover;
        }
        .container {
            background: transparent;
            width: 100vw;
            min-height: 0;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            border: none;
            padding: 0;
            position: relative;
            z-index: 4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container .page {
            background: transparent;
            border-radius: 12px;
            box-shadow: none;
            padding: 0;
        }
        .logo-box {
           background: transparent;
            border: none;
            box-shadow: none;
            margin-bottom: 4px;
            padding: 0;
        }
        .logo {
            color: #ff00ea;
            text-shadow: none;
        }
        .nav {
            background: transparent;
            border-radius: 12px;
            border: none;
            box-shadow: none;
            margin-bottom: 10px;
        }
        .nav-tab {
            background: linear-gradient(90deg, #17e3c1 0%, #308695 100%);
            border: none;
            color: #fff;
            text-shadow: none;
        }
        .nav-tab.active, .nav-tab:hover {
            background: linear-gradient(90deg, #308695 0%, #17e3c1 100%);
            color: #fff;
        }
     @keyframes borderMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            padding: 18px 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 95%;
            max-width: 1400px;
            position: relative;
            z-index: 10;
            margin: 0 auto 40px auto;
        }
        
        .nav-section {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px 20px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .nav-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        
        .nav-section-title {
            margin: 0 0 12px 0;
            font-size: 1.1rem;
            color: #ffffff;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
        }
        
        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }
        
        .nav-tab { 
            background: linear-gradient(90deg, #17e3c1 0%, #308695 100%); 
            border: none; 
            font-size: 0.75em; 
            margin: 0; 
            padding: 6px 8px; 
            border-radius: 10px; 
            cursor: pointer; 
            color: #fff; 
            font-weight: bold; 
            box-shadow: 0 3px 10px rgba(23, 227, 193, 0.2); 
            transition: all 0.3s ease; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            position: relative; 
            z-index: 15; 
            pointer-events: auto;
            flex: 1;
            min-width: 100px;
            max-width: 140px;
            text-align: center;
            word-wrap: break-word;
            hyphens: auto;
            line-height: 1.1;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: normal;
            overflow: hidden;
            height: 40px;
        }
        
        .nav-tab.active, .nav-tab:hover { 
            background: linear-gradient(90deg, #308695 0%, #17e3c1 100%); 
            color: #fff; 
            transform: translateY(-2px) scale(1.02); 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 6px 15px rgba(48, 134, 149, 0.3);
        }
        
        .premium-btn {
            background: linear-gradient(90deg, #ff6b6b 0%, #fcb045 100%) !important;
            color: #fff !important;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3) !important;
            position: relative;
            overflow: hidden;
            max-width: 150px !important;
            min-width: 100px !important;
        }
        
        .premium-btn:hover {
            background: linear-gradient(90deg, #fcb045 0%, #ff6b6b 100%) !important;
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.4) !important;
        }
        
        .premium-feature-btn {
            background: linear-gradient(90deg, #10c168 0%, #17e3c1 100%) !important;
            color: #fff !important;
            box-shadow: 0 3px 10px rgba(16, 193, 104, 0.3) !important;
            position: relative;
            overflow: hidden;
        }
        
        .premium-feature-btn:hover {
            background: linear-gradient(90deg, #17e3c1 0%, #10c168 100%) !important;
            box-shadow: 0 6px 15px rgba(16, 193, 104, 0.4) !important;
        }
        
        .ai-tutor-btn {
            background: linear-gradient(90deg, #6f42c1, #8b5cf6);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .ai-tutor-btn:hover {
            background: linear-gradient(90deg, #8b5cf6, #6f42c1);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(111,66,193,0.3);
        }
        
        .genius-btn {
            background: linear-gradient(90deg, #dc3545, #e74c3c);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .genius-btn:hover {
            background: linear-gradient(90deg, #e74c3c, #dc3545);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(220,53,69,0.3);
        }
        
        .premium-shine {
            animation: shine 2s infinite;
        }
        
        @keyframes shine {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .nav {
                grid-template-columns: 1fr;
                padding: 12px 15px;
                gap: 12px;
                width: 90%;
            }
            
            .nav-section {
                padding: 12px 15px;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .nav-tab {
                min-width: auto;
                width: 100%;
                padding: 10px 16px;
            }
        }
        
        /* Wide screen optimization */
        @media (min-width: 1200px) {
            .nav {
                grid-template-columns: 2fr 1fr 1.5fr;
                gap: 25px;
                padding: 20px 35px;
            }
        }
        .logo-box { background: transparent; border: none; border-radius: 32px; box-shadow: none; margin-bottom: 32px; padding: 32px 0 24px 0; text-align: center; }
        .logo { font-size: 3.5em; font-weight: bold; color: #fff; letter-spacing: 2px; text-shadow: 2px 2px 8px #000, 0 2px 8px #000; display: inline-block; }
        .page { display: none; }
        .page.active { display: block; color: #fff; text-shadow: 1px 1px 8px #000; }
        .btn { background: linear-gradient(90deg, #ffb347 0%, #ff69b4 100%); color: #fff; border: none; border-radius: 16px; padding: 12px 28px; font-size: 1.15em; margin: 12px 10px 0 0; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(255, 174, 201, 0.13); transition: background 0.2s, transform 0.15s; }
        .btn {
            background: linear-gradient(90deg, #ffb347 0%, #ff69b4 100%);
            color: #fff;
            border: none;
            border-radius: 16px;
            padding: 12px 28px;
            font-size: 1.15em;
            margin: 12px 10px 0 0;
            cursor: pointer;
            font-weight: bold;
            box-shadow: none;
            transition: background 0.2s, transform 0.15s;
            background-clip: padding-box;
            position: relative;
            z-index: 1;
        }
        .btn:hover { background: linear-gradient(90deg, #1e3a8a 0%, #0a1a4f 100%); transform: scale(1.07) rotate(2deg); }
        .btn:hover {
            background: linear-gradient(90deg, #1e3a8a 0%, #0a1a4f 100%);
            border-image: linear-gradient(90deg, #1e3a8a 0%, #0a1a4f 100%);
            border-image-slice: 1;
        }
        .btn-secondary { background: #d6469f; color: #4ac6ff; border: none; box-shadow: none; }
        .btn-secondary:hover { background: #ffe29f; color: #4ac6ff; border: none; box-shadow: none; }
        .stats { display: flex; gap: 30px; margin: 20px 0 30px 0; flex-wrap: wrap; }
        .stat { background: #ffe29f; border-radius: 18px; padding: 20px 32px; min-width: 120px; text-align: center; box-shadow: 0 2px 12px rgba(255, 174, 201, 0.10); border: 2px dashed #ffb347; }
        .stat-label { color: #4ac6ff; font-size: 1.08em; font-weight: bold; }
        .stat-label { color: #fff; font-size: 1.08em; font-weight: bold; text-shadow: 1px 1px 8px #000; }
        .stat-value { font-size: 1.7em; font-weight: bold; margin-top: 6px; color: #fff; text-shadow: 1px 1px 8px #000; }
        .progress-bar { width: 100%; height: 22px; background: #fff3e6; border-radius: 12px; overflow: hidden; margin: 18px 0 0 0; border: 2px solid #ffb347; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ffb347 0%, #ff69b4 100%); width: 0%; transition: width 0.5s; border-radius: 12px; }
        .quiz-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 22px;
            margin: 30px 0 0 0;
            justify-items: center;
            align-items: stretch;
        }
        .quizzes-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 22px;
            margin: 30px 0 0 0;
            justify-items: center;
            align-items: stretch;
        }
        .quiz-card { flex: 1 1 260px; max-width: 30%; min-width: 220px; box-sizing: border-box; }
        @media (max-width: 900px) {
            .quiz-list {
                grid-template-columns: 1fr;
                grid-template-rows: none;
            }
            .quiz-card { max-width: 90%; }
        }
        @media (max-width: 600px) {
            .quiz-list {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .quiz-card { max-width: 100%; }
        }
        .quiz-card {
            background: linear-gradient(135deg, #E81123 0%, #FFF100 100%);
            border-radius: 22px;
            box-shadow: 0 4px 16px rgba(232, 17, 35, 0.13), 0 2px 8px rgba(255, 241, 0, 0.10);
            padding: 26px 18px;
            flex: 1 1 220px;
            min-width: 220px;
            max-width: 260px;
            text-align: center;
            cursor: pointer;
            border: 2px solid #E81123;
            transition: box-shadow 0.2s, background 0.2s, transform 0.15s, border 0.2s;
        }
        .quiz-card:hover {
            background: linear-gradient(135deg, #FFF100 0%, #E81123 100%);
            box-shadow: 0 8px 24px rgba(255, 241, 0, 0.18), 0 2px 8px rgba(232, 17, 35, 0.10);
            border: 2px solid #FFF100;
            transform: scale(1.05) rotate(-2deg);
        }
        .quiz-card.daily-limit-reached {
            opacity: 0.6;
            position: relative;
        }
        .quiz-card.daily-limit-reached::after {
            content: "üîí Premium";
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(90deg, #ff6b6b, #fcb045);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255,107,107,0.3);
        }
        .quiz-card.daily-limit-reached:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }
        
        .quiz-card.premium-locked {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            opacity: 0.7;
            position: relative;
            cursor: pointer;
        }
        
        .quiz-card.premium-locked::after {
            content: 'üîí PREMIUM';
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(90deg, #ff6b6b, #ffd700);
            color: #000;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: bold;
            text-shadow: none;
        }
        
        .quiz-card.premium-locked:hover {
            transform: translateY(-2px);
            opacity: 0.8;
        }
        
        .quiz-card.ai-tutor-locked {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            opacity: 0.8;
            position: relative;
            cursor: pointer;
        }
        
        .quiz-card.ai-tutor-locked::after {
            content: 'ü§ñ AI TUTOR';
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(90deg, #4a90e2, #357abd);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: bold;
            text-shadow: none;
        }
        
        .quiz-card.ai-tutor-locked:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .quiz-card.genius-locked {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            opacity: 0.8;
            position: relative;
            cursor: pointer;
        }
        
        .quiz-card.genius-locked::after {
            content: 'üß† GENIUS';
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(90deg, #9c27b0, #673ab7);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: bold;
            text-shadow: none;
        }
        
        .quiz-card.genius-locked:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        .quiz-icon { font-size: 2.5em; margin-bottom: 12px; }
        .quiz-title { font-size: 1.25em; font-weight: bold; color: #4ac6ff; text-shadow: 1px 1px 0 #fff3e6; }
        .quiz-title { font-size: 1.25em; font-weight: bold; color: #fff; text-shadow: 1px 1px 8px #000; }
        .quiz-desc { font-size: 1em; color: #fff; margin-top: 8px; font-weight: bold; text-shadow: 1px 1px 8px #000; }
        .difficulty-btn { background: #ffe29f; color: #4ac6ff; border: 2px solid #ffb347; border-radius: 12px; padding: 10px 20px; font-size: 1.08em; margin: 0 10px 12px 0; cursor: pointer; font-weight: bold; transition: background 0.2s, color 0.2s, transform 0.15s; }
        .difficulty-btn.selected, .difficulty-btn:hover { background: #4ac6ff; color: #fff; transform: scale(1.08) rotate(2deg); }
        .quiz-container { background: #fff3e6; border-radius: 22px; box-shadow: 0 4px 16px rgba(255, 174, 201, 0.13); padding: 36px 28px 28px 28px; max-width: 900px; min-width: 520px; min-height: 650px; margin: 0 auto; margin-top: 34px; display: none; position: absolute; left: 0; right: 0; z-index: 10; border: 2px solid #ffb347; }
        .quiz-container.active { display: block; }
        .question { font-size: 1.35em; margin-bottom: 20px; color: #8929ad !important; font-weight: bold; text-shadow: none !important; }
        #quiz .question, #quiz input, #quiz .feedback, #quiz h2, #quiz .quiz-meta, #quiz label, #quiz .quiz-title, #quiz .quiz-desc {
            text-shadow: none !important;
        }
        #quiz .quiz-meta {
            color: #4ac6ff !important;
        }
        #quiz input {
            color: #8929ad !important;
        }
        #quiz .feedback.correct, #quiz .feedback.incorrect {
            text-shadow: none !important;
        }
        .input-container { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .input-container input { font-size: 1.15em; padding: 10px 14px; border-radius: 10px; border: 2px solid #ffb347; width: 130px; background: #fffbe7; color: #8929ad !important; font-weight: bold; text-shadow: none !important; }
        .feedback { font-size: 1.15em; margin-top: 12px; min-height: 28px; color: #4ac6ff; font-weight: bold; }
        .feedback { font-size: 1.15em; margin-top: 12px; min-height: 28px; color: #fff; font-weight: bold; text-shadow: 1px 1px 8px #000; }
        .feedback.correct { color: #55ff00; animation: bounce 0.7s; text-shadow: 1px 1px 8px #55ff00 ; }
        .feedback.incorrect { color: #ff0000; animation: shake 0.7s; text-shadow: 1px 1px 8px #ff0000; }
        @keyframes bounce { 0% { transform: scale(1); } 30% { transform: scale(1.15); } 60% { transform: scale(0.95); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translateX(0); } 20% { transform: translateX(-8px); } 40% { transform: translateX(8px); } 60% { transform: translateX(-8px); } 80% { transform: translateX(8px); } 100% { transform: translateX(0); } }
        .achievements-list { display: flex; flex-wrap: wrap; gap: 22px; margin-top: 22px; }
        .achievement {
            background: #ffe29f;
            border-radius: 22px;
            padding: 32px 20px;
            min-width: 290px;
            max-width: 290px;
            min-height: 220px;
            max-height: 220px;
            text-align: center;
            box-shadow: 0 2px 18px rgba(255, 174, 201, 0.15);
            font-size: 1.22em;
            border: 2.5px dashed #ffb347;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            word-break: break-word;
            overflow: hidden;
        }
        .achievement.locked { opacity: 0.5; }
        .achievement.premium-locked-achievement { 
            opacity: 0.6; 
            border: 2px dashed #ff6b6b; 
            background: linear-gradient(135deg, #ffe29f 0%, #ffb347 50%, #ff6b6b 100%);
        }
        .achievement-icon { font-size: 2.2em; margin-bottom: 8px; }
        .achievement-name { font-weight: bold; margin-bottom: 4px; }
        .achievement-name { font-weight: bold; margin-bottom: 4px; color: #fff; text-shadow: 0px 0px 0px #000; }
        .achievement-description { font-size: 0.95em; word-break: break-word; color: #fff; text-shadow: 0px 0px 0px #000; }
        .upgrade-badge {
            background: linear-gradient(90deg, #ff6b6b, #fcb045);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 8px;
            display: inline-block;
        }
        .lesson-step { background: #fff3e6; border-radius: 14px; padding: 20px 18px; margin-bottom: 20px; border: 2px solid #ffb347; color: #10c168 !important; text-shadow: none !important; }
        .lesson-step h3 { margin: 0 0 10px 0; color: #10c168 !important; font-weight: bold; text-shadow: none !important; }
        .lesson-step .example { background: #ffe29f; border-radius: 10px; padding: 12px 14px; margin-top: 10px; color: #10c168 !important; font-size: 1.05em; font-weight: bold; text-shadow: none !important; }
        #celebration { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 1000; align-items: center; justify-content: center; flex-direction: column; }
        #celebrationMessage { font-size: 2em; color: #4a90e2; margin-bottom: 20px; }
        #celebrationMessage { font-size: 2em; color: #fff; margin-bottom: 20px; text-shadow: 1px 1px 8px #000; }
        #closeCelebration { background: #4a90e2; color: #fff; border: none; border-radius: 8px; padding: 10px 24px; font-size: 1.1em; cursor: pointer; }
        @media (max-width: 700px) { .container { padding: 12px 2vw 24px 2vw; } .stats { flex-direction: column; gap: 10px; } .quiz-list { flex-direction: column; gap: 10px; } }
        /* Floating math emoji background */
        .floating-emoji-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 3;
        }
        .floating-emoji {
            position: absolute;
            font-size: 2.8em;
            opacity: 0.44;
            pointer-events: auto;
            transition: transform 0.3s cubic-bezier(.4,2,.6,1), opacity 0.2s;
            will-change: transform;
            user-select: none;
            cursor: pointer;
        }
        .floating-emoji:hover {
            opacity: 1;
            transform: translateY(-30px) scale(1.2) rotate(-8deg);
            z-index: 2;
        }
        /* Keyframes for up and down floating */
        @keyframes floatUpDown {
            0% { transform: translateY(0); }
            50% { transform: translateY(-22px); }
            100% { transform: translateY(0); }
        }
        /* Each emoji gets a different duration and delay for natural effect */
        .floating-emoji.e1 { left: 8vw; top: 12vh; animation: floatUpDown 3.2s ease-in-out infinite; animation-delay: 0s; }
        .floating-emoji.e2 { left: 22vw; top: 60vh; animation: floatUpDown 2.7s ease-in-out infinite; animation-delay: 0.7s; }
        .floating-emoji.e3 { left: 40vw; top: 30vh; animation: floatUpDown 3.7s ease-in-out infinite; animation-delay: 1.2s; }
        .floating-emoji.e4 { left: 65vw; top: 18vh; animation: floatUpDown 2.9s ease-in-out infinite; animation-delay: 0.3s; }
        .floating-emoji.e5 { left: 80vw; top: 55vh; animation: floatUpDown 3.5s ease-in-out infinite; animation-delay: 1.1s; }
        .floating-emoji.e6 { left: 90vw; top: 15vh; animation: floatUpDown 2.5s ease-in-out infinite; animation-delay: 0.9s; }
        .floating-emoji.e7 { left: 5vw; top: 80vh; animation: floatUpDown 3.9s ease-in-out infinite; animation-delay: 1.5s; }
        .floating-emoji.e8 { left: 30vw; top: 10vh; animation: floatUpDown 3.1s ease-in-out infinite; animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="confetti-bg"></div>
    <div class="floating-emoji-bg">
        <span class="floating-emoji e1">‚ûï</span>
        <span class="floating-emoji e2">‚ûñ</span>
        <span class="floating-emoji e3">‚úñÔ∏è</span>
        <span class="floating-emoji e4">‚ûó</span>
        <span class="floating-emoji e5">üßÆ</span>
        <span class="floating-emoji e6">üìê</span>
        <span class="floating-emoji e7">üî¢</span>
        <span class="floating-emoji e8">üïê</span>
    </div>
    <div class="container">
        <div class="logo-box">
            <img src="logo.png" alt="Logo" style="width:640px; height:auto; display:block; margin:0 auto 16px auto; border-radius:64px; box-shadow:0 4px 32px #4ac6ff33;">
        </div>
        <div class="nav">
            <!-- Main Navigation Section -->
            <div class="nav-section main-nav">
                <h3 class="nav-section-title">üéØ Navigate</h3>
                <div class="nav-buttons">
                    <button class="nav-tab active" onclick="showPage('home')">üè† Home</button>
                    <button class="nav-tab" onclick="showPage('quizzes')">üìù Quizzes</button>
                    <button class="nav-tab" onclick="showPage('lessons')">üìö Lessons</button>
                    <button class="nav-tab" onclick="showPage('achievements')">üèÖ Awards</button>
                </div>
            </div>
            
            <!-- Premium Section -->
            <div class="nav-section premium-nav">
                <h3 class="nav-section-title">‚≠ê Premium</h3>
                
                <!-- Trial Status Display -->
                <div id="trial-status" style="display: none; background: linear-gradient(90deg, #10c168, #48bb78); color: white; padding: 10px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-size: 0.9rem; font-weight: bold;">
                    üéÅ Free Trial: <span id="trial-days-left"></span> days left
                </div>
                
                <div class="nav-buttons">
                    <button class="nav-tab premium-btn" onclick="window.location.href='subscription.html'">
                        <span class="premium-shine">‚ú®</span> Upgrade
                    </button>
                    <button class="nav-tab" onclick="window.location.href='billing.html'" id="billingBtn" style="display:none;">
                        üí≥ Billing
                    </button>
                    <button class="nav-tab" onclick="showSubscriptionStatus()" id="statusBtn" style="display:none;">
                        üìã My Plan
                    </button>
                    
                    <!-- Premium+ Features -->
                    <button class="nav-tab premium-feature-btn" onclick="openPremiumFeature('themes.html')" id="themesBtn" style="display:none;">
                        üé® Custom Themes
                    </button>
                    
                    <!-- Family Features -->
                    <button class="nav-tab premium-feature-btn" onclick="openPremiumFeature('family-dashboard.html')" id="familyBtn" style="display:none;">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Dashboard
                    </button>
                    
                    <!-- Pro Tutor Features -->
                    <button class="nav-tab premium-feature-btn" onclick="openPremiumFeature('study-plans.html')" id="studyPlansBtn" style="display:none;">
                        üìã Study Plans
                    </button>
                    <button class="nav-tab premium-feature-btn" onclick="openPremiumFeature('homework-helper.html')" id="homeworkBtn" style="display:none;">
                        üéí Homework Helper
                    </button>
                    
                    <!-- Math Genius Features -->
                    <button class="nav-tab premium-feature-btn" onclick="openPremiumFeature('competition-prep.html')" id="competitionBtn" style="display:none;">
                        üèÜ Competition Prep
                    </button>
                    
                    <!-- Schools Features -->
                    <button class="nav-tab premium-feature-btn" onclick="openPremiumFeature('teacher-dashboard.html')" id="teacherBtn" style="display:none;">
                        üè´ Teacher Dashboard
                    </button>
                    
                    <!-- Pro Tutor Features -->
                    <button class="nav-tab ai-tutor-btn" onclick="handleAITutorQuiz('ai-tutoring')" id="aiTutoringBtn" style="display:none;">
                        ü§ñ AI Tutoring
                    </button>
                    
                    <!-- Genius Plan Features -->
                    <button class="nav-tab genius-btn" onclick="handleGeniusFeature('university-content')" id="universityBtn" style="display:none;">
                        üéì University Content
                    </button>
                    
                    <button class="nav-tab genius-btn" onclick="handleGeniusFeature('math-olympics')" id="mathOlympicsBtn" style="display:none;">
                        ü•á Math Olympics
                    </button>
                    
                    <button class="nav-tab genius-btn" onclick="handleGeniusFeature('academic-writing')" id="academicWritingBtn" style="display:none;">
                        ‚úçÔ∏è Academic Writing
                    </button>
                    
                    <button class="nav-tab genius-btn" onclick="handleGeniusFeature('research-projects')" id="researchBtn" style="display:none;">
                        üî¨ Research Projects
                    </button>
                    
                    <!-- Analytics (All Premium Plans) -->
                    <button class="nav-tab premium-feature-btn" onclick="openPremiumFeature('analytics.html')" id="analyticsBtn" style="display:none;">
                        üìä Analytics
                    </button>
                </div>
            </div>
            
            <!-- Account Section -->
            <div class="nav-section account-nav">
                <h3 class="nav-section-title">üë§ Account</h3>
                <div class="nav-buttons">
                    <button class="nav-tab" onclick="window.location.href='login.html'" id="loginBtn">üîë Login</button>
                    <button class="nav-tab" onclick="window.location.href='register.html'" id="registerBtn">üìù Register</button>
                    <button class="nav-tab" onclick="safeLogout()" id="logoutBtn" style="display:none;">üö™ Logout</button>
                </div>
            </div>
        </div>
        <div id="home" class="page active">
        <h1 class="mathsmayhem-gradient-title" style="font-size:3em;">üéâ Welcome to MathsMayhem! üéâ</h1>
            <p style="font-size:1.3em; color:#e1e8ec; font-weight:bold;">Sharpen your math skills with <span style="font-size:1.2em; color:#e1e8ec;">üé≤ fun quizzes</span>, <span style="font-size:1.2em; color:#e1e8ec;">üß© interactive lessons</span>, and <span style="font-size:1.2em; color:#e1e8ec;">üèÖ awesome achievements</span>.<br>Ready to become a <span style="color:#e1e8ec;">Math Master</span>? <span style="font-size:1.3em; color:#e1e8ec;">‚ú®</span></p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Total Score</div>
                    <div class="stat-value" id="totalScore">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Current Streak</div>
                    <div class="stat-value" id="currentStreak">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Questions Answered</div>
                    <div class="stat-value" id="questionsAnswered">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Achievements</div>
                    <div class="stat-value" id="achievementsCount">0</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        <div id="quizzes" class="page">
            <h2 style="color:#4ac6ff; font-size:2em;">üìù Choose a Quiz! üìù</h2>
            <div class="quiz-count-display" style="text-align: center; margin-bottom: 20px; font-size: 1.1rem;"></div>
            <div class="quizzes-list">
                <div class="quiz-card" onclick="startQuiz('addition')">
                    <div class="quiz-icon">‚ûï</div>
                    <div class="quiz-title">Addition Adventure</div>
                    <div class="quiz-desc">Practice adding numbers</div>
                </div>
                <div class="quiz-card" onclick="startQuiz('subtraction')">
                    <div class="quiz-icon">‚ûñ</div>
                    <div class="quiz-title">Subtraction Safari</div>
                    <div class="quiz-desc">Sharpen your subtraction skills</div>
                </div>
                <div class="quiz-card" onclick="startQuiz('multiplication')">
                    <div class="quiz-icon">‚úñÔ∏è</div>
                    <div class="quiz-title">Multiplication Quest</div>
                    <div class="quiz-desc">Master multiplication facts</div>
                </div>
                <div class="quiz-card" onclick="startQuiz('division')">
                    <div class="quiz-icon">‚ûó</div>
                    <div class="quiz-title">Division Castle</div>
                    <div class="quiz-desc">Conquer division problems</div>
                </div>
                <div class="quiz-card" onclick="startQuiz('mixed')">
                    <div class="quiz-icon">üåü</div>
                    <div class="quiz-title">Mixed Math Mayhem</div>
                    <div class="quiz-desc">A mix of all operations</div>
                </div>
                <div class="quiz-card" onclick="startQuiz('comparison')">
                    <div class="quiz-icon">‚öñÔ∏è</div>
                    <div class="quiz-title">Number Detective</div>
                    <div class="quiz-desc">Compare numbers</div>
                </div>
                <div class="quiz-card premium-locked" onclick="handlePremiumQuiz('fractions')">
                    <div class="quiz-icon">üçï</div>
                    <div class="quiz-title">Fraction Pizza Party</div>
                    <div class="quiz-desc">Learn about fractions</div>
                </div>
                <div class="quiz-card premium-locked" onclick="handlePremiumQuiz('patterns')">
                    <div class="quiz-icon">üé®</div>
                    <div class="quiz-title">Pattern Master</div>
                    <div class="quiz-desc">Find number patterns</div>
                </div>
                <div class="quiz-card premium-locked" onclick="handlePremiumQuiz('wordproblems')">
                    <div class="quiz-icon">üìñ</div>
                    <div class="quiz-title">Story Math Heroes</div>
                    <div class="quiz-desc">Solve word problems</div>
                </div>
                <div class="quiz-card ai-tutor-locked" onclick="handleAITutorQuiz('algebra')">
                    <div class="quiz-icon">ü§ñ</div>
                    <div class="quiz-title">AI Algebra Tutor</div>
                    <div class="quiz-desc">Personal AI math tutor</div>
                </div>
                <div class="quiz-card ai-tutor-locked" onclick="handleAITutorQuiz('geometry')">
                    <div class="quiz-icon">üìê</div>
                    <div class="quiz-title">AI Geometry Guide</div>
                    <div class="quiz-desc">Step-by-step solutions</div>
                </div>
                <div class="quiz-card genius-locked" onclick="handleGeniusFeature('advanced-calc')">
                    <div class="quiz-icon">üßÆ</div>
                    <div class="quiz-title">Advanced Calculator</div>
                    <div class="quiz-desc">Scientific calculations</div>
                </div>
            </div>
        </div>
        <div id="quizSetup" class="page">
            <h2 id="quizTitle" style="color:#4ac6ff; font-size:2em;">üõ†Ô∏è quiz Setup üõ†Ô∏è</h2>
            <div style="margin:18px 0 10px 0;">
                <span style="font-weight:bold; color:#4ac6ff;">Select Difficulty:</span>
                <button class="difficulty-btn" data-type="difficulty" onclick="selectDifficulty('easy', event)">Easy</button>
                <button class="difficulty-btn" data-type="difficulty" onclick="selectDifficulty('medium', event)">Medium</button>
                <button class="difficulty-btn" data-type="difficulty" onclick="selectDifficulty('hard', event)">Hard</button>
            </div>
            <div style="margin:10px 0 18px 0;">
                <span style="font-weight:bold; color:#4ac6ff;">Number of Questions:</span>
                <button class="difficulty-btn" data-type="questioncount" onclick="selectQuestionCount(5, event)">5</button>
                <button class="difficulty-btn" data-type="questioncount" onclick="selectQuestionCount(10, event)">10</button>
                <button class="difficulty-btn" data-type="questioncount" onclick="selectQuestionCount(20, event)">20</button>
                <button class="difficulty-btn" data-type="questioncount" onclick="selectQuestionCount(50, event)">50</button>
            </div>
            <button class="btn" id="startquizBtn" style="display:none;" onclick="beginQuiz()">Start Quiz</button>
            <button class="btn btn-secondary" onclick="showPage('quiz')">Back</button>
        </div>
        <div id="quiz" class="page">
            <div class="quiz-container" id="quizContainer">
            <div class="quiz-unibox">
                <div style="display:flex; justify-content:flex-end; align-items:center; margin-bottom:8px;">
                    <button id="quizFontInc" title="Increase Quiz Size" style="font-size:1.2em; margin-right:6px; border:none; background:linear-gradient(90deg,#ffb347,#ff69b4); color:#fff; border-radius:8px; padding:4px 12px; cursor:pointer; font-weight:bold;">A+</button>
                    <button id="quizFontDec" title="Decrease Quiz Size" style="font-size:1.2em; border:none; background:linear-gradient(90deg,#ffb347,#ff69b4); color:#fff; border-radius:8px; padding:4px 12px; cursor:pointer; font-weight:bold;">A-</button>
                </div>
                <div class="quiz-unibox-inner" id="quizFontArea">
                    <h2 id="quizTitle" style="color:#4ac6ff; font-size:2em; margin-bottom:8px; text-align:center;">üìù Quiz Time! üìù</h2>
                    <div class="quiz-meta" style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>Question <span id="currentQuestion">1</span> of <span id="totalQuestions">5</span></span>
                        <span>Streak: <span id="streakDisplay">0</span></span>
                    </div>
                    <div class="question" id="questionDisplay" style="margin-bottom:12px; text-align:center;">Question will appear here</div>
                    <input type="text" id="answerInput" autocomplete="off" placeholder="Your answer" style="width:100%; font-size:1.25em; margin-bottom:12px; border-radius:0px; border:2px solid #ffb347; background:#fffbe7; color:#fff; font-weight:bold; text-shadow:0px 0px 0px #000;">
                    <div id="quizButtons" style="display:flex; gap:18px; width:100%; margin-bottom:12px;">
                        <button class="btn" style="flex:1;" onclick="checkAnswer()">Submit</button>
                        <button class="btn" style="flex:1;" onclick="skipQuestion()">Skip</button>
                    </div>
                    <div class="feedback" id="feedback" style="width:100%; text-align:center;"></div>
                    <div id="quizControls" style="margin-top:18px; display:none; width:100%; display:flex; gap:18px;">
                        <button class="btn" style="flex:1;" onclick="showPage('quizetup')">Play Again</button>
                        <button class="btn" style="flex:1;" onclick="showPage('home')">Home</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
        <div id="lessons" class="page">
            <h2 style="color:#4ac6ff; font-size:2em;">üß© Lessons üß©</h2>
            <div class="quiz-list">
                <div class="quiz-card" onclick="showLesson('addition')">
                    <div class="quiz-icon">‚ûï</div>
                    <div class="quiz-title">Addition</div>
                </div>
                <div class="quiz-card" onclick="showLesson('subtraction')">
                    <div class="quiz-icon">‚ûñ</div>
                    <div class="quiz-title">Subtraction</div>
                </div>
                <div class="quiz-card premium-locked" onclick="handlePremiumLesson('multiplication')">
                    <div class="quiz-icon">‚úñÔ∏è</div>
                    <div class="quiz-title">Multiplication</div>
                </div>
                <div class="quiz-card" onclick="showLesson('division')">
                    <div class="quiz-icon">‚ûó</div>
                    <div class="quiz-title">Division</div>
                </div>
                <div class="quiz-card premium-locked" onclick="handlePremiumLesson('fractions')">
                    <div class="quiz-icon">üçï</div>
                    <div class="quiz-title">Fractions</div>
                </div>
                <div class="quiz-card premium-locked" onclick="handlePremiumLesson('patterns')">
                    <div class="quiz-icon">üé®</div>
                    <div class="quiz-title">Patterns</div>
                </div>
            </div>
        </div>
        <div id="lessonContent" class="page">
            <div id="lessonSteps"></div>
            <button class="btn" id="practiceBtn" style="display:none;">üéØ Practice This!</button>
            <!-- Back button only shown on quiz page -->
        </div>
        <div id="achievements" class="page">
            <h2 style="color:#4ac6ff; font-size:2em;">üèÖ Achievements üèÖ</h2>
            <p style="font-size:1.2em; color:#4ac6ff;">Unlock achievements by completing challenges and reaching milestones!</p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Total Achievements</div>
                    <div class="stat-value" id="totalAchievements">0</div>
                </div>
            </div>
            <p style="font-size:1.15em; color:#4ac6ff;">Achievements are unlocked by completing specific challenges and reaching milestones in your math journey. Keep playing to discover new achievements!</p>
            <div style="margin:20px 0; font-size:
1.15em; color:#4ac6ff; font-weight:bold;">Your Achievements:</div>
            <div id="achievementMessage" style="margin-bottom:20px; color:#4ac6ff; font-weight:bold;"></div>
            <button class="btn" id="resetAchievementsBtn" style="display:none;" onclick="resetAchievements()">Reset Achievements</button>
            <button class="btn btn-secondary" onclick="showPage('home')">Back to Home</button>
            <div id="achievementList" style="margin-top:20px; font-size:1.15em; color:#4ac6ff; font-weight:bold;">Achievements List:</div>
            <div class="achievements-list" id="achievementsList"></div>
        </div>
    </div>
    <div id="celebration" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.95); z-index:1000; align-items:center; justify-content:center; flex-direction:column;">
        <div id="celebrationMessage" style="font-size:2em; color:#4a90e2; margin-bottom:20px;"></div>
        <button id="closeCelebration" onclick="hideCelebration()">Close</button>
    </div>
    <!-- Add Logout Button to Navigation (hidden by default) -->
    <button class="nav-tab" onclick="safeLogout()" id="logoutBtn" style="display:none;position:absolute;top:16px;right:16px;z-index:200;">üö™ Logout</button>
    <script>
        // Make Back button on quiz page work
        document.addEventListener('DOMContentLoaded', function() {
            // Move Back button to quiz page if not already there
            var quizPage = document.getElementById('quiz');
            var quizBackBtn = document.getElementById('quizBackBtn');
            if (!quizBackBtn && quizPage) {
                quizBackBtn = document.createElement('button');
                quizBackBtn.className = 'btn btn-secondary';
                quizBackBtn.id = 'quizBackBtn';
                quizBackBtn.textContent = 'üîô Back to Quizzes';
                quizPage.appendChild(quizBackBtn);
            }
            if (quizBackBtn) {
                quizBackBtn.onclick = function() {
                    showPage('quizzes');
                };
            }
        });
        // Make 'Practice This!' button work for lessons (improved reliability)
        (function() {
            const lessonToQuiz = {
                addition: 'addition',
                subtraction: 'subtraction',
                multiplication: 'multiplication',
                division: 'division',
                fractions: 'fractions',
                patterns: 'patterns'
            };
            let lastLessonType = null;

            // Always show the button for mapped lessons
            function showPracticeBtn(type) {
                const btn = document.getElementById('practiceBtn');
                if (lessonToQuiz[type]) {
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            }

            // Listen for lesson card clicks to track lesson type
            document.querySelectorAll('.quiz-list .quiz-card').forEach(card => {
                card.addEventListener('click', function() {
                    const type = card.getAttribute('onclick')?.match(/showLesson\('([a-z]+)'\)/)?.[1];
                    if (type) {
                        lastLessonType = type;
                        showPracticeBtn(type);
                    }
                });
            });

            // Patch showLesson if it exists
            if (typeof window.showLesson === 'function') {
                const origShowLesson = window.showLesson;
                window.showLesson = function(type) {
                    lastLessonType = type;
                    showPracticeBtn(type);
                    return origShowLesson.apply(this, arguments);
                };
            }

            // Practice button click handler
            document.getElementById('practiceBtn').onclick = function() {
                let type = lastLessonType;
                // Fallback: scan for visible lesson title text
                if (!type) {
                    const lessonTitle = document.querySelector('#lessonContent h2, #lessonContent h1, #lessonContent .lesson-title');
                    if (lessonTitle) {
                        const text = lessonTitle.textContent.toLowerCase();
                        if (text.includes('addition')) type = 'addition';
                        else if (text.includes('subtraction')) type = 'subtraction';
                        else if (text.includes('multiplication')) type = 'multiplication';
                        else if (text.includes('division')) type = 'division';
                        else if (text.includes('fraction')) type = 'fractions';
                        else if (text.includes('pattern')) type = 'patterns';
                    }
                }
                // Normalize type for fractions/patterns
                if (type === 'fraction') type = 'fractions';
                if (type === 'pattern') type = 'patterns';
                if (type && lessonToQuiz[type]) {
                    startQuiz(lessonToQuiz[type]);
                } else {
                    alert('Could not determine the lesson topic. Please select a lesson again.');
                }
            };
        })();
        // Quiz font size controls
        (function() {
            const quizFontArea = document.getElementById('quizFontArea');
            let quizFontSize = 1.0;
            function setQuizFontSize() {
                if (quizFontArea) quizFontArea.style.fontSize = quizFontSize + 'em';
            }
            document.getElementById('quizFontInc').onclick = function() {
                quizFontSize = Math.min(quizFontSize + 0.1, 3.0);
                setQuizFontSize();
            };
            document.getElementById('quizFontDec').onclick = function() {
                quizFontSize = Math.max(quizFontSize - 0.1, 0.3);
                setQuizFontSize();
            };
            setQuizFontSize();
        })();
        // quiz state with additional tracking
        let quiztate = {
            currentquiz: null,
            difficulty: null,
            questionCount: 0,
            currentQuestionIndex: 0,
            score: 0,
            streak: 0,
            maxStreak: 0,
            totalCorrect: 0,
            totalAnswered: 0,
            questions: [],
            attempts: 0,
            currentAnswer: null,
            // Additional tracking for achievements
            perfectQuizzes: [],
            completedQuizzes: 0,
            firstTryCorrect: 0,
            consecutiveFirstTry: 0,
            wrongAnswers: 0,
            quizTypesPlayed: new Set(),
            lessonsRead: new Set(),
            difficultyQuizzes: { easy: 0, medium: 0, hard: 0 },
            startedWithWrongAnswer: false
        };

        // Initialize achievements
        const achievements = [
            // Basic achievements
            { id: 'first_correct', name: 'First Success', icon: 'üåü', description: 'Answer your first question correctly!', unlocked: false },
            { id: 'first_quiz', name: 'Quiz Beginner', icon: 'üéØ', description: 'Complete your first quiz!', unlocked: false },
            
            // Streak achievements
            { id: 'streak_3', name: 'Getting Hot', icon: 'üî•', description: 'Get 3 answers in a row!', unlocked: false },
            { id: 'streak_5', name: 'Hot Streak', icon: 'üî•üî•', description: 'Get 5 answers in a row!', unlocked: false },
            { id: 'streak_10', name: 'Math Master', icon: 'üëë', description: 'Get 10 answers in a row!', unlocked: false },
            { id: 'streak_15', name: 'Unstoppable', icon: '‚ö°', description: 'Get 15 answers in a row!', unlocked: false },
            { id: 'streak_20', name: 'Legend', icon: 'ü¶∏', description: 'Get 20 answers in a row!', unlocked: false },
            { id: 'streak_25', name: 'Superhuman', icon: 'üí´', description: 'Get 25 answers in a row!', unlocked: false },
            
            // Score achievements
            { id: 'score_50', name: 'Half Century', icon: 'üèè', description: 'Score 50 points!', unlocked: false },
            { id: 'score_100', name: 'Century Club', icon: 'üíØ', description: 'Score 100 points!', unlocked: false },
            { id: 'score_250', name: 'Quarter Master', icon: 'üéñÔ∏è', description: 'Score 250 points!', unlocked: false },
            { id: 'score_500', name: 'Half Grand', icon: 'üèÜ', description: 'Score 500 points!', unlocked: false },
            { id: 'score_1000', name: 'Thousand Club', icon: 'üíé', description: 'Score 1000 points!', unlocked: false },
            
            // Premium achievements (only unlockable by premium users)
            { id: 'family_manager', name: 'Family Manager', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', description: 'Set up family dashboard!', unlocked: false, premium: true },
            { id: 'analytics_explorer', name: 'Data Detective', icon: 'üìä', description: 'View your analytics dashboard!', unlocked: false, premium: true },
            { id: 'ai_student', name: 'AI Student', icon: 'ü§ñ', description: 'Ask your first AI tutor question!', unlocked: false, proTutor: true },
            { id: 'genius_calculator', name: 'Calculator Genius', icon: 'üßÆ', description: 'Use the advanced calculator!', unlocked: false, genius: true },
            
            // Subject expert achievements
            { id: 'addition_expert', name: 'Addition Expert', icon: '‚ûï', description: 'Score 80% or higher in Addition!', unlocked: false },
            { id: 'subtraction_expert', name: 'Subtraction Expert', icon: '‚ûñ', description: 'Score 80% or higher in Subtraction!', unlocked: false },
            { id: 'multiplication_expert', name: 'Multiplication Expert', icon: '‚úñÔ∏è', description: 'Score 80% or higher in Multiplication!', unlocked: false },
            { id: 'division_expert', name: 'Division Expert', icon: '‚ûó', description: 'Score 80% or higher in Division!', unlocked: false },
            { id: 'mixed_expert', name: 'Mixed Math Master', icon: 'üåü', description: 'Score 80% or higher in Mixed Math!', unlocked: false },
            { id: 'comparison_expert', name: 'Comparison Champion', icon: '‚öñÔ∏è', description: 'Score 80% or higher in Number Detective!', unlocked: false },
            { id: 'fractions_expert', name: 'Fraction Hero', icon: 'üçï', description: 'Score 80% or higher in Fractions!', unlocked: false, premium: true },
            { id: 'patterns_expert', name: 'Pattern Genius', icon: 'üé®', description: 'Score 80% or higher in Patterns!', unlocked: false, premium: true },
            { id: 'wordproblems_expert', name: 'Story Math Wizard', icon: 'üìñ', description: 'Score 80% or higher in Word Problems!', unlocked: false, premium: true },
            
            // Perfect score achievements
            { id: 'perfect_5', name: 'Perfect Start', icon: '‚≠ê', description: 'Get 100% on a 5-question quiz!', unlocked: false },
            { id: 'perfect_10', name: 'Perfect Ten', icon: 'üåü', description: 'Get 100% on a 10-question quiz!', unlocked: false },
            { id: 'perfect_20', name: 'Perfect Score', icon: '‚ú®', description: 'Get 100% on a 20+ question quiz!', unlocked: false },
            
            // Quantity achievements
            { id: 'questions_25', name: 'Quarter Century', icon: 'üìä', description: 'Answer 25 questions correctly!', unlocked: false },
            { id: 'questions_50', name: 'Half Hundred', icon: 'üìà', description: 'Answer 50 questions correctly!', unlocked: false },
            { id: 'questions_100', name: 'Century Solver', icon: 'üßÆ', description: 'Answer 100 questions correctly!', unlocked: false },
            { id: 'questions_200', name: 'Double Century', icon: 'üéØ', description: 'Answer 200 questions correctly!', unlocked: false },
            { id: 'questions_500', name: 'Math Marathon', icon: 'üèÉ‚Äç‚ôÇÔ∏è', description: 'Answer 500 questions correctly!', unlocked: false },
            
            // Speed achievements
            { id: 'speed_demon', name: 'Speed Demon', icon: 'üí®', description: 'Answer 10 questions correctly in a row on first try!', unlocked: false },
            { id: 'lightning_fast', name: 'Lightning Fast', icon: '‚ö°', description: 'Answer 20 questions correctly in a row on first try!', unlocked: false },
            
            // Difficulty achievements
            { id: 'easy_master', name: 'Easy Master', icon: 'üü¢', description: 'Complete 5 easy quizzes!', unlocked: false },
            { id: 'medium_master', name: 'Medium Master', icon: 'üü°', description: 'Complete 5 medium quizzes!', unlocked: false },
            { id: 'hard_master', name: 'Hard Master', icon: 'üî¥', description: 'Complete 5 hard quizzes!', unlocked: false },
            
            // Endurance achievements
            { id: 'endurance_50', name: 'Endurance Runner', icon: 'üèÉ', description: 'Complete a 50-question quiz!', unlocked: false },
            { id: 'endurance_100', name: 'Math Marathoner', icon: 'üèÉ‚Äç‚ôÄÔ∏è', description: 'Complete a 100-question quiz!', unlocked: false },
            
            // Special achievements
            { id: 'comeback_kid', name: 'Comeback Kid', icon: 'üîÑ', description: 'Score 100% after getting the first question wrong!', unlocked: false },
            { id: 'persistent', name: 'Never Give Up', icon: 'üí™', description: 'Complete a quiz after getting 5 questions wrong!', unlocked: false },
            { id: 'explorer', name: 'Math Explorer', icon: 'üó∫Ô∏è', description: 'Try 5 different quiz types!', unlocked: false },
            { id: 'scholar', name: 'Math Scholar', icon: 'üéì', description: 'Read 4 different lesson types!', unlocked: false },
            { id: 'dedicated', name: 'Dedicated Learner', icon: 'üìö', description: 'Complete 10 total quizzes!', unlocked: false },
            { id: 'champion', name: 'Math Champion', icon: 'ü•á', description: 'Unlock 20 other achievements!', unlocked: false }
        ];

        // Show page function
        function showPage(pageId) {
            // Hide all pages EXCEPT quiz (quiz is positioned absolutely)
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                if (page.id !== 'quiz') {
                    page.classList.remove('active');
                }
            });
            
            // Hide all nav tabs active state
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Handle quiz page specially
            const quizPageEl = document.getElementById('quiz');
            const quizContainerEl = document.getElementById('quizContainer');
            
            if (pageId === 'quiz') {
                // Show quiz page
                if (quizPageEl) quizPageEl.classList.add('active');
            } else {
                // Hide quiz completely when not in use
                if (quizPageEl) quizPageEl.classList.remove('active');
                if (quizContainerEl) quizContainerEl.style.display = 'none';
                
                // Show the selected page
                document.getElementById(pageId).classList.add('active');
            }
            
            // Set active tab - find the tab that was clicked
            const clickedTab = Array.from(tabs).find(tab => 
                tab.textContent.toLowerCase().includes(pageId) || 
                (pageId === 'home' && tab.textContent.includes('Home'))
            );
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Special handling for achievements page
            if (pageId === 'achievements') {
                displayAchievements();
            }
            
            // Special handling for quizzes page - update quiz count display
            if (pageId === 'quizzes') {
                updateQuizCountDisplay();
            }
        }

        // Start quiz function
    function startQuiz(quizType) {
        // Check if user has reached daily limit (only for non-premium users)
        if (!isPremiumUser() && hasReachedDailyLimit()) {
            showPremiumUpgradeModal();
            return;
        }

        quiztate.currentquiz = quizType;
        quiztate.difficulty = null;
        quiztate.questionCount = 0;

        // Update quiz title
        const titles = {
            'addition': 'üéØ Addition Adventure',
            'subtraction': 'ü¶Å Subtraction Safari',
            'multiplication': '‚öîÔ∏è Multiplication Quest',
            'division': 'üè∞ Division Castle',
            'mixed': 'üåü Mixed Math Mayhem',
            'comparison': '‚öñÔ∏è Number Detective',
            'fractions': 'üçï Fraction Pizza Party',
            'patterns': 'üé® Pattern Master',
            'wordproblems': 'üìñ Story Math Heroes'
        };
        document.getElementById('quizTitle').textContent = titles[quizType];

        // Reset selections
        document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('startquizBtn').style.display = 'none';

        showPage('quizSetup');
    }

    // --- Premium System Functions ---
    function isPremiumUser() {
        // First check trial status
        const isTrialUser = localStorage.getItem('isTrialUser') === 'true';
        const trialEndDate = localStorage.getItem('trialEndDate');
        
        // If user is on trial, check if it's still valid
        if (isTrialUser && trialEndDate) {
            const now = new Date();
            const trialEnd = new Date(trialEndDate);
            
            if (now <= trialEnd) {
                console.log('‚úÖ User has active trial access');
                return true;
            } else {
                // Trial expired, clean up trial data but keep user logged in
                console.log('‚ö†Ô∏è Trial expired, reverting to free plan');
                localStorage.removeItem('isTrialUser');
                localStorage.removeItem('trialStartDate');
                localStorage.removeItem('trialEndDate');
                localStorage.setItem('subscriptionPlan', 'free');
                
                // Trigger UI update but DON'T log out the user
                setTimeout(() => updateAuthButtons(), 100);
            }
        }
        
        // Check subscription plan
        const subscriptionPlan = localStorage.getItem('subscriptionPlan');
        const premiumPlans = ['premium', 'family', 'tutor', 'genius', 'school'];
        
        const isPremium = subscriptionPlan && premiumPlans.includes(subscriptionPlan);
        console.log(`üîê Premium access check: Plan=${subscriptionPlan}, IsPremium=${isPremium}`);
        
        return isPremium;
    }

    function isFamilyPlanUser() {
        const subscriptionPlan = localStorage.getItem('subscriptionPlan');
        return subscriptionPlan && (subscriptionPlan === 'family' || subscriptionPlan === 'tutor' || 
               subscriptionPlan === 'genius' || subscriptionPlan === 'school');
    }

    function isAITutorUser() {
        const subscriptionPlan = localStorage.getItem('subscriptionPlan');
        return subscriptionPlan && (subscriptionPlan === 'tutor' || subscriptionPlan === 'genius' || 
               subscriptionPlan === 'school');
    }

    function isGeniusUser() {
        const subscriptionPlan = localStorage.getItem('subscriptionPlan');
        return subscriptionPlan && (subscriptionPlan === 'genius' || subscriptionPlan === 'school');
    }

    function handleAITutorQuiz(quizType) {
        console.log(`ü§ñ Attempting to access AI tutor: ${quizType}`);
        
        // Ensure user is still logged in
        const currentUser = localStorage.getItem('currentUser');
        const isLoggedIn = userManager && userManager.isLoggedIn();
        
        if (!currentUser && !isLoggedIn) {
            console.log('‚ùå User not logged in, redirecting to login');
            alert('Please log in to access AI tutoring features!');
            window.location.href = 'login.html';
            return;
        }
        
        // Check AI tutor access without clearing authentication
        const hasAIAccess = isAITutorUser();
        console.log(`üß† AI tutor access status: ${hasAIAccess}`);
        
        if (hasAIAccess) {
            console.log(`‚úÖ Starting AI tutor session: ${quizType}`);
            startAITutorSession(quizType);
        } else {
            console.log(`üîí No AI tutor access for: ${quizType}`);
            showUpgradeModal('Pro Tutor', 'AI Tutoring features with ChatGPT-powered step-by-step explanations and personalized learning');
        }
    }

    function handlePremiumQuiz(quizType) {
        if (isPremiumUser()) {
            console.log('üéØ Starting premium quiz:', quizType);
            startQuiz(quizType);
        } else {
            showUpgradeModal('Premium', `${quizType.charAt(0).toUpperCase() + quizType.slice(1)} quizzes with advanced problem types and detailed explanations`);
        }
    }

    function handleGeniusFeature(featureType) {
        if (isGeniusUser()) {
            console.log('üß† Opening genius feature:', featureType);
            openGeniusFeature(featureType);
        } else {
            showUpgradeModal('Math Genius', 'Advanced mathematical features for competition prep and university-level content');
        }
    }

    function handleGeniusFeature(featureType) {
        if (isGeniusUser()) {
            switch(featureType) {
                case 'university-content':
                    showUniversityContent();
                    break;
                case 'math-olympics':
                    showMathOlympics();
                    break;
                case 'academic-writing':
                    showAcademicWriting();
                    break;
                case 'research-projects':
                    showResearchProjects();
                    break;
                default:
                    openGeniusFeature(featureType);
            }
        } else {
            showUpgradeModal('Math Genius', 'Advanced mathematical tools and features');
        }
    }
    
    function showUniversityContent() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10000; 
            display: flex; align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="
                background: linear-gradient(145deg, #ffffff, #f0f4f8);
                border-radius: 25px; padding: 40px; max-width: 800px; width: 90%;
                text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-height: 80vh; overflow-y: auto;
            ">
                <div style="font-size: 3rem; margin-bottom: 20px;">üéì</div>
                <h2 style="color: #dc3545; margin-bottom: 15px;">University-Level Mathematics</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <h3 style="color: #4a90e2;">Advanced Topics Available:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div onclick="startAdvancedTopic('calculus')" style="background: #f8f9fa; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #e9ecef;">
                            <strong>üìà Advanced Calculus</strong><br>
                            <small>Multivariable calculus, differential equations</small>
                        </div>
                        <div onclick="startAdvancedTopic('linear-algebra')" style="background: #f8f9fa; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #e9ecef;">
                            <strong>üî¢ Linear Algebra</strong><br>
                            <small>Vector spaces, matrices, eigenvalues</small>
                        </div>
                        <div onclick="startAdvancedTopic('abstract-algebra')" style="background: #f8f9fa; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #e9ecef;">
                            <strong>üéØ Abstract Algebra</strong><br>
                            <small>Groups, rings, fields</small>
                        </div>
                        <div onclick="startAdvancedTopic('real-analysis')" style="background: #f8f9fa; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #e9ecef;">
                            <strong>üìä Real Analysis</strong><br>
                            <small>Limits, continuity, convergence</small>
                        </div>
                        <div onclick="startAdvancedTopic('topology')" style="background: #f8f9fa; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #e9ecef;">
                            <strong>üåê Topology</strong><br>
                            <small>Point-set topology, metric spaces</small>
                        </div>
                        <div onclick="startAdvancedTopic('number-theory')" style="background: #f8f9fa; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #e9ecef;">
                            <strong>üîê Number Theory</strong><br>
                            <small>Prime numbers, modular arithmetic</small>
                        </div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove();" style="
                    background: #dc3545; color: white; border: none; padding: 12px 25px;
                    border-radius: 20px; cursor: pointer; font-size: 1.1rem; font-weight: bold;
                ">Close</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function showMathOlympics() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10000; 
            display: flex; align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="
                background: linear-gradient(145deg, #ffffff, #f0f4f8);
                border-radius: 25px; padding: 40px; max-width: 700px; width: 90%;
                text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            ">
                <div style="font-size: 3rem; margin-bottom: 20px;">ü•á</div>
                <h2 style="color: #dc3545; margin-bottom: 15px;">Math Olympiad Training</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <h3 style="color: #4a90e2;">Competition Categories:</h3>
                    <div style="display: grid; gap: 15px; margin: 20px 0;">
                        <div onclick="startOlympiadTraining('imo')" style="background: #fff3cd; padding: 15px; border-radius: 10px; cursor: pointer; border-left: 4px solid #ffc107;">
                            <strong>üåç International Mathematical Olympiad (IMO)</strong><br>
                            <small>The most prestigious mathematics competition for high school students</small>
                        </div>
                        <div onclick="startOlympiadTraining('usamo')" style="background: #d4edda; padding: 15px; border-radius: 10px; cursor: pointer; border-left: 4px solid #28a745;">
                            <strong>üá∫üá∏ USA Mathematical Olympiad (USAMO)</strong><br>
                            <small>Advanced problem-solving techniques and proofs</small>
                        </div>
                        <div onclick="startOlympiadTraining('aime')" style="background: #cce7ff; padding: 15px; border-radius: 10px; cursor: pointer; border-left: 4px solid #4a90e2;">
                            <strong>üéØ American Invitational Mathematics Examination (AIME)</strong><br>
                            <small>Intermediate-level competition problems</small>
                        </div>
                        <div onclick="startOlympiadTraining('amc')" style="background: #f8d7da; padding: 15px; border-radius: 10px; cursor: pointer; border-left: 4px solid #dc3545;">
                            <strong>üìö AMC 8/10/12 Preparation</strong><br>
                            <small>Foundation building for competition mathematics</small>
                        </div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove();" style="
                    background: #dc3545; color: white; border: none; padding: 12px 25px;
                    border-radius: 20px; cursor: pointer; font-size: 1.1rem; font-weight: bold;
                ">Close</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function showAcademicWriting() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10000; 
            display: flex; align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="
                background: linear-gradient(145deg, #ffffff, #f0f4f8);
                border-radius: 25px; padding: 40px; max-width: 700px; width: 90%;
                text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-height: 80vh; overflow-y: auto;
            ">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚úçÔ∏è</div>
                <h2 style="color: #dc3545; margin-bottom: 15px;">Academic Writing Support</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <h3 style="color: #4a90e2;">Writing Assistance Available:</h3>
                    <div style="display: grid; gap: 12px; margin: 20px 0;">
                        <div onclick="openWritingTool('research-papers')" style="background: #e8f5e8; padding: 12px; border-radius: 8px; cursor: pointer;">
                            <strong>üìÑ Research Paper Writing</strong><br>
                            <small>Structure, methodology, citations, and formatting</small>
                        </div>
                        <div onclick="openWritingTool('thesis-support')" style="background: #e8f5e8; padding: 12px; border-radius: 8px; cursor: pointer;">
                            <strong>üéì Thesis & Dissertation Support</strong><br>
                            <small>Advanced academic writing for graduate students</small>
                        </div>
                        <div onclick="openWritingTool('proof-writing')" style="background: #e8f5e8; padding: 12px; border-radius: 8px; cursor: pointer;">
                            <strong>üîç Mathematical Proof Writing</strong><br>
                            <small>Logic, structure, and formal mathematical writing</small>
                        </div>
                        <div onclick="openWritingTool('academic-proposals')" style="background: #e8f5e8; padding: 12px; border-radius: 8px; cursor: pointer;">
                            <strong>üí° Grant & Research Proposals</strong><br>
                            <small>Funding applications and project proposals</small>
                        </div>
                        <div onclick="openWritingTool('college-applications')" style="background: #e8f5e8; padding: 12px; border-radius: 8px; cursor: pointer;">
                            <strong>üéØ College Application Essays</strong><br>
                            <small>Personal statements and application support</small>
                        </div>
                        <div onclick="openWritingTool('latex-support')" style="background: #e8f5e8; padding: 12px; border-radius: 8px; cursor: pointer;">
                            <strong>üìù LaTeX & Mathematical Typography</strong><br>
                            <small>Professional mathematical document preparation</small>
                        </div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove();" style="
                    background: #dc3545; color: white; border: none; padding: 12px 25px;
                    border-radius: 20px; cursor: pointer; font-size: 1.1rem; font-weight: bold;
                ">Close</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function showResearchProjects() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10000; 
            display: flex; align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="
                background: linear-gradient(145deg, #ffffff, #f0f4f8);
                border-radius: 25px; padding: 40px; max-width: 800px; width: 90%;
                text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-height: 80vh; overflow-y: auto;
            ">
                <div style="font-size: 3rem; margin-bottom: 20px;">üî¨</div>
                <h2 style="color: #dc3545; margin-bottom: 15px;">Research Project Guidance</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <h3 style="color: #4a90e2;">Research Areas & Support:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div onclick="startResearchProject('pure-math')" style="background: #f0f8ff; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #4a90e2;">
                            <strong>üßÆ Pure Mathematics Research</strong><br>
                            <small>Number theory, algebra, analysis, topology</small>
                        </div>
                        <div onclick="startResearchProject('applied-math')" style="background: #f0fff0; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #28a745;">
                            <strong>‚öôÔ∏è Applied Mathematics</strong><br>
                            <small>Mathematical modeling, optimization, statistics</small>
                        </div>
                        <div onclick="startResearchProject('computational')" style="background: #fff8f0; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #ffc107;">
                            <strong>üíª Computational Mathematics</strong><br>
                            <small>Algorithms, numerical analysis, machine learning</small>
                        </div>
                        <div onclick="startResearchProject('interdisciplinary')" style="background: #f8f0ff; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #9b59b6;">
                            <strong>üåê Interdisciplinary Research</strong><br>
                            <small>Math + Physics, Biology, Economics, etc.</small>
                        </div>
                    </div>
                    
                    <h3 style="color: #4a90e2; margin-top: 30px;">Research Support Services:</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>üìã Research proposal development</li>
                            <li>üìö Literature review assistance</li>
                            <li>üîç Methodology design</li>
                            <li>üìä Data analysis support</li>
                            <li>‚úçÔ∏è Academic writing guidance</li>
                            <li>üéØ Publication preparation</li>
                            <li>ü§ù Collaboration opportunities</li>
                            <li>üèÜ Conference presentation support</li>
                        </ul>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove();" style="
                    background: #dc3545; color: white; border: none; padding: 12px 25px;
                    border-radius: 20px; cursor: pointer; font-size: 1.1rem; font-weight: bold;
                ">Close</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function startAITutorSession(quizType) {
        // Create AI Tutor modal
        const modal = `
            <div id="aiTutorModal" style="
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 10000; 
                display: flex; align-items: center; justify-content: center;
            ">
                <div style="
                    background: linear-gradient(145deg, #ffffff, #f0f4f8);
                    border-radius: 25px; padding: 40px; max-width: 700px; width: 90%;
                    text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-height: 80vh; overflow-y: auto;
                ">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ü§ñ</div>
                    <h2 style="color: #4a90e2; margin-bottom: 15px; font-size: 2rem;">AI Math Tutor</h2>
                    <p style="color: #666; font-size: 1.1rem; margin-bottom: 25px;">
                        Hello! I'm your personal AI math tutor powered by ChatGPT. I'll help you solve problems step-by-step!
                    </p>
                    <div id="tutorContent" style="background: #f8f9ff; border-radius: 15px; padding: 20px; margin-bottom: 25px; text-align: left; max-height: 300px; overflow-y: auto;">
                        <p><strong>üéØ What I can help with:</strong></p>
                        <ul style="color: #666; line-height: 1.6; margin: 10px 0; padding-left: 20px;">
                            <li>üìù Step-by-step problem solving</li>
                            <li>üí° Explain mathematical concepts clearly</li>
                            <li>üîç Break down complex problems</li>
                            <li>üìä Visual explanations with examples</li>
                            <li>üé® Interactive learning activities</li>
                            <li>üß† Advanced algebra and geometry</li>
                            <li>üìê Competition math preparation</li>
                        </ul>
                        <div style="background: white; border-radius: 10px; padding: 15px; margin-top: 15px;">
                            <p style="color: #4a90e2; font-weight: bold; margin-bottom: 10px;">Try asking me:</p>
                            <p style="color: #666; margin: 5px 0;">"How do I solve 2x + 5 = 13?"</p>
                            <p style="color: #666; margin: 5px 0;">"Explain fractions to me step by step"</p>
                            <p style="color: #666; margin: 5px 0;">"What's the area of a circle with radius 5?"</p>
                            <p style="color: #666; margin: 5px 0;">"Help me with quadratic equations"</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; text-align: left; margin-bottom: 5px; font-weight: bold; color: #4a90e2;">Difficulty Level:</label>
                        <select id="difficultySelect" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #e0e0e0; margin-bottom: 15px;">
                            <option value="easy">Easy (Ages 6-9)</option>
                            <option value="medium" selected>Medium (Ages 10-13)</option>
                            <option value="hard">Hard (Ages 14+)</option>
                        </select>
                    </div>
                    <textarea id="tutorInput" placeholder="Ask me any math question..." style="
                        width: 100%; height: 80px; padding: 15px; border-radius: 15px;
                        border: 2px solid #e0e0e0; font-size: 1rem; resize: none;
                        margin-bottom: 20px; box-sizing: border-box;
                    "></textarea>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="askButton" onclick="askAITutor()" style="
                            background: linear-gradient(90deg, #4a90e2, #357abd);
                            color: white; border: none; padding: 15px 25px;
                            border-radius: 20px; font-size: 1.1rem; font-weight: bold;
                            cursor: pointer; box-shadow: 0 4px 15px rgba(74,144,226,0.3);
                        ">ü§ñ Ask ChatGPT</button>
                        <button onclick="generatePracticeProblems()" style="
                            background: linear-gradient(90deg, #10c168, #48bb78);
                            color: white; border: none; padding: 15px 25px;
                            border-radius: 20px; font-size: 1.1rem; font-weight: bold;
                            cursor: pointer; box-shadow: 0 4px 15px rgba(16,193,104,0.3);
                        ">üéØ Practice Problems</button>
                        <button onclick="closeAITutorModal()" style="
                            background: #e2e8f0; color: #666; border: none;
                            padding: 15px 25px; border-radius: 20px; font-size: 1.1rem;
                            cursor: pointer;
                        ">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // Set focus on input
        setTimeout(() => {
            document.getElementById('tutorInput').focus();
        }, 100);
        
        // Add enter key listener
        document.getElementById('tutorInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askAITutor();
            }
        });
    }

    async function askAITutor() {
        const input = document.getElementById('tutorInput');
        const difficulty = document.getElementById('difficultySelect').value;
        const askButton = document.getElementById('askButton');
        const tutorContent = document.getElementById('tutorContent');
        
        const question = input.value.trim();
        if (!question) {
            showNotification('Please type a math question first!', 'warning');
            return;
        }
        
        // Unlock AI student achievement on first question
        unlockAchievement('ai_student');
        
        // Show loading state
        askButton.disabled = true;
        askButton.innerHTML = 'üîÑ ChatGPT is thinking...';
        
        // Add user question to chat
        const userMessageHtml = `
            <div style="background: #e3f2fd; border-radius: 10px; padding: 15px; margin: 10px 0; border-left: 4px solid #2196f3;">
                <strong>üßë‚Äçüéì You:</strong> ${escapeHtml(question)}
            </div>
        `;
        tutorContent.insertAdjacentHTML('beforeend', userMessageHtml);
        tutorContent.scrollTop = tutorContent.scrollHeight;
        
        try {
            const response = await fetch('/api/openai-chat.js', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    difficulty: difficulty
                })
            });
            
            if (!response.ok) {
                throw new Error('ChatGPT service temporarily unavailable');
            }
            
            const data = await response.json();
            
            // Add AI response to chat
            const aiMessageHtml = `
                <div style="background: #f0f8ff; border-radius: 10px; padding: 15px; margin: 10px 0; border-left: 4px solid #4a90e2;">
                    <strong>ü§ñ ChatGPT:</strong><br>
                    <div style="margin-top: 10px; line-height: 1.6;">${formatMathResponse(data.response)}</div>
                </div>
            `;
            tutorContent.insertAdjacentHTML('beforeend', aiMessageHtml);
            
        } catch (error) {
            console.error('AI Tutor error:', error);
            
            // Fallback response based on question content
            const fallbackResponse = generateFallbackResponse(question, difficulty);
            const errorMessageHtml = `
                <div style="background: #fff3e0; border-radius: 10px; padding: 15px; margin: 10px 0; border-left: 4px solid #ff9800;">
                    <strong>ü§ñ AI Tutor (Offline Mode):</strong><br>
                    <div style="margin-top: 10px; line-height: 1.6;">${formatMathResponse(fallbackResponse)}</div>
                    <small style="color: #666; display: block; margin-top: 10px;">
                        <em>Note: Using offline mode. ChatGPT will be back online soon!</em>
                    </small>
                </div>
            `;
            tutorContent.insertAdjacentHTML('beforeend', errorMessageHtml);
        }
        
        // Reset input and button
        input.value = '';
        askButton.disabled = false;
        askButton.innerHTML = 'ü§ñ Ask ChatGPT';
        
        // Scroll to bottom
        tutorContent.scrollTop = tutorContent.scrollHeight;
    }

    function closeAITutorModal() {
        const modal = document.getElementById('aiTutorModal');
        if (modal) modal.remove();
    }
    
    function formatMathResponse(response) {
        // Format mathematical expressions and make them more readable
        return response
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">$1</code>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>')
            .replace(/(\d+)\s*([+\-*/=])\s*(\d+)/g, '<span style="font-family: monospace; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">$1 $2 $3</span>');
    }
    
    function generateFallbackResponse(question, difficulty) {
        const lowerQuestion = question.toLowerCase();
        
        // Pattern matching for common math topics
        if (lowerQuestion.includes('fraction') || lowerQuestion.includes('¬Ω') || lowerQuestion.includes('1/')) {
            return `**Understanding Fractions** üçï

Fractions represent parts of a whole! Think of it like pizza slices:

**Step-by-step approach:**
1. **Numerator** (top number) = how many pieces you have
2. **Denominator** (bottom number) = total pieces in the whole

**Example:** 3/4 means you have 3 out of 4 equal pieces.

**Quick tip:** To add fractions, make sure the denominators are the same first!

Try practicing with: 1/2 + 1/4 = ?`;
        }
        
        if (lowerQuestion.includes('algebra') || lowerQuestion.includes('solve') || lowerQuestion.includes('x')) {
            return `**Solving Algebra Problems** üßÆ

Let's solve equations step by step!

**Golden Rule:** Whatever you do to one side, do to the other side.

**Example:** 2x + 5 = 13
1. Subtract 5 from both sides: 2x = 8
2. Divide both sides by 2: x = 4
3. Check: 2(4) + 5 = 13 ‚úì

**Remember:** 
- Isolate the variable (x)
- Work backwards from order of operations
- Always check your answer!`;
        }
        
        if (lowerQuestion.includes('area') || lowerQuestion.includes('circle') || lowerQuestion.includes('rectangle')) {
            return `**Area Formulas** üìê

Here are the essential area formulas:

**Rectangle:** Area = length √ó width
**Circle:** Area = œÄ √ó radius¬≤  (œÄ ‚âà 3.14)
**Triangle:** Area = ¬Ω √ó base √ó height
**Square:** Area = side √ó side

**Pro tip:** Always include units! If measuring in centimeters, your area will be in cm¬≤.

Need help with a specific shape? Just ask!`;
        }
        
        if (lowerQuestion.includes('percent') || lowerQuestion.includes('%')) {
            return `**Working with Percentages** üíØ

Percent means "out of 100"!

**Key conversions:**
- 50% = 50/100 = 0.5 = ¬Ω
- 25% = 25/100 = 0.25 = ¬º
- 10% = 10/100 = 0.1

**To find percentage of a number:**
Example: 20% of 150
Step 1: Convert to decimal: 20% = 0.20
Step 2: Multiply: 0.20 √ó 150 = 30

**Quick tricks:**
- 10% = move decimal one place left
- 50% = divide by 2
- 25% = divide by 4`;
        }
        
        // Generic helpful response
        return `**Let me help you with that math problem! ü§ì**

I'd love to give you a detailed explanation. Here's my approach:

**Step 1:** Break down the problem into smaller parts
**Step 2:** Identify what mathematical concept we're working with  
**Step 3:** Apply the appropriate method or formula
**Step 4:** Check our work

Could you share more details about what specific part you're stuck on? I can provide:
- Step-by-step solutions
- Visual examples  
- Practice problems
- Memory tricks

**Common topics I excel at:**
‚úì Basic arithmetic and word problems
‚úì Fractions, decimals, and percentages  
‚úì Algebra and equation solving
‚úì Geometry and area calculations
‚úì Pre-calculus concepts

Ask me anything specific and I'll break it down for you! üéØ`;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function generatePracticeProblems() {
        const difficulty = document.getElementById('difficultySelect').value;
        const tutorContent = document.getElementById('tutorContent');
        
        let problems = [];
        
        switch(difficulty) {
            case 'easy':
                problems = [
                    "What is 7 + 5?",
                    "If you have 12 apples and eat 4, how many are left?",
                    "What is half of 16?",
                    "Count by 5s: 5, 10, 15, __, __",
                    "Which is bigger: 3/4 or 1/2?"
                ];
                break;
            case 'medium':
                problems = [
                    "Solve: 3x + 7 = 22",
                    "What is 15% of 80?",
                    "Find the area of a rectangle: length=8, width=5",
                    "Simplify: 2/6 + 1/3",
                    "If a triangle has angles 60¬∞ and 70¬∞, what's the third angle?"
                ];
                break;
            case 'hard':
                problems = [
                    "Solve the quadratic: x¬≤ - 5x + 6 = 0",
                    "Find the derivative of: f(x) = 3x¬≤ + 2x - 1",
                    "A circle has circumference 18œÄ. What's its area?",
                    "Solve the system: 2x + y = 7, x - y = 2",
                    "What's the sum of interior angles in a hexagon?"
                ];
                break;
        }
        
        const practiceHtml = `
            <div style="background: #f0f8ff; border-radius: 10px; padding: 20px; margin: 15px 0; border-left: 4px solid #4a90e2;">
                <strong>üéØ Practice Problems (${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Level):</strong><br><br>
                ${problems.map((problem, index) => 
                    `<div style="background: white; border-radius: 8px; padding: 12px; margin: 8px 0; cursor: pointer;" 
                     onclick="document.getElementById('tutorInput').value='${problem.replace(/'/g, "\\'")}'; document.getElementById('tutorInput').focus();">
                        <strong>${index + 1}.</strong> ${problem}
                        <small style="color: #666; display: block; margin-top: 5px;">
                            <em>Click to ask me about this problem!</em>
                        </small>
                    </div>`
                ).join('')}
            </div>
        `;
        
        tutorContent.insertAdjacentHTML('beforeend', practiceHtml);
        tutorContent.scrollTop = tutorContent.scrollHeight;
    }

    function openGeniusFeature(featureType) {
        if (featureType === 'advanced-calc') {
            // Unlock genius calculator achievement
            unlockAchievement('genius_calculator');
            
            // Open advanced calculator in new window/tab
            window.open('data:text/html,<html><head><title>Advanced Calculator</title></head><body style="font-family: Arial; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><h1>üßÆ Advanced Calculator</h1><p>Scientific calculator with advanced functions coming soon!</p><div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-top: 20px;"><h3>Features include:</h3><ul><li>üìä Graphing capabilities</li><li>üî¢ Complex number operations</li><li>üìê Trigonometric functions</li><li>üß™ Scientific notation</li><li>üìà Statistical analysis</li></ul></div></body></html>', '_blank');
        }
    }

    function showUpgradeModal(planName, features) {
        const modal = `
            <div id="upgradeModal" style="
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; 
                display: flex; align-items: center; justify-content: center;
            ">
                <div style="
                    background: linear-gradient(145deg, #ffffff, #f0f4f8);
                    border-radius: 25px; padding: 40px; max-width: 500px; width: 90%;
                    text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">‚≠ê</div>
                    <h2 style="color: #9c27b0; margin-bottom: 15px; font-size: 2rem;">Upgrade Required</h2>
                    <p style="color: #666; font-size: 1.2rem; margin-bottom: 25px;">
                        This feature requires ${planName} plan!
                    </p>
                    <div style="background: #f8f9ff; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
                        <p style="color: #9c27b0; font-weight: bold; margin-bottom: 10px;">${features}</p>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="window.location.href='subscription.html'" style="
                            background: linear-gradient(90deg, #9c27b0, #673ab7);
                            color: white; border: none; padding: 15px 25px;
                            border-radius: 20px; font-size: 1.1rem; font-weight: bold;
                            cursor: pointer; box-shadow: 0 4px 15px rgba(156,39,176,0.3);
                        ">‚≠ê Upgrade Now</button>
                        <button onclick="closeUpgradeModal()" style="
                            background: #e2e8f0; color: #666; border: none;
                            padding: 15px 25px; border-radius: 20px; font-size: 1.1rem;
                            cursor: pointer;
                        ">Maybe Later</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeUpgradeModal() {
        const modal = document.getElementById('upgradeModal');
        if (modal) modal.remove();
    }

    function openPremiumFeature(featurePage) {
        console.log(`üéØ Attempting to access premium feature: ${featurePage}`);
        
        // Ensure user is still logged in
        const currentUser = localStorage.getItem('currentUser');
        const isLoggedIn = userManager && userManager.isLoggedIn();
        
        if (!currentUser && !isLoggedIn) {
            console.log('‚ùå User not logged in, redirecting to login');
            alert('Please log in to access premium features!');
            window.location.href = 'login.html';
            return;
        }
        
        // Check premium status without clearing authentication
        const hasPremiumAccess = isPremiumUser();
        console.log(`üîë Premium access status: ${hasPremiumAccess}`);
        
        if (hasPremiumAccess) {
            console.log(`‚úÖ Opening premium feature: ${featurePage}`);
            
            // Unlock achievement when accessing premium features
            if (featurePage === 'family-dashboard.html' && isFamilyPlanUser()) {
                unlockAchievement('family_manager');
            } else if (featurePage === 'analytics.html') {
                unlockAchievement('analytics_explorer');
            }
            
            // Open feature in new tab
            window.open(featurePage, '_blank');
        } else {
            console.log(`üîí No premium access for: ${featurePage}`);
            showPremiumUpgradeModal('feature', featurePage.replace('.html', ''));
        }
    }

    function handlePremiumQuiz(quizType) {
        console.log(`üéØ Attempting to access premium quiz: ${quizType}`);
        
        // Ensure user is still logged in
        const currentUser = localStorage.getItem('currentUser');
        const isLoggedIn = userManager && userManager.isLoggedIn();
        
        if (!currentUser && !isLoggedIn) {
            console.log('‚ùå User not logged in, redirecting to login');
            alert('Please log in to access premium quizzes!');
            window.location.href = 'login.html';
            return;
        }
        
        // Check premium status without clearing authentication
        const hasPremiumAccess = isPremiumUser();
        console.log(`üîë Premium quiz access status: ${hasPremiumAccess}`);
        
        if (hasPremiumAccess) {
            console.log(`‚úÖ Starting premium quiz: ${quizType}`);
            startQuiz(quizType);
        } else {
            console.log(`üîí No premium access for quiz: ${quizType}`);
            showPremiumUpgradeModal('quiz', quizType);
        }
    }

    function handlePremiumLesson(lessonType) {
        if (isPremiumUser()) {
            showLesson(lessonType);
        } else {
            showPremiumUpgradeModal('lesson', lessonType);
        }
    }

    function showPremiumUpgradeModal(contentType, itemType) {
        const contentName = itemType.charAt(0).toUpperCase() + itemType.slice(1);
        const typeText = contentType === 'quiz' ? 'quiz' : contentType === 'lesson' ? 'lesson' : 'feature';
        
        const message = `üîí Premium Feature!\n\nThe ${contentName} ${typeText} is available for Premium subscribers only!\n\n‚ú® Upgrade to Premium for:\n‚Ä¢ Unlimited access to all ${contentType}s\n‚Ä¢ Family Dashboard with parental controls\n‚Ä¢ Advanced Analytics with AI insights\n‚Ä¢ Ad-free experience\n‚Ä¢ Priority support\n\nWould you like to upgrade now?`;
        
        if (confirm(message)) {
            window.location.href = 'subscription.html';
        }
    }

    function getTodayString() {
        return new Date().toDateString();
    }

    function getDailyQuizCount() {
        const today = getTodayString();
        const dailyData = JSON.parse(localStorage.getItem('dailyQuizData') || '{}');
        
        if (dailyData.date !== today) {
            // New day, reset count
            const newData = { date: today, quizCount: 0 };
            localStorage.setItem('dailyQuizData', JSON.stringify(newData));
            return 0;
        }
        
        return dailyData.quizCount || 0;
    }

    function incrementDailyQuizCount() {
        const today = getTodayString();
        const dailyData = JSON.parse(localStorage.getItem('dailyQuizData') || '{}');
        
        const newData = {
            date: today,
            quizCount: (dailyData.date === today ? dailyData.quizCount || 0 : 0) + 1
        };
        
        localStorage.setItem('dailyQuizData', JSON.stringify(newData));
        updateQuizCountDisplay();
    }

    function hasReachedDailyLimit() {
        const DAILY_LIMIT = 5; // Free users get 5 quizzes per day
        return getDailyQuizCount() >= DAILY_LIMIT;
    }

    function getRemainingQuizzes() {
        const DAILY_LIMIT = 5;
        return Math.max(0, DAILY_LIMIT - getDailyQuizCount());
    }

    function updateQuizCountDisplay() {
        const countElements = document.querySelectorAll('.quiz-count-display');
        const quizCards = document.querySelectorAll('.quiz-card');
        
        if (isPremiumUser()) {
            countElements.forEach(el => {
                el.innerHTML = '<span style="color: #10c168; font-weight: bold;">‚ú® Unlimited Quizzes!</span>';
            });
            // Remove locked styling from all quiz cards
            quizCards.forEach(card => {
                card.classList.remove('daily-limit-reached');
            });
        } else {
            const remaining = getRemainingQuizzes();
            countElements.forEach(el => {
                el.innerHTML = `<span style="color: ${remaining > 0 ? '#4ac6ff' : '#ff6b6b'}; font-weight: bold;">
                    ${remaining > 0 ? `${remaining} quizzes remaining today` : 'Daily limit reached! Upgrade for unlimited access üöÄ'}
                </span>`;
            });
            
            // Add locked styling to quiz cards when limit is reached
            if (remaining === 0) {
                quizCards.forEach(card => {
                    card.classList.add('daily-limit-reached');
                });
            } else {
                quizCards.forEach(card => {
                    card.classList.remove('daily-limit-reached');
                });
            }
        }
    }

    function showPremiumUpgradeModal() {
        const modal = `
            <div id="premiumModal" style="
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; 
                display: flex; align-items: center; justify-content: center;
            ">
                <div style="
                    background: linear-gradient(145deg, #ffffff, #f0f4f8);
                    border-radius: 25px; padding: 40px; max-width: 550px; width: 90%;
                    text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üöÄ</div>
                    <h2 style="color: #4a90e2; margin-bottom: 15px; font-size: 2rem;">Daily Limit Reached!</h2>
                    <p style="color: #666; font-size: 1.2rem; margin-bottom: 25px;">
                        You've completed your 5 free quizzes for today! üéâ
                    </p>
                    <div style="background: #f8f9ff; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
                        <p style="color: #4a90e2; font-weight: bold; margin-bottom: 10px;">üåü Premium Benefits:</p>
                        <ul style="text-align: left; color: #666; line-height: 1.6; margin: 0; padding-left: 20px;">
                            <li>‚ú® Unlimited quizzes & lessons</li>
                            <li>üìä Advanced Analytics with AI insights</li>
                            <li>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Dashboard with parental controls</li>
                            <li>üéØ Premium achievements & badges</li>
                            <li>üìà Detailed progress tracking</li>
                            <li>üö´ Ad-free experience</li>
                        </ul>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="window.location.href='subscription.html'" style="
                            background: linear-gradient(90deg, #ff6b6b, #fcb045);
                            color: white; border: none; padding: 15px 25px;
                            border-radius: 20px; font-size: 1.1rem; font-weight: bold;
                            cursor: pointer; box-shadow: 0 4px 15px rgba(255,107,107,0.3);
                        ">üåü Upgrade to Premium</button>
                        <button onclick="closePremiumModal()" style="
                            background: #e2e8f0; color: #666; border: none;
                            padding: 15px 25px; border-radius: 20px; font-size: 1.1rem;
                            cursor: pointer;
                        ">Maybe Later</button>
                    </div>
                    <p style="color: #999; font-size: 0.9rem; margin-top: 20px;">
                        ‚è∞ Your free quizzes reset at midnight!
                    </p>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closePremiumModal() {
        const modal = document.getElementById('premiumModal');
        if (modal) modal.remove();
    }

        // --- Progress saving functions ---
        async function saveProgress() {
            const username = localStorage.getItem('username');
            if (!username) return; // Don't save if not logged in
            
            // Create a progress object with all the data you want to save
            const progressData = {
            score: quiztate.score,
            streak: quiztate.streak,
            maxStreak: quiztate.maxStreak,
            totalCorrect: quiztate.totalCorrect,
            totalAnswered: quiztate.totalAnswered,
            achievements: achievements.map(a => ({
                id: a.id,
                unlocked: a.unlocked
            })),
            lessonsRead: Array.from(quiztate.lessonsRead),
            quizTypesPlayed: Array.from(quiztate.quizTypesPlayed),
            difficultyQuizzes: quiztate.difficultyQuizzes
            };
            
            try {
            await fetch('http://localhost:3000/api/progress', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, data: progressData })
            });
            console.log('Progress saved successfully!');
            } catch (error) {
            console.error('Error saving progress:', error);
            }
        }

        // Only keep this loadProgress function
        async function loadProgress() {
            const username = localStorage.getItem('username');
            if (!username) return;
            try {
                const response = await fetch(`http://localhost:3000/api/progress/${username}`);
                const result = await response.json();
                if (result.data && Object.keys(result.data).length > 0) {
                    quiztate.score = result.data.score || 0;
                    quiztate.streak = result.data.streak || 0;
                    quiztate.maxStreak = result.data.maxStreak || 0;
                    quiztate.totalCorrect = result.data.totalCorrect || 0;
                    quiztate.totalAnswered = result.data.totalAnswered || 0;
                    quiztate.wrongAnswers = result.data.wrongAnswers || 0;
                    quiztate.completedQuizzes = result.data.completedQuizzes || 0;
                    quiztate.firstTryCorrect = result.data.firstTryCorrect || 0;
                    quiztate.consecutiveFirstTry = result.data.consecutiveFirstTry || 0;
                    quiztate.perfectQuizzes = result.data.perfectQuizzes || [];
                    quiztate.lessonsRead = new Set(result.data.lessonsRead || []);
                    quiztate.quizTypesPlayed = new Set(result.data.quizTypesPlayed || []);
                    quiztate.difficultyQuizzes = result.data.difficultyQuizzes || { easy: 0, medium: 0, hard: 0 };
                    if (result.data.achievements) {
                        result.data.achievements.forEach(savedAchievement => {
                            const achievement = achievements.find(a => a.id === savedAchievement.id);
                            if (achievement) achievement.unlocked = savedAchievement.unlocked;
                        });
                    }
                    updateStats();
                    updateAchievementsCount();
                    displayAchievements();
                    console.log('Progress loaded successfully!');
                }
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        // Modern unlockAchievement: unlocks, saves, and shows a beautiful overlay
        function unlockAchievement(achievementId) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                showCelebration(achievement.name, achievement.icon);
                updateAchievementsCount();
                saveProgress();
            }
        }
        // Modern, visually impressive achievement celebration overlay
        function showCelebration(name, icon) {
            // Remove any existing confetti
            const oldConfetti = document.getElementById('confettiCanvas');
            if (oldConfetti) oldConfetti.remove();

            // Confetti canvas
            const canvas = document.createElement('canvas');
            canvas.id = 'confettiCanvas';
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100vw';
            canvas.style.height = '100vh';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '1001';
            document.body.appendChild(canvas);
            launchConfetti(canvas);

            // Card overlay
            const celebration = document.getElementById('celebration');
            celebration.style.display = 'flex';
            celebration.innerHTML = `
                <div style="background: linear-gradient(135deg, #ffe29f 0%, #ffb347 100%); box-shadow: 0 8px 40px #ffb34755, 0 2px 8px #4ac6ff22; border-radius: 32px; padding: 48px 38px 38px 38px; text-align: center; max-width: 420px; margin: 0 auto; border: 4px solid #4ac6ff; position: relative;">
                    <div style="font-size: 3.5em; margin-bottom: 18px;">${icon}</div>
                    <div style="font-size: 2.1em; font-weight: bold; color: #4ac6ff; margin-bottom: 10px; text-shadow: 1px 1px 0 #fffbe7;">Achievement Unlocked!</div>
                    <div style="font-size: 1.5em; color: #ffb347; font-weight: bold; margin-bottom: 12px;">${name}</div>
                    <button id="closeCelebration" style="background: linear-gradient(90deg, #4ac6ff 0%, #ffb347 100%); color: #fff; border: none; border-radius: 12px; padding: 12px 32px; font-size: 1.1em; font-weight: bold; margin-top: 18px; cursor: pointer; box-shadow: 0 2px 8px #4ac6ff22;">Close</button>
                </div>
            `;
            document.getElementById('closeCelebration').onclick = hideCelebration;
        }

        // Confetti animation (simple burst)
        function launchConfetti(canvas) {
            const ctx = canvas.getContext('2d');
            const W = window.innerWidth, H = window.innerHeight;
            canvas.width = W; canvas.height = H;
            const colors = ['#ffb347', '#4ac6ff', '#ffe29f', '#ff69b4', '#fffbe7', '#cedb0e'];
            const confetti = [];
            for (let i = 0; i < 120; i++) {
                confetti.push({
                    x: Math.random() * W,
                    y: Math.random() * -H/2,
                    r: Math.random() * 8 + 6,
                    d: Math.random() * 80 + 40,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    tilt: Math.random() * 20 - 10,
                    tiltAngle: 0,
                    tiltAngleInc: (Math.random() * 0.07) + 0.05
                });
            }
            let angle = 0;
            function draw() {
                ctx.clearRect(0, 0, W, H);
                for (let i = 0; i < confetti.length; i++) {
                    let c = confetti[i];
                    ctx.beginPath();
                    ctx.ellipse(c.x, c.y, c.r, c.r/2, c.tilt, 0, 2 * Math.PI);
                    ctx.fillStyle = c.color;
                    ctx.globalAlpha = 0.85;
                    ctx.fill();
                }
                update();
            }
            function update() {
                angle += 0.01;
                for (let i = 0; i < confetti.length; i++) {
                    let c = confetti[i];
                    c.y += (Math.cos(angle + c.d) + 2 + c.r/4) * 0.9;
                    c.x += Math.sin(angle) * 2;
                    c.tiltAngle += c.tiltAngleInc;
                    c.tilt = Math.sin(c.tiltAngle) * 15;
                    if (c.y > H + 20) {
                        c.x = Math.random() * W;
                        c.y = Math.random() * -20;
                    }
                }
            }
            let frame;
            function loop() {
                draw();
                frame = requestAnimationFrame(loop);
            }
            loop();
            setTimeout(() => {
                cancelAnimationFrame(frame);
                if (canvas.parentNode) canvas.parentNode.removeChild(canvas);
            }, 2600);
        }

        // Hide celebration overlay
        function hideCelebration() {
            const celebration = document.getElementById('celebration');
            celebration.style.display = 'none';
            celebration.innerHTML = '<div id="celebrationMessage"></div><button id="closeCelebration" onclick="hideCelebration()">Close</button>';
            const confetti = document.getElementById('confettiCanvas');
            if (confetti) confetti.remove();
        }

        // Update the endQuiz function to save progress
        // (You should call saveProgress() at the end of endQuiz)
        // If you have multiple endQuiz definitions, update all to include saveProgress()

        // Select difficulty
        function selectDifficulty(level) {
            quiztate.difficulty = level;
            // Only remove 'selected' from difficulty buttons
            document.querySelectorAll('.difficulty-btn[data-type="difficulty"]').forEach(btn => btn.classList.remove('selected'));
            if (event && event.target) event.target.classList.add('selected');
            checkReadyToStart();
        }

        // Select question count
        function selectQuestionCount(count) {
            quiztate.questionCount = count;
            // Only remove 'selected' from question count buttons
            document.querySelectorAll('.difficulty-btn[data-type="questioncount"]').forEach(btn => btn.classList.remove('selected'));
            if (event && event.target) event.target.classList.add('selected');
            checkReadyToStart();
        }

        // Check if ready to start
        function checkReadyToStart() {
            if (quiztate.difficulty && quiztate.questionCount > 0) {
                document.getElementById('startquizBtn').style.display = 'inline-block';
            }
        }

        // Begin quiz
        function beginQuiz() {
            // Increment daily quiz count for non-premium users
            if (!isPremiumUser()) {
                incrementDailyQuizCount();
            }

            generateQuestions();
            quiztate.currentQuestionIndex = 0;
            quiztate.attempts = 0;
            quiztate.wrongAnswers = 0;
            quiztate.startedWithWrongAnswer = false;
            quiztate.consecutiveFirstTry = 0;

            // Track quiz type played
            quiztate.quizTypesPlayed.add(quiztate.currentquiz);

            // Set up quiz page
            const titles = {
                'addition': 'üéØ Addition Adventure',
                'subtraction': 'ü¶Å Subtraction Safari',
                'multiplication': '‚öîÔ∏è Multiplication Quest',
                'division': 'üè∞ Division Castle',
                'mixed': 'üåü Mixed Math Mayhem',
                'comparison': '‚öñÔ∏è Number Detective',
                'fractions': 'üçï Fraction Pizza Party',
                'patterns': 'üé® Pattern Master',
                'wordproblems': 'üìñ Story Math Heroes'
            };
            document.getElementById('quizTitle').textContent = titles[quiztate.currentquiz];
            document.getElementById('totalQuestions').textContent = quiztate.questionCount;
            document.getElementById('streakDisplay').textContent = quiztate.streak;


            // Always show answer bar and quiz buttons at the start of every quiz
            const quizContainerEl = document.getElementById('quizContainer');
            const inputContainerEl = document.getElementById('inputContainer');
            let answerInputEl = document.getElementById('answerInput');
            let quizButtonsEl = document.getElementById('quizButtons');
            const feedbackEl = document.getElementById('feedback');
            const quizControlsEl = document.getElementById('quizControls');

            // Safety: re-append answerInput if missing
            if (inputContainerEl && !answerInputEl) {
                answerInputEl = document.createElement('input');
                answerInputEl.type = 'text';
                answerInputEl.id = 'answerInput';
                answerInputEl.className = 'answer-input';
                inputContainerEl.appendChild(answerInputEl);
            }
            // Safety: re-append quizButtons if missing
            if (quizContainerEl && !quizButtonsEl) {
                quizButtonsEl = document.createElement('div');
                quizButtonsEl.id = 'quizButtons';
                quizButtonsEl.className = 'quiz-buttons';
                // Add your quiz buttons here if needed
                quizContainerEl.appendChild(quizButtonsEl);
            }

            if (quizContainerEl) quizContainerEl.style.display = 'block';
            if (inputContainerEl) inputContainerEl.style.display = 'block';
            if (answerInputEl) {
                answerInputEl.style.display = 'inline-block';
                answerInputEl.value = '';
                answerInputEl.focus();
            }
            if (quizButtonsEl) quizButtonsEl.style.display = 'flex';
            if (feedbackEl) feedbackEl.style.display = 'flex';
            if (quizControlsEl) quizControlsEl.style.display = 'flex';

            showPage('quiz');
            showNextQuestion();
        }

        // Generate questions based on quiz type and difficulty
        function generateQuestions() {
            quiztate.questions = [];

            // Special handling for wordproblems: shuffle and pick unique questions, never repeat within a quiz
            if (quiztate.currentquiz === 'wordproblems') {
                const problems = {
                    easy: [
                        { text: "Sarah has 8 stickers. Her friend gives her 5 more stickers. How many stickers does Sarah have now?", answer: 13 },
                        { text: "There are 12 apples in a basket. Tom eats 4 apples. How many apples are left?", answer: 8 },
                        { text: "Jake has 3 bags with 4 candies in each bag. How many candies does Jake have in total?", answer: 12 },
                        { text: "Lily has 10 balloons. 3 fly away. How many does she have left?", answer: 7 },
                        { text: "Ben finds 6 seashells and his sister gives him 2 more. How many does he have?", answer: 8 },
                        { text: "A box has 9 crayons. If you add 4 more, how many crayons now?", answer: 13 },
                        { text: "There are 7 ducks in a pond. 2 more join. How many ducks now?", answer: 9 },
                        { text: "Mia bakes 5 cookies and eats 2. How many left?", answer: 3 },
                        { text: "A farmer has 10 cows. 3 are sold. How many cows left?", answer: 7 },
                        { text: "A toy store has 15 teddy bears. 6 are sold. How many teddy bears left?", answer: 9 },
                        { text: "A class has 20 students. 5 go home early. How many students left?", answer: 15 },
                        { text: "A pizza is cut into 8 slices. You eat 2. How many slices left?", answer: 6 },
                        { text: "A box has 10 chocolates. You eat 3. How many chocolates left?", answer: 7 },
                        { text: "There are 4 cats and 3 dogs in a park. How many animals in total?", answer: 7 },
                        { text: "A library has 12 books. You borrow 5. How many books left?", answer: 7 },
                        { text: "A garden has 6 flowers. 2 more bloom. How many flowers now?", answer: 8 },
                        { text: "A box has 5 toys. You buy 3 more. How many toys now?", answer: 8 },
                        { text: "There are 9 birds in a tree. 4 fly away. How many birds left?", answer: 5 },
                        { text: "A jar has 8 cookies. You eat 2. How many cookies left?", answer: 6 },
                        { text: "A basket has 10 oranges. You eat 3. How many oranges left?", answer: 7 },
                        { text: "A class has 15 students. 3 are absent. How many students present?", answer: 12 },
                        { text: "A box has 7 balls. You lose 2. How many balls left?", answer: 5 },
                        { text: "There are 10 cars in a parking lot. 4 leave. How many cars left?", answer: 6 },
                        { text: "A dog has 5 bones. He eats 1. How many bones left?", answer: 4 },
                        { text: "A tree has 8 apples. You pick 3. How many apples left?", answer: 5 },
                        { text: "A box has 6 toys. You give away 2. How many toys left?", answer: 4 },
                        { text: "A tree has 8 apples. 5 fall down. How many apples left?", answer: 3 },
                        { text: "Tom has 4 red cars and 6 blue cars. How many cars in total?", answer: 10 },
                        { text: "Anna has 6 pencils. She gives 2 to her friend. How many pencils does she have left?", answer: 4 },
                        { text: "There are 5 birds on a branch. 3 more land. How many birds now?", answer: 8 },
                        { text: "A basket has 7 oranges. You eat 2. How many left?", answer: 5 },
                        { text: "Sam has 9 marbles. He finds 3 more. How many marbles now?", answer: 12 },
                        { text: "A dog has 4 bones. He buries 1. How many bones left?", answer: 3 },
                        { text: "There are 8 frogs in a pond. 4 jump out. How many frogs left?", answer: 4 },
                        { text: "A box has 10 chocolates. You eat 6. How many left?", answer: 4 },
                        { text: "Lucy has 3 dolls. She gets 5 more for her birthday. How many dolls now?", answer: 8 },
                        { text: "A train has 5 carriages. Each carriage has 2 doors. How many doors in total?", answer: 10 },
                        { text: "There are 6 fish in a tank. 2 are taken out. How many fish left?", answer: 4 },
                        { text: "A pizza is cut into 8 slices. You eat 3. How many slices left?", answer: 5 },
                        { text: "A spider has 8 legs. 2 break off. How many legs left?", answer: 6 },
                        { text: "A bag has 7 candies. You give 4 to a friend. How many left?", answer: 3 },
                        { text: "There are 10 cookies. You eat 7. How many left?", answer: 3 },
                        { text: "A box has 12 eggs. 5 are used for baking. How many eggs left?", answer: 7 },
                        { text: "A garden has 6 flowers. 3 more bloom. How many flowers now?", answer: 9 },
                        { text: "A shelf has 8 books. 2 fall off. How many books left?", answer: 6 },
                        { text: "A class has 9 students. 1 leaves. How many students left?", answer: 8 },
                        { text: "A bag has 5 apples. You buy 4 more. How many apples now?", answer: 9 },
                        { text: "A box has 7 balls. You lose 2. How many balls left?", answer: 5 },
                        { "text": "Tom has 12 apples. He eats 4 of them. How many apples does Tom have left?", "answer": 8 },
                        { "text": "Lily has 7 pencils. She buys 6 more pencils. How many pencils does Lily have now?", "answer": 13 },
                        { "text": "A box has 15 chocolates. 9 are eaten. How many chocolates are left in the box?", "answer": 6 },
                        { "text": "Jake had 10 marbles. He found 3 more under the bed. How many marbles does he have now?", "answer": 13 },
                        { "text": "Emily read 5 books last week and 8 books this week. How many books has she read in total?", "answer": 13 },
                        { "text": "Noah had 20 sweets. He gave 7 to his sister. How many sweets does he have now?", "answer": 13 },
                        { "text": "There were 18 birds on a tree. 5 flew away. How many birds are left on the tree?", "answer": 13 },
                        { "text": "Sophie collected 9 shells. Her friend gave her 4 more. How many shells does Sophie have now?", "answer": 13 },
                        { "text": "A basket had 22 apples. 9 were taken out. How many apples remain in the basket?", "answer": 13 },
                        { "text": "Michael baked 6 muffins. Then he baked 7 more. How many muffins did he bake in total?", "answer": 13 },
                        { text: "Ella has 7 candies. She gives 3 to her brother. How many candies does she have left?", answer: 4 },
                        { text: "There are 6 ducks in a pond. 4 more ducks join them. How many ducks are there now?", answer: 10 },
                        { text: "A basket has 9 apples. You eat 2. How many apples are left?", answer: 7 },
                        { text: "Liam has 5 toy cars. He gets 6 more for his birthday. How many cars does he have now?", answer: 11 },
                        { text: "A box has 10 pencils. 3 pencils break. How many pencils are left?", answer: 7 },
                        { text: "Sophie has 8 balloons. She gives 2 to her friend. How many does she have left?", answer: 6 },
                        { text: "There are 11 cookies on a plate. 5 are eaten. How many cookies remain?", answer: 6 },
                        { text: "A basket holds 6 apples. You pick 7 more. How many apples now?", answer: 13 },
                        { text: "Noah has 9 marbles. He loses 4. How many marbles does he have left?", answer: 5 },
                        { text: "A box has 12 crayons. 6 are used. How many crayons are left?", answer: 6 }
                        ,{ text: "Olivia has 10 stickers. She gives 4 to her friend. How many does she have left?", answer: 6 }
                        ,{ text: "There are 8 birds in a tree. 3 fly away. How many birds are left?", answer: 5 }
                        ,{ text: "A basket has 12 apples. You eat 5. How many apples are left?", answer: 7 }
                        ,{ text: "Lucas has 6 toy cars. He gets 7 more. How many cars does he have now?", answer: 13 }
                        ,{ text: "A box has 15 pencils. 8 are used. How many pencils are left?", answer: 7 }
                        ,{ text: "Emma has 9 candies. She gives 2 to her brother. How many candies does she have left?", answer: 7 }
                        ,{ text: "There are 14 ducks in a pond. 6 swim away. How many ducks are left?", answer: 8 }
                        ,{ text: "A bag has 11 marbles. You lose 3. How many marbles are left?", answer: 8 }
                        ,{ text: "A box has 13 crayons. If you add 5 more, how many crayons now?", answer: 18 }
                        ,{ text: "A tree has 10 apples. 7 fall down. How many apples left?", answer: 3 }
                    ],
                    medium: [
                        { text: "A store has 45 books. They sell 18 books in the morning and 12 books in the afternoon. How many books are left?", answer: 15 },
                        { text: "Emma saves $7 each week. How much money will she have after 8 weeks?", answer: 56 },
                        { text: "There are 72 students going on a field trip. If each bus holds 24 students, how many buses are needed?", answer: 3 },
                        { text: "A farmer has 36 eggs. He puts them in cartons of 6. How many cartons does he fill?", answer: 6 },
                        { text: "A pizza is cut into 8 slices. If 5 are eaten, how many are left?", answer: 3 },
                        { text: "A class collects 28 cans for recycling. If they split them into groups of 4, how many groups?", answer: 7 },
                        { text: "A train has 5 carriages with 12 seats each. How many seats in total?", answer: 60 },
                        { text: "A baker makes 24 cupcakes and sells 17. How many left?", answer: 7 },
                        { text: "A rope is 30 meters long. If you cut off 12 meters, how much is left?", answer: 18 },
                        { text: "A box holds 9 rows of 5 pencils. How many pencils in the box?", answer: 45 },
                        { text: "A family has 3 children. Each child has 4 toys. How many toys in total?", answer: 12 },
                        { text: "A baker bakes 36 muffins. He puts them in boxes of 6. How many boxes?", answer: 6 },
                        { text: "A team scores 15 points in the first half and 18 in the second. Total points?", answer: 33 },
                        { text: "A bus leaves at 9:00 am and arrives at 11:30 am. How many hours is the trip?", answer: 2.5 },
                        { text: "A shop sells 8 pens for $2 each. How much money for all pens?", answer: 16 },
                        { text: "A class has 24 students. They split into groups of 6. How many groups?", answer: 4 },
                        { text: "A baker uses 3 eggs for each cake. He bakes 7 cakes. How many eggs?", answer: 21 },
                        { text: "A box has 48 candies. 16 are eaten. How many left?", answer: 32 },
                        { text: "A movie lasts 120 minutes. It starts at 3:00 pm. When does it end? (in 24h, e.g. 5.0)", answer: 5.0 },
                        { text: "A runner completes 4 laps of 400m each. How many meters in total?", answer: 1600 },
                        { text: "A baker has 60 cookies. He packs them in bags of 10. How many bags?", answer: 6 },
                        { text: "A zoo has 8 cages with 5 monkeys each. How many monkeys?", answer: 40 },
                        { text: "A box has 36 pencils. 9 are broken. How many pencils left?", answer: 27 },
                        { text: "A class has 30 students. 12 are girls. How many are boys?", answer: 18 },
                        { text: "A baker bakes 5 trays of 8 cookies. How many cookies?", answer: 40 },
                        { text: "A train travels 60 km in 2 hours. What is the average speed?", answer: 30 },
                        { text: "A bag has 20 marbles. 8 are red, the rest are blue. How many blue marbles?", answer: 12 },
                        { text: "A pizza costs $12. You buy 3. How much do you pay?", answer: 36 },
                        { text: "A class has 5 rows of 6 desks. How many desks?", answer: 30 },
                        { text: "A baker uses 2 cups of flour for each loaf. He bakes 9 loaves. How many cups?", answer: 18 },  
                        { text: "A box has 50 chocolates. 20 are dark chocolate. How many are milk chocolate?", answer: 30 },
                        { text: "A school has 120 students. If each class has 30 students, how many classes?", answer: 4 },
                        { text: "A farmer has 80 apples. He sells 25. How many apples left?", answer: 55 },
                        { text: "A library has 200 books. If 50 are checked out, how many books remain?", answer: 150 },
                        { "text": "Ava had 25 sweets. She gave 7 to her brother. How many sweets does she have left?", "answer": 18 },
                        { "text": "Ben has 15 toy cars. He buys 6 more. How many toy cars does he have now?", "answer": 21 },
                        { "text": "A class had 28 students. 5 went home early. How many students are still in class?", "answer": 23 },
                        { "text": "Maya picked 34 flowers. 12 of them wilted. How many are still fresh?", "answer": 22 },
                        { "text": "There are 40 chairs in a hall. 17 are taken. How many are still free?", "answer": 23 },
                        { "text": "Jack read 14 pages in the morning and 11 pages in the evening. How many pages did he read that day?", "answer": 25 },
                        { "text": "Ella collected 20 stamps. Her cousin gave her 9 more. How many stamps does she have now?", "answer": 29 },
                        { "text": "A football team scored 18 goals in one season and 12 in the next. How many did they score altogether?", "answer": 30 },
                        { "text": "There were 27 books on a shelf. 9 fell off. How many books remain on the shelf?", "answer": 18 },
                        { "text": "Luca had ¬£50. He spent ¬£18 on a toy. How much money does he have left?", "answer": 32 },
                        { text: "A farmer has 24 eggs. He puts them in cartons of 6. How many cartons does he fill?", answer: 4 },
                        { text: "A class has 18 students. They split into 3 equal groups. How many students in each group?", answer: 6 },
                        { text: "A baker makes 30 cookies. He gives 12 to his friends. How many cookies does he have left?", answer: 18 },
                        { text: "A train has 4 carriages with 15 seats each. How many seats in total?", answer: 60 },
                        { text: "A shop sells 8 boxes of crayons. Each box has 5 crayons. How many crayons in total?", answer: 40 },
                        { text: "A class has 27 students. They split into 3 teams. How many students per team?", answer: 9 },
                        { text: "A baker bakes 40 cupcakes. He gives 15 away. How many cupcakes left?", answer: 25 },
                        { text: "A zoo has 5 cages with 7 monkeys each. How many monkeys in total?", answer: 35 },
                        { text: "A train travels 90 km in 3 hours. What is the average speed?", answer: 30 },
                        { text: "A shop has 36 pencils. 12 are sold. How many pencils remain?", answer: 24 }
                        ,{ text: "A class has 36 students. They split into 4 teams. How many students per team?", answer: 9 }
                        ,{ text: "A baker bakes 50 cupcakes. He gives 20 away. How many cupcakes left?", answer: 30 }
                        ,{ text: "A zoo has 6 cages with 8 monkeys each. How many monkeys in total?", answer: 48 }
                        ,{ text: "A train travels 120 km in 4 hours. What is the average speed?", answer: 30 }
                        ,{ text: "A shop has 48 pencils. 18 are sold. How many pencils remain?", answer: 30 }
                        ,{ text: "A farmer has 60 eggs. He puts them in cartons of 12. How many cartons does he fill?", answer: 5 }
                        ,{ text: "A class has 40 students. They split into 5 equal groups. How many students in each group?", answer: 8 }
                        ,{ text: "A baker makes 36 cookies. He gives 14 to his friends. How many cookies does he have left?", answer: 22 }
                        ,{ text: "A train has 6 carriages with 10 seats each. How many seats in total?", answer: 60 }
                        ,{ text: "A shop sells 10 boxes of crayons. Each box has 6 crayons. How many crayons in total?", answer: 60 }
                    ],
                    hard: [
                        { text: "A bakery makes 144 cookies. They pack them into boxes of 12. If they sell 8 boxes, how many cookies are left?", answer: 48 },
                        { text: "Mike has 3 times as many marbles as Lisa. If Lisa has 15 marbles, how many marbles do they have together?", answer: 60 },
                        { text: "A rectangle has a length of 12 cm and width of 8 cm. What is the perimeter of the rectangle?", answer: 40 },
                        { "text": "Liam has 3 boxes of crayons. Each box has 5 crayons. He finds 4 more crayons on the table. How many crayons does Liam have in total?", "answer": 19 },
                        { "text": "Emma buys 4 packs of pencils. Each pack contains 6 pencils. She gives 5 pencils to her friend. How many pencils does she have left?", "answer": 19 },
                        { "text": "A baker bakes 7 trays of cookies. Each tray holds 8 cookies. He eats 5 cookies. How many cookies are left?", "answer": 51 },
                        { "text": "Noah read 3 chapters each day for 5 days. Then he read 2 more chapters. How many chapters did he read in total?", "answer": 17 },
                        { "text": "Sophia planted 6 rows of flowers. Each row had 4 flowers. Then she planted 3 more flowers. How many flowers did she plant in total?", "answer": 27 },
                        { "text": "There are 9 students. Each student brings 2 pens. The teacher gives 3 more pens to each student. How many pens are there in total?", "answer": 45 },
                        { "text": "A farmer has 4 fields. Each field has 10 cows. 5 cows run away. How many cows are left?", "answer": 35 },
                        { "text": "A toy costs ¬£7. Mia buys 3 toys and then spends ¬£5 on sweets. How much does she spend altogether?", "answer": 26 },
                        { "text": "Oliver makes 5 paper planes each day for 4 days. Then he gives away 6 planes. How many paper planes does he have left?", "answer": 14 },
                        { "text": "There are 6 boxes. Each box has 9 oranges. 12 oranges are taken out. How many oranges remain?", "answer": 42 },
                        { text: "A school has 5 classes with 28 students each. How many students in total?", answer: 140 },
                        { text: "A shop sold 75 pens on Monday and 89 on Tuesday. How many pens in total?", answer: 164 },
                        { text: "A tank holds 250 liters of water. 75 liters are used. How much is left?", answer: 175 },
                        { text: "A marathon is 42 km. If you run 17 km, how much is left?", answer: 25 },
                        { text: "A baker bakes 96 muffins and puts them in boxes of 8. How many boxes?", answer: 12 },
                        { text: "A family eats 3 pizzas with 8 slices each. How many slices did they eat?", answer: 24 },
                        { text: "A movie starts at 2:15 pm and ends at 4:00 pm. How many minutes long is the movie?", answer: 105 },
                        { text: "A factory produces 250 toys a day. In 7 days, how many toys?", answer: 1750 },
                        { text: "A car travels 360 km in 4 hours. What is the average speed?", answer: 90 },
                        { text: "A baker uses 3 eggs for each cake. He bakes 15 cakes. How many eggs?", answer: 45 },
                        { text: "A class has 32 students. 3/4 are present. How many are present?", answer: 24 },
                        { text: "A shop has 120 apples. 35 are sold. How many left?", answer: 85 },
                        { text: "A train leaves at 8:30 am and arrives at 13:15. How many hours is the trip?", answer: 4.75 },
                        { text: "A baker bakes 8 trays of 18 cookies. How many cookies?", answer: 144 },
                        { text: "A team scores 27 points in the first half and 34 in the second. Total points?", answer: 61 },
                        { text: "A bus has 40 seats. 27 are taken. How many seats left?", answer: 13 },
                        { text: "A class has 6 rows of 7 desks. How many desks?", answer: 42 },
                        { text: "A baker uses 2.5 cups of flour for each loaf. He bakes 12 loaves. How many cups?", answer: 30 },
                        { text: "A box has 200 candies. 3/5 are chocolate. How many are chocolate?", answer: 120 },
                        { text: "A movie lasts 150 minutes. It starts at 6:10 pm. When does it end? (in 24h, e.g. 8.6)", answer: 8.6 },
                        { text: "A runner completes 10 laps of 400m each. How many meters in total?", answer: 4000 },
                        { text: "A baker has 180 cookies. He packs them in bags of 15. How many bags?", answer: 12 },
                        { text: "A zoo has 12 cages with 9 monkeys each. How many monkeys?", answer: 108 },
                        { text: "A box has 90 pencils. 27 are broken. How many pencils left?", answer: 63 },
                        { text: "A class has 40 students. 17 are girls. How many are boys?", answer: 23 },
                        { text: "A baker bakes 7 trays of 16 cookies. How many cookies?", answer: 112 },
                        { text: "A train travels 240 km in 3 hours. What is the average speed?", answer: 80 }
                        // New hard word problems
                        ,{ text: "A library has 120 books. 45 are checked out. How many books remain in the library?", answer: 75 }
                        ,{ text: "A baker bakes 5 trays of 16 muffins. How many muffins in total?", answer: 80 }
                        ,{ text: "A school has 6 classes with 23 students each. How many students in total?", answer: 138 }
                        ,{ text: "A marathon is 42 km long. If you have run 17 km, how many kilometers are left?", answer: 25 }
                        ,{ text: "A box contains 96 candies. If you divide them equally among 8 friends, how many candies does each friend get?", answer: 12 }
                        ,{ text: "A library has 200 books. 75 are checked out and 25 are returned. How many books are now in the library?", answer: 150 }
                        ,{ text: "A baker bakes 120 cookies. He puts them in boxes of 10. How many boxes does he fill?", answer: 12 }
                        ,{ text: "A school has 8 classes with 25 students each. How many students in total?", answer: 200 }
                        ,{ text: "A marathon is 50 km long. If you have run 32 km, how many kilometers are left?", answer: 18 }
                        ,{ text: "A box contains 144 candies. If you divide them equally among 12 friends, how many candies does each friend get?", answer: 12 }
                        ,{ text: "A library has 300 books. 100 are checked out and 50 are returned. How many books are now in the library?", answer: 250 }
                        ,{ text: "A baker bakes 180 cookies. He puts them in boxes of 15. How many boxes does he fill?", answer: 12 }
                        ,{ text: "A school has 10 classes with 30 students each. How many students in total?", answer: 300 }
                        ,{ text: "A marathon is 60 km long. If you have run 45 km, how many kilometers are left?", answer: 15 }
                        ,{ text: "A box contains 180 candies. If you divide them equally among 15 friends, how many candies does each friend get?", answer: 12 }
                        ,{ text: "A shop has 250 apples. 100 are sold and 30 are returned. How many apples now?", answer: 180 }
                        ,{ text: "A baker bakes 210 cookies. He puts them in boxes of 14. How many boxes does he fill?", answer: 15 }
                        ,{ text: "A school has 12 classes with 28 students each. How many students in total?", answer: 336 }
                        ,{ text: "A marathon is 80 km long. If you have run 60 km, how many kilometers are left?", answer: 20 }
                        ,{ text: "A box contains 168 candies. If you divide them equally among 14 friends, how many candies does each friend get?", answer: 12 }
                    ]
                };
                // Clone and shuffle the array
                let pool = problems[quiztate.difficulty].slice();
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                // Limit to pool size to avoid repeats
                let qCount = Math.min(quiztate.questionCount, pool.length);
                for (let i = 0; i < qCount; i++) {
                    let p = pool[i];
                    quiztate.questions.push({
                        questionText: p.text,
                        answer: p.answer
                    });
                }
                // If user requested more than available, show a warning
                if (quiztate.questionCount > pool.length) {
                    setTimeout(() => {
                        alert('Not enough unique word problems for this quiz length. Only ' + pool.length + ' unique questions will be used.');
                    }, 100);
                }
            } else {
                for (let i = 0; i < quiztate.questionCount; i++) {
                    let question = generateQuestion();
                    quiztate.questions.push(question);
                }
            }
        }

        function generateQuestion() {
            let a, b, operator, answer, questionText;
            
            switch (quiztate.currentquiz) {
                case 'addition':
                    if (quiztate.difficulty === 'easy') {
                        a = Math.floor(Math.random() * 10) + 1;
                        b = Math.floor(Math.random() * 10) + 1;
                    } else if (quiztate.difficulty === 'medium') {
                        a = Math.floor(Math.random() * 50) + 1;
                        b = Math.floor(Math.random() * 50) + 1;
                    } else {
                        a = Math.floor(Math.random() * 100) + 1;
                        b = Math.floor(Math.random() * 100) + 1;
                    }
                    operator = '+';
                    answer = a + b;
                    questionText = `${a} ${operator} ${b} = ?`;
                    break;
                    
                case 'subtraction':
                    if (quiztate.difficulty === 'easy') {
                        a = Math.floor(Math.random() * 20) + 10;
                        b = Math.floor(Math.random() * 10) + 1;
                    } else if (quiztate.difficulty === 'medium') {
                        a = Math.floor(Math.random() * 100) + 20;
                        b = Math.floor(Math.random() * 50) + 1;
                    } else {
                        a = Math.floor(Math.random() * 200) + 50;
                        b = Math.floor(Math.random() * 100) + 1;
                    }
                    if (a < b) [a, b] = [b, a];
                    operator = '-';
                    answer = a - b;
                    questionText = `${a} ${operator} ${b} = ?`;
                    break;
                    
                case 'multiplication':
                    if (quiztate.difficulty === 'easy') {
                        a = Math.floor(Math.random() * 5) + 1;
                        b = Math.floor(Math.random() * 10) + 1;
                    } else if (quiztate.difficulty === 'medium') {
                        a = Math.floor(Math.random() * 20) + 1;
                        b = Math.floor(Math.random() * 10) + 1;
                    } else {
                        a = Math.floor(Math.random() * 100) + 1;
                        b = Math.floor(Math.random() * 12) + 1;
                    }
                    operator = '√ó';
                    answer = a * b;
                    questionText = `${a} ${operator} ${b} = ?`;
                    break;
                    
                case 'division':
                    if (quiztate.difficulty === 'easy') {
                        b = Math.floor(Math.random() * 5) + 2;
                        answer = Math.floor(Math.random() * 10) + 1;
                    } else if (quiztate.difficulty === 'medium') {
                        b = Math.floor(Math.random() * 100) + 2;
                        answer = Math.floor(Math.random() * 12) + 1;
                    } else {
                        b = Math.floor(Math.random() * 1000) + 2;
                        answer = Math.floor(Math.random() * 15) + 1;
                    }
                    a = answer * b;
                    operator = '√∑';
                    questionText = `${a} ${operator} ${b} = ?`;
                    break;
                    
                case 'mixed':
                    const operations = ['addition', 'subtraction', 'multiplication'];
                    if (quiztate.difficulty !== 'easy') operations.push('division');
                    const randomOp = operations[Math.floor(Math.random() * operations.length)];
                    
                    const originalquiz = quiztate.currentquiz;
                    quiztate.currentquiz = randomOp;
                    const mixedQuestion = generateQuestion();
                    quiztate.currentquiz = originalquiz;
                    return mixedQuestion;
                    
                case 'comparison':
                    if (quiztate.difficulty === 'easy') {
                        a = Math.floor(Math.random() * 20) + 1;
                        b = Math.floor(Math.random() * 20) + 1;
                    } else {
                        a = Math.floor(Math.random() * 100) + 1;
                        b = Math.floor(Math.random() * 100) + 1;
                    }
                    
                    if (a > b) {
                        answer = '>';
                    } else if (a < b) {
                        answer = '<';
                    } else {
                        answer = '=';
                    }
                    questionText = `${a} ___ ${b}  (Type >, <, or =)`;
                    break;
                    
                case 'fractions':
                    if (quiztate.difficulty === 'easy') {
                        const numerator = Math.floor(Math.random() * 3) + 1;
                        const denominator = Math.floor(Math.random() * 3) + 2;
                        questionText = `What is ${numerator}/${denominator} as a decimal? (Round to 1 decimal place)`;
                        answer = Math.round((numerator / denominator) * 10) / 10;
                    } else if (quiztate.difficulty === 'medium') {
                        const denom = Math.floor(Math.random() * 6) + 4;
                        const num1 = Math.floor(Math.random() * 3) + 1;
                        const num2 = Math.floor(Math.random() * 3) + 1;
                        questionText = `${num1}/${denom} + ${num2}/${denom} = ?/${denom}  (Enter the numerator)`;
                        answer = num1 + num2;
                    } else {
                        const whole = Math.floor(Math.random() * 3) + 1;
                        const num = Math.floor(Math.random() * 3) + 1;
                        const denom = Math.floor(Math.random() * 4) + 4;
                        questionText = `Convert ${whole} ${num}/${denom} to improper fraction. What is the numerator?`;
                        answer = (whole * denom) + num;
                    }
                    break;
                    
                case 'patterns':
                    const patternTypes = ['add', 'multiply', 'subtract'];
                    const patternType = patternTypes[Math.floor(Math.random() * patternTypes.length)];
                    
                    if (patternType === 'add') {
                        const step = quiztate.difficulty === 'easy' ? Math.floor(Math.random() * 5) + 1 : 
                                   quiztate.difficulty === 'medium' ? Math.floor(Math.random() * 10) + 1 :
                                   Math.floor(Math.random() * 15) + 1;
                        const start = Math.floor(Math.random() * 10) + 1;
                        const sequence = [start, start + step, start + (2 * step), start + (3 * step)];
                        answer = start + (4 * step);
                        questionText = `${sequence[0]}, ${sequence[1]}, ${sequence[2]}, ${sequence[3]}, ?`;
                    } else if (patternType === 'multiply') {
                        const multiplier = quiztate.difficulty === 'easy' ? 2 : 
                                         quiztate.difficulty === 'medium' ? Math.floor(Math.random() * 2) + 2 : 3;
                        const start = quiztate.difficulty === 'easy' ? 1 : Math.floor(Math.random() * 3) + 1;
                        const sequence = [start, start * multiplier, start * multiplier * multiplier];
                        answer = start * multiplier * multiplier * multiplier;
                        questionText = `${sequence[0]}, ${sequence[1]}, ${sequence[2]}, ?`;
                    } else {
                        const step = quiztate.difficulty === 'easy' ? Math.floor(Math.random() * 3) + 1 : 
                                   Math.floor(Math.random() * 8) + 1;
                        const start = Math.floor(Math.random() * 20) + 20;
                        const sequence = [start, start - step, start - (2 * step), start - (3 * step)];
                        answer = start - (4 * step);
                        questionText = `${sequence[0]}, ${sequence[1]}, ${sequence[2]}, ${sequence[3]}, ?`;
                    }
                    break;
                    
                case 'wordproblems':
                    const problems = {
                        easy: [
                            { text: "Sarah has 8 stickers. Her friend gives her 5 more stickers. How many stickers does Sarah have now?", answer: 13 },
                            { text: "There are 12 apples in a basket. Tom eats 4 apples. How many apples are left?", answer: 8 },
                            { text: "Jake has 3 bags with 4 candies in each bag. How many candies does Jake have in total?", answer: 12 }
                        ],
                        medium: [
                            { text: "A store has 45 books. They sell 18 books in the morning and 12 books in the afternoon. How many books are left?", answer: 15 },
                            { text: "Emma saves $7 each week. How much money will she have after 8 weeks?", answer: 56 },
                            { text: "There are 72 students going on a field trip. If each bus holds 24 students, how many buses are needed?", answer: 3 }
                        ],
                        hard: [
                            { text: "A bakery makes 144 cookies. They pack them into boxes of 12. If they sell 8 boxes, how many cookies are left?", answer: 48 },
                            { text: "Mike has 3 times as many marbles as Lisa. If Lisa has 15 marbles, how many marbles do they have together?", answer: 60 },
                            { text: "A rectangle has a length of 12 cm and width of 8 cm. What is the perimeter of the rectangle?", answer: 40 }
                        ]
                    };
                    
                    const problemSet = problems[quiztate.difficulty];
                    const selectedProblem = problemSet[Math.floor(Math.random() * problemSet.length)];
                    questionText = selectedProblem.text;
                    answer = selectedProblem.answer;
                    break;
            }
            
            return { a, b, operator, answer, questionText };
        }

        // Show next question
        function showNextQuestion() {
            if (quiztate.currentQuestionIndex >= quiztate.questions.length) {
                endQuiz();
                return;
            }
 
            const question = quiztate.questions[quiztate.currentQuestionIndex];
            const questionText = question.questionText || `${question.a} ${question.operator} ${question.b} = ?`;



            // Always show answer bar and quiz buttons for every question
            const inputContainerEl = document.getElementById('inputContainer');
            const quizContainerEl = document.getElementById('quizContainer');
            let answerInputEl = document.getElementById('answerInput');
            let quizButtonsEl = document.getElementById('quizButtons');

            // Make sure inputContainerEl is visible
            if (inputContainerEl) {
                inputContainerEl.style.display = 'block';
            }
            // Make sure quizContainerEl is visible
            if (quizContainerEl) {
                quizContainerEl.style.display = 'block';
            }

            // Remove duplicate answerInput if any
            if (inputContainerEl) {
                const inputs = inputContainerEl.querySelectorAll('#answerInput');
                if (inputs.length > 1) {
                    for (let i = 1; i < inputs.length; i++) {
                        inputs[i].remove();
                    }
                }
                answerInputEl = inputContainerEl.querySelector('#answerInput');
            }

            // If answerInput is missing, create and append it
            if (inputContainerEl && !answerInputEl) {
                answerInputEl = document.createElement('input');
                answerInputEl.type = 'text';
                answerInputEl.id = 'answerInput';
                answerInputEl.className = 'answer-input';
                answerInputEl.placeholder = 'Type your answer...';
                answerInputEl.tabIndex = 0;
                inputContainerEl.appendChild(answerInputEl);
            }

            // Make sure answerInput is visible and ready
            if (answerInputEl) {
                answerInputEl.style.display = 'inline-block';
                answerInputEl.value = '';
                answerInputEl.focus();
            }

            // Quiz buttons
            if (quizContainerEl) {
                quizContainerEl.style.display = 'block';
                const buttons = quizContainerEl.querySelectorAll('#quizButtons');
                if (buttons.length > 1) {
                    for (let i = 1; i < buttons.length; i++) {
                        buttons[i].remove();
                    }
                }
                quizButtonsEl = quizContainerEl.querySelector('#quizButtons');
            }
            if (quizContainerEl && !quizButtonsEl) {
                quizButtonsEl = document.createElement('div');
                quizButtonsEl.id = 'quizButtons';
                quizButtonsEl.className = 'quiz-buttons';
                quizContainerEl.appendChild(quizButtonsEl);
            }
            if (quizButtonsEl) quizButtonsEl.style.display = 'flex';

            document.getElementById('questionDisplay').textContent = questionText;
            document.getElementById('currentQuestion').textContent = quiztate.currentQuestionIndex + 1;
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';

            quiztate.currentAnswer = question.answer;
            quiztate.attempts = 0;
        }

        // Check answer
        function checkAnswer() {
            const userAnswer = document.getElementById('answerInput').value.trim();
            const feedbackEl = document.getElementById('feedback');
            let isCorrect = false;
            
            // Handle different answer types
            if (quiztate.currentquiz === 'comparison') {
                isCorrect = userAnswer === quiztate.currentAnswer.toString();
            } else {
                const numAnswer = parseFloat(userAnswer);
                if (isNaN(numAnswer) && quiztate.currentquiz !== 'comparison') {
                    feedbackEl.textContent = 'ü§î Please enter a number!';
                    feedbackEl.className = 'feedback incorrect shake';
                    setTimeout(() => feedbackEl.classList.remove('shake'), 500);
                    return;
                }
                isCorrect = Math.abs(numAnswer - quiztate.currentAnswer) < 0.1;
            }
            
            quiztate.attempts++;
            quiztate.totalAnswered++;
            
            if (isCorrect) {
                // Correct answer!
                quiztate.totalCorrect++;
                quiztate.streak++;
                if (quiztate.streak > quiztate.maxStreak) {
                    quiztate.maxStreak = quiztate.streak;
                }
                
                // Track first try correct answers
                if (quiztate.attempts === 1) {
                    quiztate.firstTryCorrect++;
                    quiztate.consecutiveFirstTry++;
                } else {
                    quiztate.consecutiveFirstTry = 0;
                }
                
                // Track if started with wrong answer but recovered
                if (quiztate.currentQuestionIndex === 0 && quiztate.attempts > 1) {
                    quiztate.startedWithWrongAnswer = true;
                }
                
                // Calculate points based on streak and difficulty
                let points = 10;
                if (quiztate.difficulty === 'medium') points = 15;
                if (quiztate.difficulty === 'hard') points = 20;
                if (quiztate.streak >= 3) points *= 1.5;
                if (quiztate.attempts === 1) points *= 1.2; // First try bonus
                
                quiztate.score += Math.floor(points);
                
                const encouragement = [
                    "üéâ Excellent work!",
                    "‚≠ê Amazing job!",
                    "üåü Fantastic!",
                    "üéØ Perfect!",
                    "üöÄ Outstanding!",
                    "üí´ Brilliant!",
                    "üèÜ Superb!"
                ];
                
                feedbackEl.textContent = encouragement[Math.floor(Math.random() * encouragement.length)] + 
                    ` +${Math.floor(points)} points!`;
                feedbackEl.className = 'feedback correct bounce';
                
                // Check achievements
                checkAchievements();
                
                // Auto-clear input and move to next question after 1.5 seconds
                document.getElementById('answerInput').value = '';
                setTimeout(() => {
                    quiztate.currentQuestionIndex++;
                    showNextQuestion();
                    updateStats();
                }, 1500);
                
            } else {
                // Wrong answer
                quiztate.streak = 0;
                quiztate.consecutiveFirstTry = 0;
                quiztate.wrongAnswers++;
                
                if (quiztate.attempts < 2) {
                    // First wrong attempt - give hint
                    const hints = [
                        "ü§î Not quite! Try again!",
                        "üí° Close, but try once more!",
                        "üéØ Think about it again!",
                        "üîÑ Give it another shot!"
                    ];
                    feedbackEl.textContent = hints[Math.floor(Math.random() * hints.length)];
                    feedbackEl.className = 'feedback incorrect shake';
                    
                } else {
                    // Second wrong attempt - show answer and move on
                    feedbackEl.textContent = `üòä The answer was ${quiztate.currentAnswer}. Let's try the next one!`;
                    feedbackEl.className = 'feedback incorrect';
                    
                    // Auto-clear input and move to next question after 2 seconds
                    document.getElementById('answerInput').value = '';
                    setTimeout(() => {
                        quiztate.currentQuestionIndex++;
                        showNextQuestion();
                    }, 2000);
                }
            }
            
            updateStats();
            
            // Remove animation class after animation
            setTimeout(() => {
                feedbackEl.classList.remove('bounce', 'shake');
            }, 1000);
        }

        // Skip question (if enabled)
        function skipQuestion() {
            quiztate.streak = 0;
            quiztate.currentQuestionIndex++;
            showNextQuestion();
            updateStats();
        }

        // End quiz
        function endQuiz() {
            const accuracy = quiztate.totalAnswered > 0 ? 
                Math.round((quiztate.totalCorrect / quiztate.totalAnswered) * 100) : 0;
            quiztate.completedQuizzes++;
            quiztate.difficultyQuizzes[quiztate.difficulty]++;
            // Check for perfect quiz
            if (accuracy === 100) {
                quiztate.perfectQuizzes.push({
                    type: quiztate.currentquiz,
                    difficulty: quiztate.difficulty,
                    questions: quiztate.questionCount
                });
            }
            // Check for quiz-specific achievements
            if (accuracy >= 80) {
                if (quiztate.currentquiz === 'addition') unlockAchievement('addition_expert');
                if (quiztate.currentquiz === 'subtraction') unlockAchievement('subtraction_expert');
                if (quiztate.currentquiz === 'multiplication') unlockAchievement('multiplication_expert');
                if (quiztate.currentquiz === 'division') unlockAchievement('division_expert');
                if (quiztate.currentquiz === 'mixed') unlockAchievement('mixed_expert');
                if (quiztate.currentquiz === 'comparison') unlockAchievement('comparison_expert');
                if (quiztate.currentquiz === 'fractions') unlockAchievement('fractions_expert');
                if (quiztate.currentquiz === 'patterns') unlockAchievement('patterns_expert');
                if (quiztate.currentquiz === 'wordproblems') unlockAchievement('wordproblems_expert');
            }
            // Check various achievements
            unlockAchievement('first_quiz');
            // Perfect score achievements
            if (accuracy === 100) {
                if (quiztate.questionCount >= 5) unlockAchievement('perfect_5');
                if (quiztate.questionCount >= 10) unlockAchievement('perfect_10');
                if (quiztate.questionCount >= 20) unlockAchievement('perfect_20');
            }
                        // Show completion message
            // Hide quiz UI elements instead of removing them
            const quizContainerEl = document.getElementById('quizContainer');
            const inputContainerEl = document.getElementById('inputContainer');
            const answerInputEl = document.getElementById('answerInput');
            const quizButtonsEl = document.getElementById('quizButtons');
            const feedbackEl = document.getElementById('feedback');
            const quizControlsEl = document.getElementById('quizControls');
            if (quizContainerEl) quizContainerEl.style.display = 'none';
            if (inputContainerEl) inputContainerEl.style.display = 'none';
            if (answerInputEl) answerInputEl.style.display = 'none';
            if (quizButtonsEl) quizButtonsEl.style.display = 'none';
            if (feedbackEl) feedbackEl.style.display = 'none';
            if (quizControlsEl) quizControlsEl.style.display = 'none';

            // Show a modern, organized overlay for the completion message
            let endOverlay = document.getElementById('endOverlay');
            if (!endOverlay) {
                endOverlay = document.createElement('div');
                endOverlay.id = 'endOverlay';
                endOverlay.style.position = 'fixed';
                endOverlay.style.top = '0';
                endOverlay.style.left = '0';
                endOverlay.style.width = '100vw';
                endOverlay.style.height = '100vh';
                endOverlay.style.background = 'rgba(255,255,255,0.97)';
                endOverlay.style.display = 'flex';
                endOverlay.style.flexDirection = 'column';
                endOverlay.style.justifyContent = 'center';
                endOverlay.style.alignItems = 'center';
                endOverlay.style.zIndex = '1000';
                document.body.appendChild(endOverlay);
            } else {
                endOverlay.style.display = 'flex';
            }
            endOverlay.innerHTML = `
                <div class="quiz-complete-card">
                    <div class="quiz-complete-emoji">üéâ</div>
                    <div class="quiz-complete-title">Quiz Complete!</div>
                    <div class="quiz-complete-stats" role="group" aria-label="Quiz Results">
                        <div class="quiz-complete-stat" role="region" aria-label="Score">
                            <span class="quiz-complete-label">Score:</span>
                            <b class="quiz-complete-value">${quiztate.score} points</b>
                        </div>
                        <div class="quiz-complete-stat" role="region" aria-label="Accuracy">
                            <span class="quiz-complete-label">Accuracy:</span>
                            <b class="quiz-complete-value">${accuracy}%</b>
                        </div>
                        <div class="quiz-complete-stat" role="region" aria-label="Best Streak">
                            <span class="quiz-complete-label">Best Streak:</span>
                            <b class="quiz-complete-value">${quiztate.maxStreak}</b>
                        </div>
                    </div>
                    <div class="quiz-complete-actions">
                        <button class="btn btn-secondary" onclick="restartQuizFromEnd()">üéÆ Play Again</button>
                        <button class="btn btn-secondary" onclick="goHomeFromEnd()">üè† Home</button>
                    </div>
                </div>
            `;
            // Add modern styles for the completion card if not already present
            if (!document.getElementById('quiz-complete-style')) {
                const style = document.createElement('style');
                style.id = 'quiz-complete-style';
                style.innerHTML = `
                .quiz-complete-card {
                    background: linear-gradient(135deg, #fafdff 0%, #e6f7ff 100%);
                    box-shadow: 0 8px 40px #4ac6ff33, 0 2px 8px #ffb34722;
                    border-radius: 32px;
                    padding: 48px 38px 38px 38px;
                    text-align: center;
                    max-width: 420px;
                    margin: 0 auto;
                    border: 4px solid #4ac6ff;
                    position: relative;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    animation: popCelebration 0.7s cubic-bezier(.4,2,.6,1);
                }
                .quiz-complete-emoji {
                    font-size: 3.5em;
                    margin-bottom: 10px;
                    filter: drop-shadow(0 0 16px #ffb34788) drop-shadow(0 0 32px #4ac6ff66);
                }
                .quiz-complete-title {
                    font-size: 2em;
                    font-weight: 900;
                    color: #2196f3;
                    margin-bottom: 18px;
                    letter-spacing: 1px;
                    text-shadow: 0 2px 8px #4ac6ff22;
                }
                .quiz-complete-stats {
                    margin-bottom: 18px;
                    width: 100%;
                }
                .quiz-complete-stat {
                    font-size: 1.2em;
                    margin: 10px 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    width: 100%;
                }
                .quiz-complete-stat span {
                    color: #2196f3;
                    font-weight: 700;
                }
                /* Stat value colors by meaning */
                .quiz-complete-stat b {
                    font-weight: 700;
                }
                .quiz-complete-stat:nth-child(1) b { /* Score */
                    color: #ffb347;
                }
                .quiz-complete-stat:nth-child(2) b { /* Accuracy */
                    color: #2196f3;
                }
                .quiz-complete-stat:nth-child(3) b { /* Best Streak */
                    color: #10c168;
                }
                .quiz-complete-actions {
                    display: flex;
                    gap: 16px;
                    justify-content: center;
                    margin-top: 10px;
                }
                @media (max-width: 500px) {
                    .quiz-complete-card {
                        padding: 24px 8px 18px 8px;
                        max-width: 98vw;
                    }
                }
                `;
                document.head.appendChild(style);
            }
            saveProgress();
        }

        // Restore all quiz UI elements and start a new quiz from the end screen
        function restartQuizFromEnd() {
            const quizContainerEl = document.getElementById('quizContainer');
            const inputContainerEl = document.getElementById('inputContainer');
            let answerInputEl = document.getElementById('answerInput');
            const quizButtonsEl = document.getElementById('quizButtons');
            const feedbackEl = document.getElementById('feedback');
            const quizControlsEl = document.getElementById('quizControls');
            if (quizContainerEl) quizContainerEl.style.display = 'block';
            if (inputContainerEl) inputContainerEl.style.display = 'block';
            // If answerInput is missing, create and append it
            if (inputContainerEl && !answerInputEl) {
                answerInputEl = document.createElement('input');
                answerInputEl.type = 'text';
                answerInputEl.id = 'answerInput';
                answerInputEl.className = 'answer-input';
                answerInputEl.placeholder = 'Type your answer...';
                answerInputEl.tabIndex = 0;
                inputContainerEl.appendChild(answerInputEl);
            }
            // Always get the latest reference and show/focus
            answerInputEl = document.getElementById('answerInput');
            if (answerInputEl) {
                answerInputEl.style.display = 'inline-block';
                answerInputEl.value = '';
                answerInputEl.focus();
            }
            if (quizButtonsEl) quizButtonsEl.style.display = 'flex';
            if (feedbackEl) feedbackEl.style.display = 'flex';
            if (quizControlsEl) quizControlsEl.style.display = 'flex';
            // Hide end overlay if present
            const endOverlay = document.getElementById('endOverlay');
            if (endOverlay) endOverlay.style.display = 'none';
            beginQuiz();
        }

        // Restore UI and go to home from end screen
        function goHomeFromEnd() {
            const quizContainerEl = document.getElementById('quizContainer');
            const inputContainerEl = document.getElementById('inputContainer');
            let answerInputEl = document.getElementById('answerInput');
            const quizButtonsEl = document.getElementById('quizButtons');
            const feedbackEl = document.getElementById('feedback');
            const quizControlsEl = document.getElementById('quizControls');
            if (quizContainerEl) quizContainerEl.style.display = 'block';
            if (inputContainerEl) inputContainerEl.style.display = 'block';
            // If answerInput is missing, create and append it
            if (inputContainerEl && !answerInputEl) {
                answerInputEl = document.createElement('input');
                answerInputEl.type = 'text';
                answerInputEl.id = 'answerInput';
                answerInputEl.className = 'answer-input';
                answerInputEl.placeholder = 'Type your answer...';
                answerInputEl.tabIndex = 0;
                inputContainerEl.appendChild(answerInputEl);
            }
        }
        // Update statistics
        // Only keep this updateStats function
        function updateStats() {
            // Home page stats
            if (document.getElementById('totalScore')) document.getElementById('totalScore').textContent = quiztate.score || 0;
            if (document.getElementById('currentStreak')) document.getElementById('currentStreak').textContent = quiztate.streak || 0;
            if (document.getElementById('questionsAnswered')) document.getElementById('questionsAnswered').textContent = quiztate.totalAnswered || 0;
            if (document.getElementById('achievementsCount')) document.getElementById('achievementsCount').textContent = achievements.filter(a => a.unlocked).length;
            if (document.getElementById('streakDisplay')) document.getElementById('streakDisplay').textContent = quiztate.streak || 0;
            // Progress bar
            let progress = 0;
            if (quiztate.questionCount > 0) {
                progress = ((quiztate.currentQuestionIndex) / quiztate.questionCount) * 100;
            }
            if (document.getElementById('progressFill')) document.getElementById('progressFill').style.width = progress + '%';

            // Achievements page stats
            if (document.getElementById('totalAchievements')) document.getElementById('totalAchievements').textContent = achievements.filter(a => a.unlocked).length;
            if (document.getElementById('difficultyQuizzes')) document.getElementById('difficultyQuizzes').textContent = `Easy: ${dq.easy || 0}, Medium: ${dq.medium || 0}, Hard: ${dq.hard || 0}`;
        }

        // Achievement system
        function checkAchievements() {
            if (quiztate.totalCorrect === 1) unlockAchievement('first_correct');
            
            // Streak achievements
            if (quiztate.streak === 3) unlockAchievement('streak_3');
            if (quiztate.streak === 5) unlockAchievement('streak_5');
            if (quiztate.streak === 10) unlockAchievement('streak_10');
            if (quiztate.streak === 15) unlockAchievement('streak_15');
            if (quiztate.streak === 20) unlockAchievement('streak_20');
            if (quiztate.streak === 25) unlockAchievement('streak_25');
            
            // Score achievements
            if (quiztate.score >= 50) unlockAchievement('score_50');
            if (quiztate.score >= 100) unlockAchievement('score_100');
            if (quiztate.score >= 250) unlockAchievement('score_250');
            if (quiztate.score >= 500) unlockAchievement('score_500');
            if (quiztate.score >= 1000) unlockAchievement('score_1000');
            
            // Correct answers achievements
            if (quiztate.totalCorrect >= 25) unlockAchievement('questions_25');
            if (quiztate.totalCorrect >= 50) unlockAchievement('questions_50');
            if (quiztate.totalCorrect >= 100) unlockAchievement('questions_100');
            if (quiztate.totalCorrect >= 200) unlockAchievement('questions_200');
            if (quiztate.totalCorrect >= 500) unlockAchievement('questions_500');
            
            // Speed achievements (consecutive first tries)
            if (quiztate.consecutiveFirstTry >= 10) unlockAchievement('speed_demon');
            if (quiztate.consecutiveFirstTry >= 20) unlockAchievement('lightning_fast');
        }
        
        function checkAllAchievements() {
            // Difficulty master achievements
            if (quiztate.difficultyQuizzes.easy >= 5) unlockAchievement('easy_master');
            if (quiztate.difficultyQuizzes.medium >= 5) unlockAchievement('medium_master');
            if (quiztate.difficultyQuizzes.hard >= 5) unlockAchievement('hard_master');
            
            // Explorer achievement
            if (quiztate.quizTypesPlayed.size >= 5) unlockAchievement('explorer');
            
            // Scholar achievement
            if (quiztate.lessonsRead.size >= 4) unlockAchievement('scholar');
            
            // Dedicated learner achievement
            if (quiztate.completedQuizzes >= 10) unlockAchievement('dedicated');
            
            // Champion achievement (unlock 20 others)
            const unlockedCount = achievements.filter(a => a.unlocked && a.id !== 'champion').length;
            if (unlockedCount >= 20) unlockAchievement('champion');
        }

        function unlockAchievement(achievementId) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                showCelebration(`üéâ Achievement Unlocked: <span style='color:#ffb347;'>${achievement.name}</span>! <span style='font-size:2em;'>${achievement.icon}</span>`);
                updateAchievementsCount();
                saveProgress();
            }
        }

        function updateAchievementsCount() {
            const unlockedCount = achievements.filter(a => a.unlocked).length;
            document.getElementById('achievementsCount').textContent = unlockedCount;
        }

        function displayAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';
            // Only show actual achievements, not stats like perfect quizzes, first try correct, etc.
            achievements.forEach(achievement => {
                // If the achievement is a stat, skip it
                const statIds = [
                    'perfect_quizzes', 'first_try_correct', 'consecutive_first_try', 'wrong_answers', 'quizzes_played', 'difficulty_quizzes'
                ];
                if (statIds.includes(achievement.id)) return;
                const achievementEl = document.createElement('div');
                achievementEl.className = `achievement${achievement.unlocked ? '' : ' locked'}`;
                achievementEl.innerHTML = `
                    <div class="achievement-icon">${achievement.unlocked ? achievement.icon : 'üîí'}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-description">${achievement.description}</div>
                `;
                achievementsList.appendChild(achievementEl);
            });
        }

        // Show celebration
        function showCelebration(message) {
            // Create confetti if not already present
            let confetti = document.getElementById('confetti');
            if (!confetti) {
                confetti = document.createElement('div');
                confetti.id = 'confetti';
                confetti.style.position = 'fixed';
                confetti.style.top = '0';
                confetti.style.left = '0';
                confetti.style.width = '100vw';
                confetti.style.height = '100vh';
                confetti.style.pointerEvents = 'none';
                confetti.style.zIndex = '2000';
                document.body.appendChild(confetti);
            }
            confetti.innerHTML = '';
            // Generate confetti pieces
            for (let i = 0; i < 60; i++) {
                const piece = document.createElement('div');
                piece.style.position = 'absolute';
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.top = Math.random() * 10 + 'vh';
                piece.style.width = '16px';
                piece.style.height = '16px';
                piece.style.borderRadius = '50%';
                piece.style.background = `hsl(${Math.random()*360},90%,60%)`;
                piece.style.opacity = '0.85';
                piece.style.transform = `scale(${0.7 + Math.random()*0.7})`;
                piece.style.transition = 'top 1.5s cubic-bezier(.4,2,.6,1), opacity 1.5s';
                confetti.appendChild(piece);
                setTimeout(() => {
                    piece.style.top = (80 + Math.random()*10) + 'vh';
                    piece.style.opacity = '0';
                }, 50 + Math.random()*200);
            }
            // Style and show the celebration overlay
            const celebration = document.getElementById('celebration');
            const celebrationMessage = document.getElementById('celebrationMessage');
            if (celebration) {
                celebration.style.display = 'flex';
                celebration.style.alignItems = 'center';
                celebration.style.justifyContent = 'center';
                celebration.style.flexDirection = 'column';
                celebration.style.position = 'fixed';
                celebration.style.top = '0';
                celebration.style.left = '0';
                celebration.style.width = '100vw';
                celebration.style.height = '100vh';
                celebration.style.background = 'rgba(255,255,255,0.93)';
                celebration.style.zIndex = '1500';
                celebration.style.animation = 'popCelebration 0.7s cubic-bezier(.4,2,.6,1)';
            }
            if (celebrationMessage) {
                // Extract achievement name and icon from the message string
                let nameMatch = message.match(/<span style='color:#ffb347;'>(.*?)<\/span>/);
                let iconMatch = message.match(/<span style='font-size:2em;'>(.*?)<\/span>/);
                let achievementName = nameMatch ? nameMatch[1] : '';
                let achievementIcon = iconMatch ? iconMatch[1] : '';
                // Modern card-style, animated gradient, big emoji, close button, glow
                celebrationMessage.innerHTML = `
                  <div class="achievement-card-celebration">
                    <button class="close-celebration-btn" onclick="hideCelebration()">‚úñ</button>
                    <div class="achievement-emoji-glow">${achievementIcon}</div>
                    <div class="achievement-title-gradient">Achievement Unlocked!</div>
                    <div class="achievement-name-glow">${achievementName}</div>
                    <div class="achievement-congrats">Congratulations!</div>
                  </div>
                `;
                celebrationMessage.style.textAlign = 'center';
                celebrationMessage.style.margin = '0 auto 20px auto';
                celebrationMessage.style.maxWidth = '90vw';
            }
            // Add modern styles if not already present
            if (!document.getElementById('achievement-celebration-style')) {
                const style = document.createElement('style');
                style.id = 'achievement-celebration-style';
                style.innerHTML = `
                .achievement-card-celebration {
                  background: rgba(255,255,255,0.98);
                  border-radius: 32px;
                  box-shadow: 0 8px 32px 0 rgba(76,199,255,0.25), 0 0 0 8px #ffb34722;
                  padding: 40px 32px 32px 32px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  position: relative;
                  animation: popCelebration 0.7s cubic-bezier(.4,2,.6,1);
                  min-width: 320px;
                  max-width: 90vw;
                }
                .achievement-emoji-glow {
                  font-size: 3.5em;
                  margin-bottom: 10px;
                  filter: drop-shadow(0 0 16px #ffb34788) drop-shadow(0 0 32px #4ac6ff66);
                  animation: emojiPop 1.2s cubic-bezier(.4,2,.6,1);
                }
                .achievement-title-gradient {
                  font-size: 1.5em;
                  font-weight: 900;
                  background: linear-gradient(90deg,#ffb347,#4ac6ff,#ff69b4,#10c168,#9021c7);
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                  background-clip: text;
                  text-fill-color: transparent;
                  margin-bottom: 8px;
                  letter-spacing: 1px;
                  animation: gradientMove 2.5s linear infinite;
                }
                .achievement-name-glow {
                  font-size: 2.1em;
                  font-weight: 800;
                  color: #ffb347;
                  text-shadow: 0 2px 12px #ffb34788, 0 0 8px #4ac6ff66;
                  margin-bottom: 8px;
                  letter-spacing: 1px;
                  animation: nameBounce 1.2s cubic-bezier(.4,2,.6,1);
                }
                .achievement-congrats {
                  font-size: 1.2em;
                  color: #10c168;
                  font-weight: 700;
                  margin-top: 8px;
                  letter-spacing: 0.5px;
                }
                .close-celebration-btn {
                  position: absolute;
                  top: 12px;
                  right: 18px;
                  background: none;
                  border: none;
                  font-size: 1.3em;
                  color: #9021c7;
                  cursor: pointer;
                  opacity: 0.7;
                  transition: opacity 0.2s;
                }
                .close-celebration-btn:hover {
                  opacity: 1;
                }
                @keyframes emojiPop {0%{transform:scale(0.7);opacity:0.2;}60%{transform:scale(1.2);opacity:1;}100%{transform:scale(1);opacity:1;}}
                @keyframes nameBounce {0%{transform:scale(0.7) rotate(-8deg);opacity:0.2;}40%{transform:scale(1.15) rotate(8deg);opacity:1;}60%{transform:scale(0.95) rotate(-4deg);}80%{transform:scale(1.05) rotate(4deg);}100%{transform:scale(1) rotate(0deg);opacity:1;}}
                @keyframes gradientMove {0%{background-position:0% 50%;}100%{background-position:100% 50%;}}
                `;
                document.head.appendChild(style);
            }
            // Remove confetti after 2s
            setTimeout(() => {
                if (confetti) confetti.innerHTML = '';
            }, 2000);
            // Add skibidi bounce animation style if not already present
            if (!document.getElementById('skibidi-bounce-style')) {
                const skibidiStyle = document.createElement('style');
                skibidiStyle.id = 'skibidi-bounce-style';
                skibidiStyle.innerHTML = `@keyframes skibidiBounce {0%{transform:scale(0.7) rotate(-8deg);opacity:0.2;}40%{transform:scale(1.15) rotate(8deg);opacity:1;}60%{transform:scale(0.95) rotate(-4deg);}80%{transform:scale(1.05) rotate(4deg);}100%{transform:scale(1) rotate(0deg);opacity:1;}}`;
                document.head.appendChild(skibidiStyle);
            }
        }
        /* Add popCelebration animation */
        const style = document.createElement('style');
        style.innerHTML = `@keyframes popCelebration {0%{transform:scale(0.7);opacity:0.2;}60%{transform:scale(1.1);opacity:1;}100%{transform:scale(1);opacity:1;}}`;
        document.head.appendChild(style);

        function hideCelebration() {
            document.getElementById('celebration').style.display = 'none';
        }

        // Lessons system
        function showLesson(lessonType) {
            // Track lesson as read
            quiztate.lessonsRead.add(lessonType);
            checkAllAchievements();
            saveProgress();
            const lessons = {
                addition: {
                    title: '‚ûï Addition Basics',
                    steps: [
                        {
                            title: 'What is Addition?',
                            content: 'Addition means putting things together! When we add, we combine groups to make a bigger group.',
                            example: 'If you have 3 apples üçéüçéüçé and someone gives you 2 more üçéüçé, you now have 5 apples total! 3 + 2 = 5'
                        },
                        {
                            title: 'Using Your Fingers',
                            content: 'Your fingers are great math tools! You can count on them to help solve addition problems.',
                            example: 'For 4 + 3: Hold up 4 fingers, then count up 3 more (5, 6, 7). The answer is 7!'
                        },
                        {
                            title: 'The Addition Symbol',
                            content: 'The plus sign (+) means "add" or "put together". The equal sign (=) means "the same as".',
                            example: '2 + 3 = 5 means "2 plus 3 equals 5" or "2 and 3 together make 5"'
                        },
                        {
                            title: 'Practice Tips',
                            content: 'Start with small numbers and work your way up. Remember: the order doesn\'t matter! 2 + 3 = 3 + 2',
                            example: 'Try these: 1+1=?, 2+2=?, 3+1=?, 1+4=?'
                        }
                    ]
                },
                subtraction: {
                    title: '‚ûñ Subtraction Basics',
                    steps: [
                        {
                            title: 'What is Subtraction?',
                            content: 'Subtraction means taking away! When we subtract, we remove some items from a group.',
                            example: 'If you have 5 cookies üç™üç™üç™üç™üç™ and eat 2 of them, you have 3 cookies left! 5 - 2 = 3'
                        },
                        {
                            title: 'Using Your Fingers',
                            content: 'Start with all your fingers up for the first number, then put down fingers for the number you\'re taking away.',
                            example: 'For 7 - 3: Hold up 7 fingers, put down 3 fingers, count what\'s left. You have 4!'
                        },
                        {
                            title: 'The Subtraction Symbol',
                            content: 'The minus sign (-) means "take away" or "subtract". The equal sign (=) shows the result.',
                            example: '8 - 3 = 5 means "8 take away 3 equals 5" or "8 minus 3 is 5"'
                        },
                        {
                            title: 'Practice Tips',
                            content: 'Always start with the bigger number first. You can\'t take away more than you have!',
                            example: 'Try these: 5-1=?, 6-2=?, 10-3=?, 9-4=?'
                        }
                    ]
                },
                multiplication: {
                    title: '‚úñÔ∏è Multiplication Basics',
                    steps: [
                        {
                            title: 'What is Multiplication?',
                            content: 'Multiplication is like repeated addition! It\'s a faster way to add the same number many times.',
                            example: '3 √ó 4 is the same as 3 + 3 + 3 + 3 = 12. We have 4 groups of 3!'
                        },
                        {
                            title: 'The Multiplication Symbol',
                            content: 'The times sign (√ó) means "groups of". We can also use the word "times".',
                            example: '2 √ó 5 means "2 groups of 5" or "5 + 5" which equals 10'
                        },
                        {
                            title: 'Skip Counting',
                            content: 'Skip counting helps with multiplication! Count by the same number each time.',
                            example: 'For 4 √ó 3, skip count by 3: 3, 6, 9, 12. So 4 √ó 3 = 12!'
                        },
                        {
                            title: 'Times Tables',
                            content: 'Start with easier tables like 2, 5, and 10. These have patterns that make them easier to remember!',
                            example: 'Table of 2: 2, 4, 6, 8, 10... Table of 5: 5, 10, 15, 20, 25...'
                        }
                    ]
                },
                division: {
                    title: '‚ûó Division Basics',
                    steps: [
                        {
                            title: 'What is Division?',
                            content: 'Division is sharing equally! When we divide, we split things into equal groups.',
                            example: 'If you have 12 cookies üç™ and want to share them equally among 3 friends, each friend gets 4 cookies! 12 √∑ 3 = 4'
                        },
                        {
                            title: 'Division as Repeated Subtraction',
                            content: 'Division is like subtracting the same number over and over until you reach zero.',
                            example: '15 √∑ 3 = ? Think: 15 - 3 = 12, 12 - 3 = 9, 9 - 3 = 6, 6 - 3 = 3, 3 - 3 = 0. We subtracted 5 times, so 15 √∑ 3 = 5!'
                        },
                        {
                            title: 'The Division Symbol',
                            content: 'The division sign (√∑) means "divided by" or "shared equally". We can also use / for division.',
                            example: '20 √∑ 4 = 5 means "20 divided by 4 equals 5" or "20 shared among 4 groups gives 5 in each group"'
                        },
                        {
                            title: 'Division and Multiplication',
                            content: 'Division is the opposite of multiplication! If you know multiplication tables, division becomes easier.',
                            example: 'If 4 √ó 6 = 24, then 24 √∑ 4 = 6 and 24 √∑ 6 = 4. They\'re like puzzle pieces that fit together!'
                        }
                    ]
                },
                fractions: {
                    title: 'üçï Understanding Fractions',
                    steps: [
                        {
                            title: 'What are Fractions?',
                            content: 'Fractions show parts of a whole! The top number (numerator) shows how many parts we have. The bottom number (denominator) shows how many parts the whole is divided into.',
                            example: 'If you eat 3 slices of a pizza cut into 8 pieces, you ate 3/8 of the pizza! üçï'
                        },
                        {
                            title: 'Reading Fractions',
                            content: 'We read fractions as "numerator over denominator" or use special names for common denominators.',
                            example: '1/2 = "one half", 1/4 = "one quarter", 3/4 = "three quarters", 1/3 = "one third"'
                        },
                        {
                            title: 'Equivalent Fractions',
                            content: 'Different fractions can represent the same amount! Like cutting a cake into different sized pieces.',
                            example: '1/2 = 2/4 = 4/8. Half a pizza is the same whether it\'s cut into 2, 4, or 8 pieces!'
                        },
                        {
                            title: 'Adding Simple Fractions',
                            content: 'When fractions have the same denominator, just add the numerators!',
                            example: '1/4 + 2/4 = 3/4. One quarter plus two quarters equals three quarters!'
                        }
                    ]
                },
                patterns: {
                    title: 'üé® Number Patterns',
                    steps: [
                        {
                            title: 'What are Patterns?',
                            content: 'Patterns are sequences that follow a rule! Numbers can create beautiful patterns just like colors or shapes.',
                            example: '2, 4, 6, 8, 10... This pattern adds 2 each time. Can you see it? üåà'
                        },
                        {
                            title: 'Growing Patterns',
                            content: 'Some patterns grow by adding or multiplying the same number each time.',
                            example: 'Adding pattern: 5, 10, 15, 20, 25 (add 5). Multiplying pattern: 2, 4, 8, 16, 32 (multiply by 2)'
                        },
                        {
                            title: 'Shrinking Patterns',
                            content: 'Patterns can also get smaller by subtracting or dividing!',
                            example: 'Subtracting: 50, 45, 40, 35, 30 (subtract 5). Dividing: 64, 32, 16, 8, 4 (divide by 2)'
                        },
                        {
                            title: 'Finding the Rule',
                            content: 'To find a pattern\'s rule, look at how each number changes to become the next number.',
                            example: 'In 3, 7, 11, 15, 19... each number is 4 more than the previous one. The rule is "add 4"!'
                        }
                    ]
                }
            };
            
            const lesson = lessons[lessonType];
            const lessonSteps = document.getElementById('lessonSteps');
            lessonSteps.innerHTML = `<h2 style="color: #4a90e2; text-align: center; margin-bottom: 30px;">${lesson.title}</h2>`;
            
            lesson.steps.forEach((step, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'lesson-step';
                stepEl.innerHTML = `
                    <h3>Step ${index + 1}: ${step.title}</h3>
                    <p>${step.content}</p>
                    <div class="example">
                        <strong>Example:</strong> ${step.example}
                    </div>
                `;
                lessonSteps.appendChild(stepEl);
            });
            
            document.getElementById('practiceBtn').style.display = 'block';
            document.getElementById('practiceBtn').onclick = () => startquiz(lessonType);
            showPage('lessonContent');
        }

        function startLessonPractice() {
            showPage('quiz');
        }

        // Handle Enter key in answer input and initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Apply saved theme
            loadSavedTheme();
            
            // Initialize stats safely
            const totalScoreEl = document.getElementById('totalScore');
            const currentStreakEl = document.getElementById('currentStreak');
            const questionsAnsweredEl = document.getElementById('questionsAnswered');
            const achievementsCountEl = document.getElementById('achievementsCount');
            if (totalScoreEl) totalScoreEl.textContent = '0';
            if (currentStreakEl) currentStreakEl.textContent = '0';
            if (questionsAnsweredEl) questionsAnsweredEl.textContent = '0';
            if (achievementsCountEl) achievementsCountEl.textContent = '0';
            
            // Set up answer input event listener
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkAnswer();
                    }
                });
            }
            
            // Initialize achievements display
            displayAchievements();
            
            // Update auth buttons on load
            updateAuthButtons();
            
            // Listen for authentication state changes
            window.addEventListener('storage', function(e) {
                if (e.key === 'currentUser' || e.key === 'username' || e.key === 'subscriptionPlan' || e.key === 'subscriptionJustCompleted') {
                    console.log('üîÑ Authentication/subscription state changed:', e.key, 'from', e.oldValue, 'to', e.newValue);
                    updateAuthButtons();
                    
                    // If subscription just completed, show success message
                    if (e.key === 'subscriptionJustCompleted' && e.newValue === 'true') {
                        setTimeout(() => {
                            const currentPlan = localStorage.getItem('subscriptionPlan');
                            if (currentPlan && currentPlan !== 'free') {
                                console.log('üéâ Showing subscription success notification');
                                // Optional: Show a brief success notification
                            }
                        }, 1000);
                    }
                }
            });
            
            // Listen for focus events to update auth state when user returns to tab
            window.addEventListener('focus', function() {
                console.log('üîç Tab focused, refreshing auth state');
                updateAuthButtons();
            });
        });

        // Load and apply saved theme
        function loadSavedTheme() {
            const savedThemeCSS = localStorage.getItem('themeCSS');
            if (savedThemeCSS) {
                let existingStyle = document.getElementById('theme-style');
                if (existingStyle) {
                    existingStyle.remove();
                }
                
                const style = document.createElement('style');
                style.id = 'theme-style';
                style.textContent = savedThemeCSS;
                document.head.appendChild(style);
            }
        }

        // (Removed duplicate updateStats)
        // Call loadProgress on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadProgress();
            
            // Check if user just completed a subscription
            if (localStorage.getItem('subscriptionJustCompleted') === 'true') {
                localStorage.removeItem('subscriptionJustCompleted');
                console.log('üéâ User just completed subscription, refreshing auth state');
                
                // Force immediate auth button update
                setTimeout(updateAuthButtons, 100);
                setTimeout(updateAuthButtons, 500); // Double check after 500ms
                setTimeout(updateAuthButtons, 1000); // Triple check after 1s
            }
            
            // Wait for userManager to be loaded before updating auth buttons
            setTimeout(updateAuthButtons, 100);
            
            // Set up periodic refresh of auth buttons for real-time updates
            setInterval(() => {
                updateAuthButtons();
            }, 2000); // Check every 2 seconds for auth state changes
        });
        
        // Check if trial has expired
        function checkTrialStatus() {
            const isTrialUser = localStorage.getItem('isTrialUser') === 'true';
            const trialEndDate = localStorage.getItem('trialEndDate');
            
            if (isTrialUser && trialEndDate) {
                const now = new Date();
                const trialEnd = new Date(trialEndDate);
                
                if (now > trialEnd) {
                    // Trial expired
                    localStorage.removeItem('isTrialUser');
                    localStorage.removeItem('trialStartDate');
                    localStorage.removeItem('trialEndDate');
                    localStorage.setItem('subscriptionPlan', 'free');
                    localStorage.setItem('hasUsedTrial', 'true');
                    
                    // Show trial expired notification
                    showTrialExpiredNotification();
                }
            }
        }
        
        // Show trial expired notification
        function showTrialExpiredNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(90deg, #ff6b6b, #fcb045);
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: inherit;
                font-weight: bold;
                text-align: center;
                max-width: 400px;
                animation: slideDown 0.5s ease;
            `;
            notification.innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 10px;">‚è∞ Trial Expired!</div>
                <div style="margin-bottom: 15px;">Your 7-day free trial has ended. Want to keep enjoying premium features?</div>
                <button onclick="window.location.href='subscription.html'" style="background: white; color: #ff6b6b; border: none; padding: 8px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-right: 10px;">Upgrade Now</button>
                <button onclick="this.parentElement.remove()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 15px; border-radius: 10px; font-weight: bold; cursor: pointer;">Continue Free</button>
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from { transform: translateX(-50%) translateY(-100%); }
                    to { transform: translateX(-50%) translateY(0); }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        // Update premium cards display based on subscription status
        function updatePremiumCards() {
            const premiumCards = document.querySelectorAll('.quiz-card.premium-locked');
            const isPremium = isPremiumUser();
            
            premiumCards.forEach(card => {
                if (isPremium) {
                    card.classList.remove('premium-locked');
                    // Update onclick handlers to regular quiz functions
                    const cardTitle = card.querySelector('h3').textContent.toLowerCase();
                    if (cardTitle.includes('fraction')) {
                        card.onclick = () => startQuiz('fractions');
                    } else if (cardTitle.includes('pattern')) {
                        card.onclick = () => startQuiz('patterns');
                    } else if (cardTitle.includes('word')) {
                        card.onclick = () => startQuiz('wordproblems');
                    } else if (cardTitle.includes('multiplication')) {
                        card.onclick = () => startLesson('multiplication');
                    }
                } else {
                    if (!card.classList.contains('premium-locked')) {
                        card.classList.add('premium-locked');
                        // Reset onclick handlers to premium handlers
                        const cardTitle = card.querySelector('h3').textContent.toLowerCase();
                        if (cardTitle.includes('fraction')) {
                            card.onclick = () => handlePremiumQuiz('fractions');
                        } else if (cardTitle.includes('pattern')) {
                            card.onclick = () => handlePremiumQuiz('patterns');
                        } else if (cardTitle.includes('word')) {
                            card.onclick = () => handlePremiumQuiz('wordproblems');
                        } else if (cardTitle.includes('multiplication')) {
                            card.onclick = () => handlePremiumLesson('multiplication');
                        }
                    }
                }
            });
        }
        
        // Show/hide login and logout buttons based on login state
        function updateAuthButtons() {
            console.log('üîÑ Updating authentication buttons...');
            
            // Check trial status first
            checkTrialStatus();
            
            // Update quiz and lesson card display
            updatePremiumCards();
            
            const isLoggedIn = userManager && userManager.isLoggedIn();
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const familyBtn = document.getElementById('familyBtn');
            const analyticsBtn = document.getElementById('analyticsBtn');
            const billingBtn = document.getElementById('billingBtn');
            const statusBtn = document.getElementById('statusBtn');
            
            console.log('üë§ User logged in:', isLoggedIn);
            
            if (isLoggedIn) {
                console.log('‚úÖ Showing authenticated user interface');
                
                // Hide login/register, show logout
                if (loginBtn) {
                    loginBtn.style.display = 'none';
                    console.log('Hidden login button');
                }
                if (registerBtn) {
                    registerBtn.style.display = 'none';
                    console.log('Hidden register button');
                }
                if (logoutBtn) {
                    logoutBtn.style.display = '';
                    console.log('Shown logout button');
                }
                
                // Show trial status if user is on trial
                const isTrialUser = localStorage.getItem('isTrialUser') === 'true';
                const trialEndDate = localStorage.getItem('trialEndDate');
                const trialStatus = document.getElementById('trial-status');
                const trialDaysLeft = document.getElementById('trial-days-left');
                
                if (isTrialUser && trialEndDate && trialStatus && trialDaysLeft) {
                    const daysLeft = Math.ceil((new Date(trialEndDate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysLeft > 0) {
                        trialStatus.style.display = 'block';
                        trialDaysLeft.textContent = daysLeft;
                        
                        // Change color based on days left
                        if (daysLeft <= 1) {
                            trialStatus.style.background = 'linear-gradient(90deg, #ff6b6b, #fcb045)';
                        } else if (daysLeft <= 3) {
                            trialStatus.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                        }
                    }
                } else if (trialStatus) {
                    trialStatus.style.display = 'none';
                }
                
                // Show billing button for any subscribed user (not free)
                const currentPlan = localStorage.getItem('subscriptionPlan') || 'free';
                console.log('üìã Current plan:', currentPlan);
                
                if (currentPlan !== 'free' && billingBtn) {
                    billingBtn.style.display = '';
                }
                
                // Show status button for all logged-in users
                if (statusBtn) {
                    statusBtn.style.display = '';
                }
                
                // Show premium feature buttons based on subscription tier
                const themesBtn = document.getElementById('themesBtn');
                const studyPlansBtn = document.getElementById('studyPlansBtn');
                const homeworkBtn = document.getElementById('homeworkBtn');
                const competitionBtn = document.getElementById('competitionBtn');
                const teacherBtn = document.getElementById('teacherBtn');
                
                // Advanced feature buttons
                const aiTutorBtn = document.getElementById('aiTutorBtn');
                const universityBtn = document.getElementById('universityBtn');
                const olympicsBtn = document.getElementById('olympicsBtn');
                const writingBtn = document.getElementById('writingBtn');
                const researchBtn = document.getElementById('researchBtn');
                
                // Premium+ features (themes)
                if (currentPlan === 'premium' || currentPlan === 'family' || currentPlan === 'tutor' || currentPlan === 'genius' || currentPlan === 'school') {
                    if (themesBtn) themesBtn.style.display = '';
                }
                
                // Family features
                if (currentPlan === 'family') {
                    if (familyBtn) familyBtn.style.display = '';
                }
                
                // Pro Tutor+ features (study plans, homework helper)
                if (currentPlan === 'tutor' || currentPlan === 'genius' || currentPlan === 'school') {
                    if (studyPlansBtn) studyPlansBtn.style.display = '';
                    if (homeworkBtn) homeworkBtn.style.display = '';
                }
                
                // Math Genius features (competition prep)
                if (currentPlan === 'genius' || currentPlan === 'school') {
                    if (competitionBtn) competitionBtn.style.display = '';
                }
                
                // Schools features (teacher dashboard)
                if (currentPlan === 'school') {
                    if (teacherBtn) teacherBtn.style.display = '';
                }
                
                // Pro Tutor+ features (AI Tutoring)
                if (currentPlan === 'tutor' || currentPlan === 'genius' || currentPlan === 'school') {
                    if (aiTutorBtn) aiTutorBtn.style.display = '';
                }
                
                // Math Genius+ features (University, Olympics, Writing, Research)
                if (currentPlan === 'genius' || currentPlan === 'school') {
                    if (universityBtn) universityBtn.style.display = '';
                    if (olympicsBtn) olympicsBtn.style.display = '';
                    if (writingBtn) writingBtn.style.display = '';
                    if (researchBtn) researchBtn.style.display = '';
                }
                
                // Analytics available for all premium plans
                if (isPremiumUser()) {
                    if (analyticsBtn) analyticsBtn.style.display = '';
                }
                
                console.log('‚úÖ Authentication UI updated for logged in user');
            } else {
                console.log('üö™ Showing guest user interface');
                
                // Show login/register, hide logout
                if (loginBtn) {
                    loginBtn.style.display = '';
                    console.log('Shown login button');
                }
                if (registerBtn) {
                    registerBtn.style.display = '';
                    console.log('Shown register button');
                }
                if (logoutBtn) {
                    logoutBtn.style.display = 'none';
                    console.log('Hidden logout button');
                }
                
                // Hide all premium features when logged out
                if (familyBtn) familyBtn.style.display = 'none';
                if (analyticsBtn) analyticsBtn.style.display = 'none';
                if (billingBtn) billingBtn.style.display = 'none';
                if (statusBtn) statusBtn.style.display = 'none';
                
                const themesBtn = document.getElementById('themesBtn');
                const studyPlansBtn = document.getElementById('studyPlansBtn');
                const homeworkBtn = document.getElementById('homeworkBtn');
                const competitionBtn = document.getElementById('competitionBtn');
                const teacherBtn = document.getElementById('teacherBtn');
                
                // Advanced feature buttons
                const aiTutorBtn = document.getElementById('aiTutorBtn');
                const universityBtn = document.getElementById('universityBtn');
                const olympicsBtn = document.getElementById('olympicsBtn');
                const writingBtn = document.getElementById('writingBtn');
                const researchBtn = document.getElementById('researchBtn');
                
                if (themesBtn) themesBtn.style.display = 'none';
                if (studyPlansBtn) studyPlansBtn.style.display = 'none';
                if (homeworkBtn) homeworkBtn.style.display = 'none';
                if (competitionBtn) competitionBtn.style.display = 'none';
                if (teacherBtn) teacherBtn.style.display = 'none';
                
                // Hide advanced features
                if (aiTutorBtn) aiTutorBtn.style.display = 'none';
                if (universityBtn) universityBtn.style.display = 'none';
                if (olympicsBtn) olympicsBtn.style.display = 'none';
                if (writingBtn) writingBtn.style.display = 'none';
                if (researchBtn) researchBtn.style.display = 'none';
                
                console.log('‚úÖ Authentication UI updated for guest user');
            }
        }

        // Enhanced logout function that preserves subscription data unless explicitly requested
        function logout(clearSubscription = false) {
            console.log('üö™ Logging out user...', clearSubscription ? 'with subscription cleanup' : 'preserving subscription');
            
            if (userManager) {
                userManager.logout();
            }
            
            // Clear authentication data but preserve subscription unless requested
            localStorage.removeItem('currentUser');
            localStorage.removeItem('username'); // Clean up old system too
            localStorage.removeItem('hasPaymentMethod'); // Clear payment info
            localStorage.removeItem('selectedPlan'); // Clear any pending selections
            
            // Only clear subscription data if explicitly requested (like when canceling subscription)
            if (clearSubscription) {
                localStorage.removeItem('subscriptionPlan');
                localStorage.removeItem('isTrialUser');
                localStorage.removeItem('trialStartDate');
                localStorage.removeItem('trialEndDate');
                localStorage.removeItem('hasUsedTrial');
                console.log('üóëÔ∏è Subscription data cleared');
            } else {
                console.log('üíæ Subscription data preserved');
            }
            
            console.log('‚úÖ User data cleared');
            
            // Immediately update auth buttons
            updateAuthButtons();
            
            // Redirect to welcome page
            alert('üëã You have been logged out successfully!\n\n' + 
                  (clearSubscription ? 'Your subscription has been cancelled.' : 'Your subscription is preserved for when you log back in.') +
                  '\n\nRedirecting to welcome page...');
            setTimeout(() => {
                window.location.href = 'welcome.html';
            }, 500);
        }
        
        // Safe logout that preserves subscription (default behavior)
        function safeLogout() {
            logout(false);
        }
        
        // Complete logout that clears everything (for subscription cancellation)
        function completeLogout() {
            logout(true);
        }
        
        // Function to restore user session after login
        function restoreUserSession(username) {
            console.log('üîÑ Restoring user session for:', username);
            
            // Set the current user
            localStorage.setItem('currentUser', username);
            
            // Check if user has existing subscription data
            const existingPlan = localStorage.getItem('subscriptionPlan');
            const existingTrial = localStorage.getItem('isTrialUser');
            
            console.log('Existing subscription data:', {
                plan: existingPlan,
                trial: existingTrial
            });
            
            // If no subscription plan exists, default to free
            if (!existingPlan && !existingTrial) {
                localStorage.setItem('subscriptionPlan', 'free');
                console.log('üÜì Set default plan to free');
            }
            
            // Preserve and validate subscription state
            preserveAuthenticationState();
            
            // Update the UI
            updateAuthButtons();
            updatePremiumState();
            
            // Show welcome back message with subscription status
            const currentPlan = localStorage.getItem('subscriptionPlan');
            const isTrialUser = localStorage.getItem('isTrialUser') === 'true';
            
            let statusMessage = '';
            if (isTrialUser) {
                const trialEndDate = localStorage.getItem('trialEndDate');
                if (trialEndDate) {
                    const daysLeft = Math.ceil((new Date(trialEndDate) - new Date()) / (1000 * 60 * 60 * 24));
                    statusMessage = `üéâ Welcome back! Your free trial has ${daysLeft} days remaining.`;
                }
            } else if (currentPlan && currentPlan !== 'free') {
                statusMessage = `üéâ Welcome back! Your ${currentPlan} subscription is active.`;
            } else {
                statusMessage = 'üéâ Welcome back! You\'re on the free plan.';
            }
            
            setTimeout(() => {
                showNotification(statusMessage, 'success');
            }, 1000);
            
            console.log('‚úÖ User session restored successfully');
        }
        
        // Function to show current subscription status
        function showSubscriptionStatus() {
            const currentUser = localStorage.getItem('currentUser');
            const subscriptionPlan = localStorage.getItem('subscriptionPlan') || 'free';
            const isTrialUser = localStorage.getItem('isTrialUser') === 'true';
            const trialEndDate = localStorage.getItem('trialEndDate');
            
            if (!currentUser) {
                showNotification('Please log in to view your subscription status.', 'warning');
                return;
            }
            
            let statusMessage = '';
            let statusType = 'info';
            
            if (isTrialUser && trialEndDate) {
                const now = new Date();
                const trialEnd = new Date(trialEndDate);
                const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                
                if (daysLeft > 0) {
                    statusMessage = `üéÅ Free Trial Active: ${daysLeft} days remaining\nEnjoy all premium features!`;
                    statusType = 'success';
                } else {
                    statusMessage = '‚è∞ Free trial has ended.\nUpgrade to continue premium features!';
                    statusType = 'warning';
                }
            } else {
                switch(subscriptionPlan) {
                    case 'premium':
                        statusMessage = '‚≠ê Premium Plan Active\nUnlimited quizzes and premium features!';
                        statusType = 'success';
                        break;
                    case 'family':
                        statusMessage = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Plan Active\nUp to 6 family accounts with full features!';
                        statusType = 'success';
                        break;
                    case 'tutor':
                        statusMessage = 'üßë‚Äçüè´ Pro Tutor Plan Active\nAI tutoring with ChatGPT included!';
                        statusType = 'success';
                        break;
                    case 'genius':
                        statusMessage = 'üß† Math Genius Plan Active\nAll features including competition prep!';
                        statusType = 'success';
                        break;
                    case 'school':
                        statusMessage = 'üè´ Schools Plan Active\nFull classroom management features!';
                        statusType = 'success';
                        break;
                    case 'free':
                    default:
                        statusMessage = 'üÜì Free Plan Active\n5 quizzes per day. Upgrade for unlimited access!';
                        statusType = 'info';
                        break;
                }
            }
            
            showNotification(statusMessage, statusType);
        }

        // Safe update achievements count
        function updateAchievementsCount() {
            const achievementsCountEl = document.getElementById('achievementsCount');
            if (achievementsCountEl) {
                const unlockedCount = achievements.filter(a => a.unlocked).length;
                achievementsCountEl.textContent = unlockedCount;
            }
        }

        // Safe show celebration
function showCelebration(message) {
    const celebrationEl = document.getElementById('celebration');
    const celebrationMessageEl = document.getElementById('celebrationMessage');

    // Try to extract achievement name and icon from the message string (if present)
    let nameMatch = message.match(/<span style='color:#ffb347;'>(.*?)<\/span>/);
    let iconMatch = message.match(/<span style='font-size:2em;'>(.*?)<\/span>/);
    let achievementName = nameMatch ? nameMatch[1] : message;
    let achievementIcon = iconMatch ? iconMatch[1] : '';

    // Fallback: if no HTML, just show the message as the name
    if (!achievementIcon && !achievementName) achievementName = message;

    if (celebrationMessageEl) {
        celebrationMessageEl.innerHTML = `
            <div style="font-size: 3em; margin-bottom: 10px;">${achievementIcon}</div>
            <div style="font-size: 1.5em; color: #ffb347; font-weight: bold; margin-bottom: 8px;">${achievementName}</div>
            <div style="font-size: 1.1em; color: #4ac6ff;">Achievement Unlocked!</div>
        `;
    }
    if (celebrationEl) celebrationEl.style.display = 'flex';
}

        // Safe hide celebration
        function hideCelebration() {
            const celebrationEl = document.getElementById('celebration');
            if (celebrationEl) celebrationEl.style.display = 'none';
        }

        // Safe display achievements
        function displayAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) return;
            
            achievementsList.innerHTML = '';
            
            achievements.forEach(achievement => {
                const achievementEl = document.createElement('div');
                
                // Check if user has access to this achievement based on subscription
                let hasAccess = true;
                if (achievement.premium && !isPremiumUser()) hasAccess = false;
                if (achievement.proTutor && !isAITutorUser()) hasAccess = false;
                if (achievement.genius && !isGeniusUser()) hasAccess = false;
                
                let className = 'achievement';
                let iconDisplay = achievement.unlocked ? achievement.icon : 'üîí';
                let nameDisplay = achievement.name;
                let descriptionDisplay = achievement.description;
                
                if (!hasAccess) {
                    className += ' premium-locked-achievement';
                    iconDisplay = 'üîí';
                    if (achievement.premium) nameDisplay += ' (Premium)';
                    if (achievement.proTutor) nameDisplay += ' (AI Tutor)';
                    if (achievement.genius) nameDisplay += ' (Genius)';
                    descriptionDisplay = `Upgrade to unlock this achievement! ${achievement.description}`;
                } else if (!achievement.unlocked) {
                    className += ' locked';
                }
                
                achievementEl.className = className;
                achievementEl.innerHTML = `
                    <div class="achievement-icon">${iconDisplay}</div>
                    <h4>${nameDisplay}</h4>
                    <p>${descriptionDisplay}</p>
                    ${!hasAccess ? '<div class="upgrade-badge">Upgrade Required</div>' : ''}
                `;
                achievementsList.appendChild(achievementEl);
            });
        }

        // Safe show next question
        function showNextQuestion() {
            if (quiztate.currentQuestionIndex >= quiztate.questions.length) {
                endQuiz();
                return;
            }
            
            const question = quiztate.questions[quiztate.currentQuestionIndex];
            const questionText = question.questionText || `${question.a} ${question.operator} ${question.b} = ?`;
            
            const quizContainerEl = document.getElementById('quizContainer');
            const questionDisplayEl = document.getElementById('questionDisplay');
            const currentQuestionEl = document.getElementById('currentQuestion');
            const inputContainerEl = document.getElementById('inputContainer');
            const answerInputEl = document.getElementById('answerInput');
            const quizButtonsEl = document.getElementById('quizButtons');
            const feedbackEl = document.getElementById('feedback');
            const quizControlsEl = document.getElementById('quizControls');
            
            // Show the entire quiz container first
            if (quizContainerEl) quizContainerEl.style.display = 'block';
            
            // Show all quiz elements when starting a question
            if (questionDisplayEl) {
                questionDisplayEl.textContent = questionText;
                questionDisplayEl.style.display = 'flex';
            }
            if (currentQuestionEl) currentQuestionEl.textContent = quiztate.currentQuestionIndex + 1;
            if (inputContainerEl) inputContainerEl.style.display = 'block';
            if (answerInputEl) {
                answerInputEl.value = '';
                answerInputEl.focus();
            }
            if (quizButtonsEl) quizButtonsEl.style.display = 'block';
            if (feedbackEl) {
                feedbackEl.textContent = '';
                feedbackEl.className = 'feedback';
                feedbackEl.style.display = 'flex';
            }
            if (quizControlsEl) quizControlsEl.style.display = 'block';
            
            quiztate.currentAnswer = question.answer;
            quiztate.attempts = 0;
        }

        // Safe check answer function
        function checkAnswer() {
            const answerInputEl = document.getElementById('answerInput');
            const feedbackEl = document.getElementById('feedback');
            
            if (!answerInputEl || !feedbackEl) return;
            
            const userAnswer = answerInputEl.value.trim();
            let isCorrect = false;
            
            // Handle different answer types
            if (quiztate.currentquiz === 'comparison') {
                isCorrect = userAnswer === quiztate.currentAnswer.toString();
            } else {
                const numAnswer = parseFloat(userAnswer);
                if (isNaN(numAnswer) && quiztate.currentquiz !== 'comparison') {
                    feedbackEl.textContent = 'ü§î Please enter a number!';
                    feedbackEl.className = 'feedback incorrect shake';
                    setTimeout(() => feedbackEl.classList.remove('shake'), 500);
                    return;
                }
                isCorrect = Math.abs(numAnswer - quiztate.currentAnswer) < 0.1;
            }
            
            quiztate.attempts++;
            quiztate.totalAnswered++;
            
            if (isCorrect) {
                // Correct answer!
                quiztate.totalCorrect++;
                quiztate.streak++;
                if (quiztate.streak > quiztate.maxStreak) {
                    quiztate.maxStreak = quiztate.streak;
                }
                
                // Track first try correct answers
                if (quiztate.attempts === 1) {
                    quiztate.firstTryCorrect++;
                    quiztate.consecutiveFirstTry++;
                } else {
                    quiztate.consecutiveFirstTry = 0;
                }
                
                // Track if started with wrong answer but recovered
                if (quiztate.currentQuestionIndex === 0 && quiztate.attempts > 1) {
                    quiztate.startedWithWrongAnswer = true;
                }
                
                // Calculate points based on streak and difficulty
                let points = 10;
                if (quiztate.difficulty === 'medium') points = 15;
                if (quiztate.difficulty === 'hard') points = 20;
                if (quiztate.streak >= 3) points *= 1.5;
                if (quiztate.attempts === 1) points *= 1.2; // First try bonus
                
                quiztate.score += Math.floor(points);
                
                const encouragement = [
                    "üéâ Excellent work!",
                    "‚≠ê Amazing job!",
                    "üåü Fantastic!",
                    "üéØ Perfect!",
                    "üöÄ Outstanding!",
                    "üí´ Brilliant!",
                    "üèÜ Superb!"
                ];
                
                feedbackEl.textContent = encouragement[Math.floor(Math.random() * encouragement.length)] + 
                    ` +${Math.floor(points)} points!`;
                feedbackEl.className = 'feedback correct bounce';
                
                // Check achievements
                checkAchievements();
                
                // Auto-clear input and move to next question after 1.5 seconds
                answerInputEl.value = '';
                setTimeout(() => {
                    quiztate.currentQuestionIndex++;
                    showNextQuestion();
                    updateStats();
                }, 1500);
                
            } else {
                // Wrong answer
                quiztate.streak = 0;
                quiztate.consecutiveFirstTry = 0;
                quiztate.wrongAnswers++;
                
                if (quiztate.attempts < 2) {
                    // First wrong attempt - give hint
                    const hints = [
                        "ü§î Not quite! Try again!",
                        "üí° Close, but try once more!",
                        "üéØ Think about it again!",
                        "üîÑ Give it another shot!"
                    ];
                    feedbackEl.textContent = hints[Math.floor(Math.random() * hints.length)];
                    feedbackEl.className = 'feedback incorrect shake';
                    
                } else {
                    // Second wrong attempt - show answer and move on
                    feedbackEl.textContent = `üòä The answer was ${quiztate.currentAnswer}. Let's try the next one!`;
                    feedbackEl.className = 'feedback incorrect';
                    
                    // Auto-clear input and move to next question after 2 seconds
                    answerInputEl.value = '';
                    setTimeout(() => {
                        quiztate.currentQuestionIndex++;
                        showNextQuestion();
                    }, 2000);
                }
            }
            
            updateStats();
            
            // Remove animation class after animation
            setTimeout(() => {
                feedbackEl.classList.remove('bounce', 'shake');
            }, 1000);
        }

        // Safe begin quiz function
        function beginQuiz() {
            generateQuestions();
            generateQuestions();
            quiztate.currentQuestionIndex = 0;
            quiztate.attempts = 0;
            quiztate.wrongAnswers = 0;
            quiztate.startedWithWrongAnswer = false;
            quiztate.consecutiveFirstTry = 0;

            // Track quiz type played
            quiztate.quizTypesPlayed.add(quiztate.currentquiz);

            // Set up quiz page
            const titles = {
                'subtraction': 'ü¶Å Subtraction Safari',
                'multiplication': '‚öîÔ∏è Multiplication Quest',
                'division': 'üè∞ Division Castle',
                'mixed': 'üåü Mixed Math Mayhem',
                'comparison': '‚öñÔ∏è Number Detective',
                'fractions': 'üçï Fraction Pizza Party',
                'patterns': 'üé® Pattern Master',
                'wordproblems': 'üìñ Story Math Heroes'
            };

            const quizTitleEl = document.getElementById('quizTitle');
            const totalQuestionsEl = document.getElementById('totalQuestions');
            const streakDisplayEl = document.getElementById('streakDisplay');
            const quizContainerEl = document.getElementById('quizContainer');
            const inputContainerEl = document.getElementById('inputContainer');
            let answerInputEl = document.getElementById('answerInput');
            const quizButtonsEl = document.getElementById('quizButtons');
            const feedbackEl = document.getElementById('feedback');
            const quizControlsEl = document.getElementById('quizControls');
            const fontSizeBtn = document.getElementById('increaseFontBtn');
            // Restore all quiz UI elements
            if (quizContainerEl) quizContainerEl.style.display = 'block';
            if (inputContainerEl) inputContainerEl.style.display = 'block';
            // If answerInput is missing, create and append it
            if (inputContainerEl && !answerInputEl) {
                answerInputEl = document.createElement('input');
                answerInputEl.type = 'text';
                answerInputEl.id = 'answerInput';
                answerInputEl.className = 'answer-input';
                answerInputEl.placeholder = 'Type your answer...';
                answerInputEl.tabIndex = 0;
                inputContainerEl.appendChild(answerInputEl);
            }
            // Always get the latest reference and show/focus
            answerInputEl = document.getElementById('answerInput');
            if (answerInputEl) {
                answerInputEl.style.display = 'inline-block';
                answerInputEl.value = '';
                answerInputEl.focus();
            }
            if (quizButtonsEl) quizButtonsEl.style.display = 'flex';
            if (feedbackEl) {
                feedbackEl.style.display = 'flex';
                feedbackEl.textContent = '';
            }
            if (quizControlsEl) quizControlsEl.style.display = 'flex';
            // Restore font size button if present
            if (fontSizeBtn) fontSizeBtn.style.display = 'inline-block';
            // Hide end overlay if present
            const endOverlay = document.getElementById('endOverlay');
            if (endOverlay) endOverlay.style.display = 'none';

            if (quizTitleEl) quizTitleEl.textContent = titles[quiztate.currentquiz];
            if (totalQuestionsEl) totalQuestionsEl.textContent = quiztate.questionCount;
            if (streakDisplayEl) streakDisplayEl.textContent = quiztate.streak;

            showPage('quiz');
            showNextQuestion();
        }

        // Safe end quiz function
        function endQuiz() {
            const accuracy = quiztate.totalAnswered > 0 ? 
                Math.round((quiztate.totalCorrect / quiztate.totalAnswered) * 100) : 0;
            
            quiztate.completedQuizzes++;
            quiztate.difficultyQuizzes[quiztate.difficulty]++;
            
            // Check for perfect quiz
            if (accuracy === 100) {
                quiztate.perfectQuizzes.push({
                    type: quiztate.currentquiz,
                    difficulty: quiztate.difficulty,
                    questions: quiztate.questionCount
                });
            }
            
            // Check for quiz-specific achievements
            if (accuracy >= 80) {
                if (quiztate.currentquiz === 'addition') unlockAchievement('addition_expert');
                if (quiztate.currentquiz === 'subtraction') unlockAchievement('subtraction_expert');
                if (quiztate.currentquiz === 'multiplication') unlockAchievement('multiplication_expert');
                if (quiztate.currentquiz === 'division') unlockAchievement('division_expert');
                if (quiztate.currentquiz === 'mixed') unlockAchievement('mixed_expert');
                if (quiztate.currentquiz === 'comparison') unlockAchievement('comparison_expert');
                if (quiztate.currentquiz === 'fractions') unlockAchievement('fractions_expert');
                if (quiztate.currentquiz === 'patterns') unlockAchievement('patterns_expert');
                if (quiztate.currentquiz === 'wordproblems') unlockAchievement('wordproblems_expert');
            }
            
            // Check various achievements
            unlockAchievement('first_quiz');
            
            // Perfect score achievements
            if (accuracy === 100) {
                if (quiztate.questionCount >= 5) unlockAchievement('perfect_5');
                if (quiztate.questionCount >= 10) unlockAchievement('perfect_10');
                if (quiztate.questionCount >= 20) unlockAchievement('perfect_20');
            }
            
            // Endurance achievements
            if (quiztate.questionCount >= 50) unlockAchievement('endurance_50');
            if (quiztate.questionCount >= 100) unlockAchievement('endurance_100');
            
            // Comeback achievement
            if (quiztate.startedWithWrongAnswer && accuracy === 100) {
                unlockAchievement('comeback_kid');
            }
            
            // Persistent achievement
            if (quiztate.wrongAnswers >= 5) {
                unlockAchievement('persistent');
            }
            
            // Final achievement checks
            checkAllAchievements();
            function unlockAchievement(achievementId) {
    const achievement = achievements.find(a => a.id === achievementId);
    if (achievement && !achievement.unlocked) {
        achievement.unlocked = true;
        showCelebration(`üéâ Achievement Unlocked: ${achievement.name}! üéâ`);
        updateAchievementsCount();
        saveProgress(); // Add this line
    }
}
            // Endurance achievements
            if (quiztate.questionCount >= 50) unlockAchievement('endurance_50');
            if (quiztate.questionCount >= 100) unlockAchievement('endurance_100');
            // Comeback achievement
            if (quiztate.startedWithWrongAnswer && accuracy === 100) {
                unlockAchievement('comeback_kid');
            }
            // Persistent achievement
            if (quiztate.wrongAnswers >= 5) {
                unlockAchievement('persistent');
            }
            // Final achievement checks
            checkAllAchievements();
            saveProgress();
            // Show completion message safely
            const questionDisplayEl = document.getElementById('questionDisplay');
            const answerInputEl = document.getElementById('answerInput');
            const feedbackEl = document.getElementById('feedback');
            
            const message = `
                <h2>üéâ Quiz Complete! üéâ</h2>
                <div style="margin: 30px 0;">
                    <div style="font-size: 1.2em; margin: 10px 0;">
                        <strong>Score:</strong> ${quiztate.score} points
                    </div>
                    <div style="font-size: 1.2em; margin: 10px 0;">
                        <strong>Accuracy:</strong> ${accuracy}%
                    </div>
                    <div style="font-size: 1.2em; margin: 10px 0;">
                        <strong>Best Streak:</strong> ${quiztate.maxStreak}
                    </div>
                </div>
            `;
            
            if (questionDisplayEl) questionDisplayEl.innerHTML = message;
            if (answerInputEl) answerInputEl.style.display = 'none';
            if (feedbackEl) feedbackEl.textContent = '';
            
            // Remove submit and skip buttons from the DOM when quiz is completed
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn && submitBtn.parentNode) submitBtn.parentNode.removeChild(submitBtn);
            const skipBtn = document.getElementById('skipBtn');
            if (skipBtn && skipBtn.parentNode) skipBtn.parentNode.removeChild(skipBtn);
        }
    </script>
    <script src="user-manager.js"></script>
    <script>
        // Check authentication before loading main app
        function checkAuthentication() {
            // Wait for userManager to load before checking
            if (typeof userManager === 'undefined') {
                return true; // Allow page to load, userManager might still be loading
            }
            
            const isLoggedIn = localStorage.getItem('username') || 
                             sessionStorage.getItem('username') ||
                             userManager.isLoggedIn();
            
            if (!isLoggedIn) {
                // Only redirect if we're sure the user is not logged in
                setTimeout(() => {
                    window.location.href = 'welcome.html';
                }, 1000); // Give time for the page to stabilize
                return false;
            }
            return true;
        }
        
        // Function to update premium state of all locked elements
        function updatePremiumState() {
            const isPremium = isPremiumUser();
            const isFamilyPlan = isFamilyPlanUser();
            const isAITutor = isAITutorUser();
            const isGenius = isGeniusUser();
            
            // Get all premium-locked quiz cards
            const premiumLockedCards = document.querySelectorAll('.quiz-card.premium-locked');
            
            premiumLockedCards.forEach(card => {
                if (isPremium) {
                    // Remove premium-locked class and update onclick
                    card.classList.remove('premium-locked');
                    
                    // Get the quiz/lesson type from the onclick attribute
                    const onclickAttr = card.getAttribute('onclick');
                    if (onclickAttr) {
                        if (onclickAttr.includes('handlePremiumQuiz')) {
                            // Extract quiz type and update to regular quiz handler
                            const match = onclickAttr.match(/handlePremiumQuiz\('(\w+)'\)/);
                            if (match) {
                                const quizType = match[1];
                                card.setAttribute('onclick', `startQuiz('${quizType}')`);
                            }
                        } else if (onclickAttr.includes('handlePremiumLesson')) {
                            // Extract lesson type and update to regular lesson handler
                            const match = onclickAttr.match(/handlePremiumLesson\('(\w+)'\)/);
                            if (match) {
                                const lessonType = match[1];
                                card.setAttribute('onclick', `showLesson('${lessonType}')`);
                            }
                        }
                    }
                    
                    // Add unlocked styling
                    card.style.cursor = 'pointer';
                    card.style.opacity = '1';
                    
                    // Add premium user indicator
                    if (!card.querySelector('.premium-unlocked-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'premium-unlocked-badge';
                        badge.innerHTML = '‚ú® UNLOCKED';
                        badge.style.cssText = `
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: linear-gradient(90deg, #28a745, #20c997);
                            color: white;
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 0.7rem;
                            font-weight: bold;
                            z-index: 5;
                        `;
                        card.style.position = 'relative';
                        card.appendChild(badge);
                    }
                }
            });
            
            // Handle AI Tutor locked cards
            const aiTutorCards = document.querySelectorAll('.quiz-card.ai-tutor-locked');
            aiTutorCards.forEach(card => {
                if (isAITutor) {
                    card.classList.remove('ai-tutor-locked');
                    card.style.cursor = 'pointer';
                    card.style.opacity = '1';
                    
                    // Add AI Tutor unlocked badge
                    if (!card.querySelector('.ai-tutor-unlocked-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'ai-tutor-unlocked-badge';
                        badge.innerHTML = 'ü§ñ AI TUTOR';
                        badge.style.cssText = `
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: linear-gradient(90deg, #6f42c1, #8b5cf6);
                            color: white;
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 0.7rem;
                            font-weight: bold;
                            z-index: 5;
                        `;
                        card.style.position = 'relative';
                        card.appendChild(badge);
                    }
                }
            });
            
            // Handle Genius locked cards
            const geniusCards = document.querySelectorAll('.quiz-card.genius-locked');
            geniusCards.forEach(card => {
                if (isGenius) {
                    card.classList.remove('genius-locked');
                    card.style.cursor = 'pointer';
                    card.style.opacity = '1';
                    
                    // Add Genius unlocked badge
                    if (!card.querySelector('.genius-unlocked-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'genius-unlocked-badge';
                        badge.innerHTML = 'üß† GENIUS';
                        badge.style.cssText = `
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: linear-gradient(90deg, #dc3545, #e74c3c);
                            color: white;
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 0.7rem;
                            font-weight: bold;
                            z-index: 5;
                        `;
                        card.style.position = 'relative';
                        card.appendChild(badge);
                    }
                }
            });
            
            // Update navigation menu premium buttons
            const premiumNavButtons = document.querySelectorAll('.nav-tab.premium-feature-btn');
            premiumNavButtons.forEach(btn => {
                if (isPremium) {
                    btn.classList.remove('premium-feature-btn');
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    
                    // Re-enable click functionality
                    const btnText = btn.textContent.toLowerCase();
                    if (btnText.includes('themes')) {
                        btn.onclick = () => showPage('themes');
                    } else if (btnText.includes('analytics')) {
                        btn.onclick = () => showPage('analytics');
                    } else if (btnText.includes('family')) {
                        if (isFamilyPlan) {
                            btn.onclick = () => showPage('family-dashboard');
                        }
                    }
                }
            });
            
            // Show success message for newly upgraded users
            const justUpgraded = localStorage.getItem('justUpgraded');
            if (justUpgraded === 'true' && isPremium) {
                localStorage.removeItem('justUpgraded');
                showUpgradeSuccessMessage();
            }
        }
        
        function showUpgradeSuccessMessage() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: 'Comic Sans MS', Arial, sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(145deg, #ffffff, #f8f9fa);
                    border-radius: 25px;
                    padding: 40px;
                    max-width: 500px;
                    text-align: center;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    border: 3px solid #28a745;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #28a745; margin: 0 0 15px 0; font-size: 2rem;">Welcome to Premium!</h2>
                    <p style="color: #666; margin: 15px 0; font-size: 1.1rem;">
                        All premium features are now unlocked! Look for the ‚ú® badges on previously locked content.
                    </p>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 15px; margin: 20px 0;">
                        <p style="color: #155724; margin: 0; font-weight: bold;">
                            üöÄ Your premium features include:
                        </p>
                        <ul style="color: #155724; text-align: left; margin: 10px 0; padding-left: 20px;">
                            <li>‚ú® All quiz topics unlocked</li>
                            <li>üé® Custom themes & colors</li>
                            <li>üìä Detailed analytics</li>
                            <li>üìñ Premium lessons</li>
                            <li>üèÜ Advanced achievements</li>
                        </ul>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove();" style="
                        background: linear-gradient(90deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 1.1rem;
                        cursor: pointer;
                        font-weight: bold;
                        font-family: inherit;
                    ">
                        üöÄ Start Learning!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }, 10000);
        }
        
        // Manual function to update premium state (can be called from other pages)
        function refreshPremiumState() {
            updatePremiumState();
        }
        
        // Make it globally available
        window.refreshPremiumState = refreshPremiumState;
        
        // Update auth buttons when page loads
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing MathsMayhem with enhanced authentication...');
            
            // Wait a moment for userManager to load, then check auth
            setTimeout(() => {
                // Enhanced authentication check that preserves subscription data
                const currentUser = localStorage.getItem('currentUser');
                const legacyUsername = localStorage.getItem('username') || sessionStorage.getItem('username');
                const isManagerLoggedIn = typeof userManager !== 'undefined' && userManager.isLoggedIn();
                
                const isLoggedIn = currentUser || legacyUsername || isManagerLoggedIn;
                
                console.log('üîê Authentication check:', {
                    currentUser: !!currentUser,
                    legacyUsername: !!legacyUsername,
                    userManager: isManagerLoggedIn,
                    finalResult: isLoggedIn
                });
                
                if (!isLoggedIn) {
                    console.log('üë§ No user detected, redirecting to welcome');
                    // Only redirect if no user data exists at all
                    const hasAnySubscription = localStorage.getItem('subscriptionPlan') || localStorage.getItem('isTrialUser');
                    
                    if (!hasAnySubscription) {
                        window.location.href = 'welcome.html';
                        return;
                    } else {
                        // User has subscription data but no login - this is the bug!
                        console.log('‚ö†Ô∏è Found subscription data without login - preserving user session');
                        // Don't redirect, just update the UI
                    }
                }
                
                // Preserve authentication and subscription state
                preserveAuthenticationState();
                
                // User is logged in or has subscription data, proceed with normal setup
                updateAuthButtons();
                updateQuizCountDisplay();
                // Update premium state
                updatePremiumState();
                
                // Load achievements
                loadAchievements();
                
                console.log('‚úÖ MathsMayhem fully initialized');
            }, 100);
        });
        
        // Function to preserve authentication state and subscription data
        function preserveAuthenticationState() {
            console.log('üîê Preserving authentication state...');
            
            const currentUser = localStorage.getItem('currentUser');
            const subscriptionPlan = localStorage.getItem('subscriptionPlan');
            const isTrialUser = localStorage.getItem('isTrialUser') === 'true';
            const trialEndDate = localStorage.getItem('trialEndDate');
            
            console.log('Current auth state:', {
                user: currentUser,
                plan: subscriptionPlan,
                trial: isTrialUser,
                trialEnd: trialEndDate
            });
            
            // If user exists but no subscription plan, set to free
            if (currentUser && !subscriptionPlan && !isTrialUser) {
                console.log('üÜì Setting default plan to free');
                localStorage.setItem('subscriptionPlan', 'free');
            }
            
            // Validate trial status
            if (isTrialUser && trialEndDate) {
                const now = new Date();
                const trialEnd = new Date(trialEndDate);
                
                if (now > trialEnd) {
                    console.log('‚è∞ Trial expired, converting to free plan');
                    localStorage.removeItem('isTrialUser');
                    localStorage.removeItem('trialStartDate');
                    localStorage.removeItem('trialEndDate');
                    localStorage.setItem('subscriptionPlan', 'free');
                    
                    // Show trial expiration notification
                    setTimeout(() => {
                        showNotification('Your 7-day free trial has ended. Upgrade to continue enjoying premium features!', 'info');
                    }, 2000);
                }
            }
            
            // Ensure user manager is synchronized
            if (typeof userManager !== 'undefined' && currentUser) {
                console.log('‚úÖ User manager synchronized with localStorage');
            }
        }

        // Listen for storage changes to update premium state when subscription changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'subscriptionPlan' || e.key === 'isTrialUser') {
                updatePremiumState();
            }
        });
        
        // Also check for premium state updates when the page becomes visible again
        // (useful when returning from billing page)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(() => {
                    updatePremiumState();
                }, 500);
            }
        });
        
        // Supporting functions for advanced features
        window.startAdvancedTopic = function(topic) {
            const topics = {
                'calculus': { title: 'Advanced Calculus', content: 'Multivariable calculus, vector analysis, and differential equations' },
                'linear-algebra': { title: 'Linear Algebra', content: 'Vector spaces, eigenvalues, and matrix transformations' },
                'abstract-algebra': { title: 'Abstract Algebra', content: 'Group theory, ring theory, and field extensions' },
                'real-analysis': { title: 'Real Analysis', content: 'Limits, continuity, and convergence theorems' },
                'topology': { title: 'Topology', content: 'Open sets, continuous functions, and topological spaces' },
                'number-theory': { title: 'Number Theory', content: 'Prime numbers, modular arithmetic, and Diophantine equations' }
            };
            const selectedTopic = topics[topic];
            if (selectedTopic) {
                alert(`üéì ${selectedTopic.title}\n\n${selectedTopic.content}\n\nThis would open a full interactive university-level lesson!`);
            }
        };
        
        window.startOlympiadTraining = function(competition) {
            const competitions = {
                'imo': 'International Mathematical Olympiad - Advanced proof-based problems',
                'usamo': 'USA Mathematical Olympiad - Complex geometric and algebraic proofs',
                'aime': 'American Invitational Mathematics Examination - Intermediate problem solving',
                'amc': 'AMC Preparation - Foundation building for competition mathematics'
            };
            if (competitions[competition]) {
                alert(`ü•á ${competitions[competition]}\n\nThis would provide comprehensive olympiad training!`);
            }
        };
        
        window.openWritingTool = function(toolType) {
            const tools = {
                'research-papers': 'Research Paper Writing Assistant',
                'thesis-support': 'Thesis & Dissertation Support',
                'proof-writing': 'Mathematical Proof Writing',
                'academic-proposals': 'Grant & Research Proposals',
                'college-applications': 'College Application Essays',
                'latex-support': 'LaTeX & Mathematical Typography'
            };
            if (tools[toolType]) {
                alert(`‚úçÔ∏è ${tools[toolType]}\n\nAdvanced academic writing support would be available here!`);
            }
        };
        
        window.startResearchProject = function(area) {
            const areas = {
                'pure-math': 'Pure Mathematics Research',
                'applied-math': 'Applied Mathematics',
                'computational': 'Computational Mathematics',
                'interdisciplinary': 'Interdisciplinary Research'
            };
            if (areas[area]) {
                alert(`üî¨ ${areas[area]}\n\nAdvanced research project support would be available here!`);
            }
        };
    </script>
</body>
</html>
</html>
